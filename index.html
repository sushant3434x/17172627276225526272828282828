<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gym Management Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <!-- Firebase SDKs (Modular) -->
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"></script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(to bottom right, #1a202c, #2d3748);
        color: #e2e8f0;
        overflow-x: hidden;
      }
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #4a5568;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb {
        background: #a0aec0;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #cbd5e0;
        cursor: pointer;
      }
      .member-photo {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 50%;
        border: 1px solid #4a5568;
      }
      .id-card-photo {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 12px;
        border: 2px solid #a0aec0;
      }
      .hidden {
        display: none !important;
      }
      .line-through-name {
        text-decoration: line-through;
      }
      .tab-content, .modal-content {
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
      }
      .modal-content.hidden {
        opacity: 0;
        transform: translateY(-20px);
      }
      .modal-content.visible {
        opacity: 1;
        transform: translateY(0);
      }
      .member-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      }
      .member-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      }
      .hamburger-menu {
        transition: transform 0.3s ease-in-out;
      }
      .hamburger-menu.open {
        transform: translateX(0);
      }
      .hamburger-menu.closed {
        transform: translateX(-100%);
      }
    </style>
  </head>
  <body class="min-h-screen p-6 flex flex-col items-center justify-center">
    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 bg-black flex items-center justify-center z-50 text-white text-4xl font-bold">Made by SUSHANT SINGH</div>
    
    <!-- Message Display -->
    <div class="fixed top-6 right-6 p-4 rounded-lg shadow-lg text-white z-50 transition-all duration-300 ease-in-out hidden" id="message-display"></div>
    
    <!-- Password Entry Modal -->
    <div class="fixed inset-0 flex items-center justify-center z-50 hidden" id="password-entry-modal" style="background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px);">
      <div class="bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-sm border border-gray-700">
        <h2 class="text-3xl font-bold text-white mb-6 text-center text-lg">Enter App Password</h2>
        <input class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white placeholder-gray-400 text-center text-xl mb-3" id="app-password-input" maxlength="4" placeholder="••••" type="password" />
        <button class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out text-lg mt-6 mb-3" id="submit-app-password">
          Unlock App
        </button>
      </div>
    </div>
    
    <!-- Main Gym App Section -->
    <div class="bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-2xl mb-8 hidden transform scale-95 opacity-0 transition-all duration-500 ease-out border border-gray-700" id="main-app-section">
      <!-- Header with Hamburger and Search -->
      <div class="flex justify-between items-center mb-6">
        <button id="menu-toggle" class="p-2 rounded-lg hover:bg-gray-700 transition duration-150 ease-in-out">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
        <h1 class="text-4xl font-extrabold text-white">Gym Dashboard</h1>
        <button id="search-toggle" class="p-2 rounded-lg hover:bg-gray-700 transition duration-150 ease-in-out">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </button>
      </div>

      <!-- Dashboard Stats -->
      <div id="dashboard-view" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="bg-gray-700 p-6 rounded-xl shadow border border-gray-600">
            <h3 class="text-gray-400 text-sm font-medium">Total Members</h3>
            <p class="text-white text-4xl font-bold mt-2" id="total-members-count">0</p>
          </div>
          <div class="bg-gray-700 p-6 rounded-xl shadow border border-gray-600">
            <h3 class="text-gray-400 text-sm font-medium">Active Members</h3>
            <p class="text-green-400 text-4xl font-bold mt-2" id="active-members-count">0</p>
          </div>
          <div class="bg-gray-700 p-6 rounded-xl shadow border border-gray-600">
            <h3 class="text-gray-400 text-sm font-medium">Inactive Members</h3>
            <p class="text-yellow-400 text-4xl font-bold mt-2" id="inactive-members-count">0</p>
          </div>
          <div class="bg-gray-700 p-6 rounded-xl shadow border border-gray-600">
            <h3 class="text-gray-400 text-sm font-medium">Overdue Members</h3>
            <p class="text-red-400 text-4xl font-bold mt-2" id="overdue-members-count">0</p>
          </div>
        </div>
        <!-- Collapsible Member Lists -->
        <div class="w-full mt-6 bg-gray-700 p-6 rounded-xl shadow-inner border border-gray-600" id="collapsible-members">
            <h2 class="text-2xl font-bold text-white mb-4">Current Members</h2>
            <div class="space-y-4" id="members-list">
              <p class="text-gray-400 text-center">No active members found.</p>
            </div>
        </div>
        <div class="w-full mt-6 bg-gray-700 p-6 rounded-xl shadow-inner border border-gray-600" id="collapsible-inactive-members">
            <h2 class="text-2xl font-bold text-white mb-4">Inactive Members</h2>
            <div class="space-y-4" id="inactive-members-list">
              <p class="text-gray-400 text-center">No inactive members found.</p>
            </div>
        </div>
      </div>

      <!-- Content Views (Initially Hidden) -->
      <div id="content-views" class="space-y-6 hidden">
        <button id="back-to-dashboard" class="py-2 px-4 bg-gray-700 rounded-lg hover:bg-gray-600 text-white font-semibold mb-4">
            ← Back to Dashboard
        </button>
        <!-- Tab Content: Manage Member Details (Existing Form) -->
        <div class="tab-content bg-gray-700 p-6 rounded-xl shadow-inner hidden border border-gray-600" id="content-manage-member">
          <h2 class="text-2xl font-bold text-white mb-6 text-lg">Manage Member Details</h2>
          <form class="grid grid-cols-1 md:grid-cols-2 gap-6" id="member-form">
            <div>
              <label class="block text-sm font-medium text-gray-300" for="member-id">Member ID</label>
              <input class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white placeholder-gray-400 mb-3" id="member-id" placeholder="Enter Member ID" type="text" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300" for="full-name">Full Name</label>
              <input class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white placeholder-gray-400 mb-3" id="full-name" placeholder="John Doe" type="text" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300" for="gender">Gender</label>
              <select class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white mb-3" id="gender">
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300" for="phone-number">Phone Number</label>
              <input class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white placeholder-gray-400 mb-3" id="phone-number" placeholder="9876543210" type="tel" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300" for="member-photo">Member Photo URL</label>
              <input class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white placeholder-gray-400 mb-3" id="member-photo" placeholder="https://example.com/photo.jpg" type="url" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300" for="join-date">Join Date</label>
              <input class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white mb-3" id="join-date" type="date" />
            </div>
            <div class="col-span-1 md:col-span-2">
              <label class="block text-sm font-medium text-gray-300" for="member-status">Membership Status</label>
              <select class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white mb-3" id="member-status">
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
                <option value="Suspended">Suspended</option>
              </select>
            </div>
            <div class="col-span-1 md:col-span-2 flex flex-col space-y-4 pt-4">
              <button class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out text-lg mb-3" id="save-button">
                <span id="save-button-text">Add Member</span>
              </button>
              <button class="w-full py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-150 ease-in-out text-lg hidden mb-3" id="delete-button">
                Delete Member
              </button>
              <button class="w-full py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-150 ease-in-out text-lg mb-3" id="reset-button">
                Reset Form
              </button>
            </div>
          </form>
        </div>
        <!-- Tab Content: Add Payment -->
        <div class="tab-content bg-gray-700 p-6 rounded-xl shadow-inner hidden border border-gray-600" id="content-add-payment">
          <h2 class="text-2xl font-bold text-white mb-6 text-lg">Add Payment</h2>
          <div class="space-y-4">
            <input class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white placeholder-gray-400" id="payment-member-id" placeholder="Member ID" type="text" />
            <input class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white placeholder-gray-400" id="payment-amount" placeholder="Amount" type="number" />
            <select class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white" id="payment-type">
              <option value="monthly">Monthly</option>
              <option value="quarterly">Quarterly</option>
              <option value="half-yearly">Half-Yearly</option>
              <option value="yearly">Yearly</option>
            </select>
            <input class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white" id="payment-date" type="date" />
            <button class="w-full py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out text-lg mb-3" id="save-payment">
              Add Payment
            </button>
          </div>
        </div>
        <!-- Tab Content: ID Card View -->
        <div class="tab-content bg-gray-700 p-6 rounded-xl shadow-inner hidden border border-gray-600" id="content-id-card">
          <h2 class="text-2xl font-bold text-white mb-6 text-lg">ID Card View</h2>
          <div class="flex flex-col items-center space-y-4">
            <input class="w-full p-3 rounded-lg bg-gray-800 text-white placeholder-gray-400 border border-gray-600" id="id-card-search-input" placeholder="Search by Member ID or Name" type="text" />
            <div class="w-full bg-gray-800 p-6 rounded-lg shadow-inner flex flex-col items-center border border-gray-600" id="id-card-display">
              <p class="text-gray-400 text-center">Search for a member to view their ID card.</p>
            </div>
          </div>
        </div>
        <!-- Tab Content: Cloud Config & Storage -->
        <div class="tab-content bg-gray-700 p-6 rounded-xl shadow-inner hidden border border-gray-600" id="content-add-storage">
          <h2 class="text-2xl font-bold text-white mb-6 text-lg">Cloud Config & Storage</h2>
          <p class="text-gray-300">This section allows you to configure and manage cloud storage settings for your gym data.</p>
          <div class="space-y-4 mt-6">
            <label class="block text-sm font-medium text-gray-300">Firebase Config (read-only)</label>
            <textarea class="w-full p-3 rounded-lg bg-gray-800 text-gray-400 border border-gray-600" id="firebase-config-display" rows="4" readonly></textarea>
            <label class="block text-sm font-medium text-gray-300">App ID (read-only)</label>
            <input class="w-full p-3 rounded-lg bg-gray-800 text-gray-400 border border-gray-600" id="app-id-display" type="text" readonly />
          </div>
        </div>
        <div class="text-sm text-gray-400 text-center bg-gray-700 p-3 rounded-lg border border-gray-600" id="user-id-display">
          Your User ID: <span class="font-mono text-gray-200 font-semibold" id="user-id-value"></span>
        </div>
      </div>
    </div>

    <!-- Hamburger Menu Sidebar -->
    <div id="sidebar-menu" class="fixed top-0 left-0 h-full w-64 bg-gray-900 shadow-xl z-40 p-6 closed hamburger-menu">
      <div class="flex justify-end mb-8">
        <button id="close-menu" class="text-gray-400 hover:text-white transition duration-150 ease-in-out">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <nav class="space-y-4">
        <button class="w-full text-left py-3 px-4 rounded-lg hover:bg-gray-800 transition duration-150 ease-in-out" data-view="dashboard">Dashboard</button>
        <button class="w-full text-left py-3 px-4 rounded-lg hover:bg-gray-800 transition duration-150 ease-in-out" data-view="manage-member">Manage Member Details</button>
        <button class="w-full text-left py-3 px-4 rounded-lg hover:bg-gray-800 transition duration-150 ease-in-out" data-view="add-payment">Add Payment</button>
        <button class="w-full text-left py-3 px-4 rounded-lg hover:bg-gray-800 transition duration-150 ease-in-out" data-view="id-card">ID Card View</button>
        <button class="w-full text-left py-3 px-4 rounded-lg hover:bg-gray-800 transition duration-150 ease-in-out" data-view="add-storage">Cloud Storage</button>
      </nav>
      <button class="w-full py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-150 ease-in-out text-lg mt-8" id="signout-button">
        Sign Out
      </button>
    </div>

    <!-- Search Modal -->
    <div id="search-modal" class="fixed inset-0 flex items-start justify-center p-4 z-50 hidden" style="background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px);">
      <div class="bg-gray-800 p-6 rounded-2xl shadow-xl w-full max-w-lg mt-12">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-white">Search Members</h2>
          <button id="close-search" class="text-gray-400 hover:text-white transition duration-150 ease-in-out">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <input class="w-full p-3 mb-4 rounded-lg bg-gray-700 text-white placeholder-gray-400 border border-gray-600" id="search-member-input" placeholder="Search by Member ID or Name" type="text" />
        <div class="space-y-4 max-h-96 overflow-y-auto" id="search-results">
          <p class="text-gray-400 text-center">Start typing to search for members...</p>
        </div>
      </div>
    </div>
    
    <!-- Photo View Modal -->
    <div class="fixed inset-0 flex items-center justify-center z-50 hidden" id="photo-view-modal" style="background-color: rgba(0, 0, 0, 0.9); backdrop-filter: blur(12px);">
      <div class="bg-gray-900 p-4 rounded-2xl shadow-xl border border-gray-700">
        <img class="max-w-xs max-h-xs sm:max-w-sm sm:max-h-sm md:max-w-md md:max-h-md lg:max-w-lg lg:max-h-lg w-full h-auto rounded-lg" id="modal-photo" />
        <p class="mt-4 text-center text-white text-lg font-bold" id="modal-photo-name"></p>
        <button class="mt-4 w-full py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-150 ease-in-out" id="close-photo-modal">
          Close
        </button>
      </div>
    </div>
    
    <!-- Message Prompt Box -->
    <div id="prompt-box" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-gray-900 p-6 rounded-lg shadow-2xl text-white text-center z-50 hidden"></div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
      import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
      import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

      // --- Global variables for the Canvas environment ---
      const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

      let app;
      let db;
      let auth;
      let userId;
      let isAuthReady = false;

      // --- UI Elements ---
      const splashScreen = document.getElementById('splash-screen');
      const passwordModal = document.getElementById('password-entry-modal');
      const passwordInput = document.getElementById('app-password-input');
      const submitPasswordBtn = document.getElementById('submit-app-password');
      const mainAppSection = document.getElementById('main-app-section');
      const userIdDisplay = document.getElementById('user-id-value');
      const signOutButton = document.getElementById('signout-button');
      const memberForm = document.getElementById('member-form');
      const memberIdInput = document.getElementById('member-id');
      const fullNameInput = document.getElementById('full-name');
      const genderSelect = document.getElementById('gender');
      const phoneNumberInput = document.getElementById('phone-number');
      const memberPhotoInput = document.getElementById('member-photo');
      const joinDateInput = document.getElementById('join-date');
      const memberStatusSelect = document.getElementById('member-status');
      const saveButton = document.getElementById('save-button');
      const deleteButton = document.getElementById('delete-button');
      const resetButton = document.getElementById('reset-button');
      const membersListContainer = document.getElementById('members-list');
      const inactiveMembersListContainer = document.getElementById('inactive-members-list');
      const searchMemberInput = document.getElementById('search-member-input');
      const searchResultsDiv = document.getElementById('search-results');
      const paymentMemberIdInput = document.getElementById('payment-member-id');
      const paymentAmountInput = document.getElementById('payment-amount');
      const paymentTypeSelect = document.getElementById('payment-type');
      const paymentDateInput = document.getElementById('payment-date');
      const savePaymentButton = document.getElementById('save-payment');
      const idCardSearchInput = document.getElementById('id-card-search-input');
      const idCardDisplay = document.getElementById('id-card-display');
      const photoViewModal = document.getElementById('photo-view-modal');
      const modalPhoto = document.getElementById('modal-photo');
      const modalPhotoName = document.getElementById('modal-photo-name');
      const closePhotoModalBtn = document.getElementById('close-photo-modal');
      const messageDisplay = document.getElementById('message-display');
      const firebaseConfigDisplay = document.getElementById('firebase-config-display');
      const appIdDisplay = document.getElementById('app-id-display');
      const promptBox = document.getElementById('prompt-box');

      const dashboardView = document.getElementById('dashboard-view');
      const contentViewsContainer = document.getElementById('content-views');
      const backToDashboardBtn = document.getElementById('back-to-dashboard');

      const menuToggleBtn = document.getElementById('menu-toggle');
      const searchToggleBtn = document.getElementById('search-toggle');
      const sidebarMenu = document.getElementById('sidebar-menu');
      const closeMenuBtn = document.getElementById('close-menu');
      const searchModal = document.getElementById('search-modal');
      const closeSearchBtn = document.getElementById('close-search');

      // --- Dashboard Stats Elements ---
      const totalMembersCount = document.getElementById('total-members-count');
      const activeMembersCount = document.getElementById('active-members-count');
      const inactiveMembersCount = document.getElementById('inactive-members-count');
      const overdueMembersCount = document.getElementById('overdue-members-count');

      // --- View Management ---
      function showView(viewId) {
          dashboardView.classList.add('hidden');
          contentViewsContainer.classList.add('hidden');
          document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));

          if (viewId === 'dashboard') {
              dashboardView.classList.remove('hidden');
              contentViewsContainer.classList.add('hidden');
          } else {
              contentViewsContainer.classList.remove('hidden');
              document.getElementById(`content-${viewId}`).classList.remove('hidden');
          }
      }

      // --- Auth and Init ---
      async function initFirebase() {
        try {
          if (firebase.apps.length === 0) {
            app = initializeApp(firebaseConfig);
          } else {
            app = firebase.app();
          }
          auth = getAuth(app);
          db = getFirestore(app);

          onAuthStateChanged(auth, async (user) => {
            if (user) {
              userId = user.uid;
              isAuthReady = true;
              setupRealtimeListeners();
              
              passwordModal.classList.add('hidden');
              mainAppSection.classList.remove('hidden');
              mainAppSection.classList.remove('opacity-0', 'scale-95');
              
              userIdDisplay.textContent = userId;
              appIdDisplay.value = appId;
              firebaseConfigDisplay.value = JSON.stringify(firebaseConfig, null, 2);
            } else {
              userId = null;
              isAuthReady = true;
              passwordModal.classList.remove('hidden');
            }
          });

          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          } else {
            await signInAnonymously(auth);
          }

        } catch (error) {
          console.error("Error initializing Firebase:", error);
          showMessage(`Error initializing Firebase: ${error.message}`, 'error');
        }
      }

      // --- Authentication Logic (Password Check) ---
      submitPasswordBtn.addEventListener('click', () => {
        const enteredPassword = passwordInput.value;
        if (enteredPassword === '2003') {
          passwordModal.classList.add('hidden');
          mainAppSection.classList.remove('hidden');
          mainAppSection.classList.remove('opacity-0', 'scale-95');
        } else {
          showMessage('Incorrect password. Please try again.', 'error');
        }
      });
      passwordInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          submitPasswordBtn.click();
        }
      });

      // --- Sign Out ---
      signOutButton.addEventListener('click', async () => {
        try {
          await signOut(auth);
          mainAppSection.classList.add('hidden');
          passwordModal.classList.remove('hidden');
          showMessage('Signed out successfully.', 'success');
        } catch (error) {
          console.error('Sign out error:', error);
          showMessage(`Sign out failed: ${error.message}`, 'error');
        }
      });

      // --- CRUD Operations & Data Display ---
      async function saveMember(memberData, docId = null) {
        if (!isAuthReady) return showMessage('Authentication not ready.', 'error');
        const memberCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'members');
        try {
          if (docId) {
            const memberDocRef = doc(memberCollectionRef, docId);
            await setDoc(memberDocRef, memberData);
          } else {
            await addDoc(memberCollectionRef, memberData);
          }
          showMessage('Member saved successfully!', 'success');
          memberForm.reset();
        } catch (e) {
          console.error("Error saving member: ", e);
          showMessage('Error saving member.', 'error');
        }
      }

      async function deleteMember(docId) {
        if (!isAuthReady) return showMessage('Authentication not ready.', 'error');
        promptBox.innerHTML = `
          <p class="text-lg mb-4">Are you sure you want to delete this member?</p>
          <div class="flex justify-center space-x-4">
            <button id="prompt-ok" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Yes, Delete</button>
            <button id="prompt-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
          </div>
        `;
        promptBox.classList.remove('hidden');
        document.getElementById('prompt-ok').onclick = async () => {
          promptBox.classList.add('hidden');
          try {
            const memberDocRef = doc(db, 'artifacts', appId, 'users', userId, 'members', docId);
            await deleteDoc(memberDocRef);
            showMessage('Member deleted successfully!', 'success');
            memberForm.reset();
            saveButton.textContent = 'Add Member';
            deleteButton.classList.add('hidden');
          } catch (e) {
            console.error("Error deleting member: ", e);
            showMessage('Error deleting member.', 'error');
          }
        };
        document.getElementById('prompt-cancel').onclick = () => {
          promptBox.classList.add('hidden');
        };
      }

      async function markAsInactive(docId) {
        if (!isAuthReady) return showMessage('Authentication not ready.', 'error');
        try {
          const memberDocRef = doc(db, 'artifacts', appId, 'users', userId, 'members', docId);
          await updateDoc(memberDocRef, { status: 'Inactive' });
          showMessage('Member marked as inactive.', 'success');
        } catch (e) {
          console.error("Error marking member as inactive: ", e);
          showMessage('Error marking member as inactive.', 'error');
        }
      }

      function renderDashboard(allMembers) {
          const activeMembers = allMembers.filter(member => member.status === 'Active');
          const inactiveMembers = allMembers.filter(member => member.status === 'Inactive' || member.status === 'Suspended');
          const overdueMembers = allMembers.filter(member => {
            if (member.status === 'Active' && member.dueDate) {
              return new Date(member.dueDate) < new Date();
            }
            return false;
          });

          totalMembersCount.textContent = allMembers.length;
          activeMembersCount.textContent = activeMembers.length;
          inactiveMembersCount.textContent = inactiveMembers.length;
          overdueMembersCount.textContent = overdueMembers.length;

          renderMembersList(membersListContainer, activeMembers, 'active');
          renderMembersList(inactiveMembersListContainer, inactiveMembers, 'inactive');
      }

      function renderMembersList(container, members, type) {
        container.innerHTML = '';
        if (members.length === 0) {
          container.innerHTML = `<p class="text-gray-400 text-center">No ${type} members found.</p>`;
        }
        members.forEach(member => {
          const memberDiv = document.createElement('div');
          memberDiv.className = 'member-card bg-gray-800 p-4 rounded-lg shadow flex justify-between items-center space-x-4 border border-gray-600';
          memberDiv.dataset.id = member.id;
          
          let actionButton = '';
          if (type === 'active') {
            actionButton = `<button class="inactive-btn text-yellow-400 hover:text-yellow-500 font-semibold text-xl">💤</button>`;
          } else {
            actionButton = `<button class="activate-btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-lg text-sm">Activate</button>`;
          }
          
          memberDiv.innerHTML = `
            <div class="flex items-center space-x-3">
              <img src="${member.photoUrl || 'https://placehold.co/40x40/4a5568/a0aec0?text=P'}" onerror="this.src='https://placehold.co/40x40/4a5568/a0aec0?text=P';" alt="Member Photo" class="member-photo">
              <div>
                <p class="text-white font-medium ${type === 'inactive' ? 'line-through-name' : ''}">${member.fullName}</p>
                <p class="text-gray-400 text-sm">ID: ${member.memberId}</p>
                <p class="text-gray-400 text-sm">Status: ${member.status}</p>
              </div>
            </div>
            <div class="flex space-x-2">
              ${actionButton}
              <button class="edit-btn text-blue-400 hover:text-blue-500 font-semibold text-sm">Edit</button>
            </div>
          `;
          memberDiv.querySelector('.edit-btn').addEventListener('click', () => {
            fillFormForEdit(member.id);
          });
          if (type === 'active') {
            memberDiv.querySelector('.inactive-btn').addEventListener('click', () => {
              markAsInactive(member.id);
            });
          } else {
            memberDiv.querySelector('.activate-btn').addEventListener('click', () => {
              promptForPaymentAndActivate(member.id);
            });
          }
          container.appendChild(memberDiv);
        });
      }

      async function promptForPaymentAndActivate(docId) {
        promptBox.innerHTML = `
          <p class="text-lg mb-4">Select payment type to reactivate:</p>
          <select id="payment-prompt-select" class="w-full p-3 mb-4 bg-gray-800 text-white rounded-lg border border-gray-600">
            <option value="monthly">Monthly</option>
            <option value="quarterly">Quarterly</option>
            <option value="half-yearly">Half-Yearly</option>
            <option value="yearly">Yearly</option>
          </select>
          <div class="flex justify-center space-x-4">
            <button id="prompt-ok" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">OK</button>
            <button id="prompt-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
          </div>
        `;
        promptBox.classList.remove('hidden');

        document.getElementById('prompt-ok').onclick = async () => {
          const paymentType = document.getElementById('payment-prompt-select').value;
          promptBox.classList.add('hidden');
          try {
            const memberDocRef = doc(db, 'artifacts', appId, 'users', userId, 'members', docId);
            await updateDoc(memberDocRef, {
              status: 'Active',
              dueDate: calculateDueDate(paymentType)
            });
            const paymentsColRef = collection(db, 'artifacts', appId, 'users', userId, 'payments');
            await addDoc(paymentsColRef, {
              memberId: memberDocRef.id,
              amount: 0,
              paymentType: paymentType,
              paymentDate: new Date().toISOString().slice(0, 10),
              timestamp: new Date().toISOString()
            });
            showMessage('Member activated successfully!', 'success');
          } catch (e) {
            console.error("Error activating member: ", e);
            showMessage('Error activating member.', 'error');
          }
        };
        document.getElementById('prompt-cancel').onclick = () => {
          promptBox.classList.add('hidden');
        };
      }

      function calculateDueDate(paymentType) {
        const date = new Date();
        switch (paymentType) {
          case 'monthly':
            date.setMonth(date.getMonth() + 1);
            break;
          case 'quarterly':
            date.setMonth(date.getMonth() + 3);
            break;
          case 'half-yearly':
            date.setMonth(date.getMonth() + 6);
            break;
          case 'yearly':
            date.setFullYear(date.getFullYear() + 1);
            break;
        }
        return date.toISOString().slice(0, 10);
      }

      function setupRealtimeListeners() {
        if (!isAuthReady || !userId) return;
        const membersColRef = collection(db, 'artifacts', appId, 'users', userId, 'members');
        onSnapshot(membersColRef, (snapshot) => {
          const allMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          renderDashboard(allMembers);
        }, (error) => {
            console.error("Error fetching members:", error);
            showMessage("Error fetching members. Please try again.", 'error');
        });
      }

      // --- Form and Button Handlers ---
      memberForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const docId = saveButton.dataset.docId || null;
        const memberData = {
          memberId: memberIdInput.value,
          fullName: fullNameInput.value,
          gender: genderSelect.value,
          phoneNumber: phoneNumberInput.value,
          photoUrl: memberPhotoInput.value,
          joinDate: joinDateInput.value,
          status: memberStatusSelect.value,
          createdAt: new Date().toISOString(),
          dueDate: memberStatusSelect.value === 'Active' ? calculateDueDate('monthly') : null
        };
        await saveMember(memberData, docId);
      });

      resetButton.addEventListener('click', () => {
        memberForm.reset();
        saveButton.textContent = 'Add Member';
        deleteButton.classList.add('hidden');
        delete saveButton.dataset.docId;
      });

      deleteButton.addEventListener('click', async () => {
        const docId = deleteButton.dataset.docId;
        if (docId) {
          await deleteMember(docId);
        }
      });

      async function fillFormForEdit(docId) {
        const memberDocRef = doc(db, 'artifacts', appId, 'users', userId, 'members', docId);
        const docSnap = await getDoc(memberDocRef);
        if (docSnap.exists()) {
          const memberData = docSnap.data();
          memberIdInput.value = memberData.memberId;
          fullNameInput.value = memberData.fullName;
          genderSelect.value = memberData.gender;
          phoneNumberInput.value = memberData.phoneNumber;
          memberPhotoInput.value = memberData.photoUrl;
          joinDateInput.value = memberData.joinDate;
          memberStatusSelect.value = memberData.status;
          saveButton.textContent = 'Update Member';
          saveButton.dataset.docId = docId;
          deleteButton.classList.remove('hidden');
          showView('manage-member');
        } else {
          showMessage('Member not found.', 'error');
        }
      }

      // --- Payment Logic ---
      savePaymentButton.addEventListener('click', async () => {
        const memberId = paymentMemberIdInput.value;
        const amount = parseFloat(paymentAmountInput.value);
        const paymentType = paymentTypeSelect.value;
        const paymentDate = paymentDateInput.value;

        if (!memberId || !amount || !paymentDate) {
          showMessage('Please fill out all payment fields.', 'error');
          return;
        }

        try {
          const membersColRef = collection(db, 'artifacts', appId, 'users', userId, 'members');
          const q = query(membersColRef, where('memberId', '==', memberId));
          const querySnapshot = await getDocs(q);

          if (querySnapshot.empty) {
            showMessage('Member not found with this ID.', 'error');
            return;
          }

          const memberDoc = querySnapshot.docs[0];
          const memberDocRef = memberDoc.ref;
          
          await updateDoc(memberDocRef, {
            status: 'Active',
            dueDate: calculateDueDate(paymentType)
          });

          const paymentsColRef = collection(db, 'artifacts', appId, 'users', userId, 'payments');
          await addDoc(paymentsColRef, {
            memberDocId: memberDoc.id,
            memberId,
            amount,
            paymentType,
            paymentDate,
            timestamp: new Date().toISOString()
          });

          showMessage('Payment added successfully!', 'success');
          paymentMemberIdInput.value = '';
          paymentAmountInput.value = '';
          paymentDateInput.value = '';
        } catch (e) {
          console.error("Error adding payment: ", e);
          showMessage('Error adding payment.', 'error');
        }
      });

      // --- ID Card View Logic ---
      idCardSearchInput.addEventListener('input', async (e) => {
        const queryText = e.target.value.toLowerCase();
        idCardDisplay.innerHTML = '<p class="text-gray-400 text-center">Searching...</p>';
        if (queryText.length > 0) {
          const membersColRef = collection(db, 'artifacts', appId, 'users', userId, 'members');
          const membersSnapshot = await getDocs(membersColRef);
          const membersList = membersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          const member = membersList.find(member =>
            (member.memberId && member.memberId.toLowerCase().includes(queryText)) || (member.fullName && member.fullName.toLowerCase().includes(queryText))
          );
          renderIdCard(member);
        } else {
          idCardDisplay.innerHTML = '<p class="text-gray-400 text-center">Search for a member to view their ID card.</p>';
        }
      });

      function renderIdCard(member) {
        if (!member) {
          idCardDisplay.innerHTML = '<p class="text-gray-400 text-center">Member not found.</p>';
          return;
        }
        const formattedJoinDate = member.joinDate ? new Date(member.joinDate).toLocaleDateString() : 'N/A';
        const photoUrl = member.photoUrl || 'https://placehold.co/120x120/4a5568/a0aec0?text=NO+PHOTO';
        idCardDisplay.innerHTML = `
          <div class="bg-gradient-to-br from-indigo-700 to-blue-500 p-8 rounded-xl shadow-lg w-full max-w-sm text-white relative">
            <div class="absolute top-4 right-4 text-sm font-bold opacity-30">ID: ${member.memberId}</div>
            <div class="flex items-center space-x-6">
              <img src="${photoUrl}" onerror="this.src='https://placehold.co/120x120/4a5568/a0aec0?text=NO+PHOTO';" alt="Member Photo" class="id-card-photo">
              <div>
                <h3 class="text-2xl font-bold">${member.fullName}</h3>
                <p class="text-gray-200">Status: ${member.status}</p>
                <p class="text-gray-300 text-sm">Joined: ${formattedJoinDate}</p>
              </div>
            </div>
            <div class="mt-6 text-sm text-gray-200">
              <p><strong>Phone:</strong> ${member.phoneNumber}</p>
              <p><strong>Gender:</strong> ${member.gender}</p>
            </div>
            <div class="mt-4 border-t border-gray-400 pt-2 text-xs text-center">
              <p>AlphaCore Fitness</p>
            </div>
          </div>
          <button class="mt-4 w-full py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 ease-in-out" onclick="openPhotoModal('${member.photoUrl}', '${member.fullName}')">
            View Photo
          </button>
        `;
      }

      function openPhotoModal(photoUrl, name) {
        modalPhoto.src = photoUrl || 'https://placehold.co/400x400/4a5568/a0aec0?text=NO+PHOTO';
        modalPhoto.onerror = () => modalPhoto.src = 'https://placehold.co/400x400/4a5568/a0aec0?text=NO+PHOTO';
        modalPhotoName.textContent = name;
        photoViewModal.classList.remove('hidden');
      }

      closePhotoModalBtn.addEventListener('click', () => {
        photoViewModal.classList.add('hidden');
      });

      // --- UI/UX Helpers ---
      function showMessage(message, type = 'info') {
        messageDisplay.textContent = message;
        messageDisplay.className = `fixed top-6 right-6 p-4 rounded-lg shadow-lg text-white z-50 transition-all duration-300 ease-in-out block`;
        if (type === 'success') {
          messageDisplay.style.backgroundColor = '#10B981';
        } else if (type === 'error') {
          messageDisplay.style.backgroundColor = '#EF4444';
        } else {
          messageDisplay.style.backgroundColor = '#3B82F6';
        }
        setTimeout(() => {
          messageDisplay.classList.remove('block');
          messageDisplay.classList.add('hidden');
        }, 3000);
      }
      
      // --- Hamburger Menu & Search Modal Logic ---
      menuToggleBtn.addEventListener('click', () => {
        sidebarMenu.classList.remove('closed');
        sidebarMenu.classList.add('open');
      });
      closeMenuBtn.addEventListener('click', () => {
        sidebarMenu.classList.remove('open');
        sidebarMenu.classList.add('closed');
      });
      document.querySelectorAll('#sidebar-menu button').forEach(button => {
        button.addEventListener('click', () => {
          const view = button.dataset.view;
          if (view) {
            showView(view);
            closeMenuBtn.click();
          }
        });
      });
      backToDashboardBtn.addEventListener('click', () => {
        showView('dashboard');
      });
      searchToggleBtn.addEventListener('click', () => {
        searchModal.classList.remove('hidden');
      });
      closeSearchBtn.addEventListener('click', () => {
        searchModal.classList.add('hidden');
      });
      
      searchMemberInput.addEventListener('input', async (e) => {
        const queryText = e.target.value.toLowerCase();
        searchResultsDiv.innerHTML = '<p class="text-gray-400 text-center">Searching...</p>';
        const membersColRef = collection(db, 'artifacts', appId, 'users', userId, 'members');
        const membersSnapshot = await getDocs(membersColRef);
        const allMembersList = membersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const filteredMembers = allMembersList.filter(member =>
          (member.memberId && member.memberId.toLowerCase().includes(queryText)) ||
          (member.fullName && member.fullName.toLowerCase().includes(queryText))
        );
        
        renderSearchResults(filteredMembers);
      });

      function renderSearchResults(results) {
        searchResultsDiv.innerHTML = '';
        if (results.length === 0) {
          searchResultsDiv.innerHTML = '<p class="text-gray-400 text-center">No matching members found.</p>';
          return;
        }
        results.forEach(member => {
          const resultDiv = document.createElement('div');
          resultDiv.className = 'bg-gray-700 p-4 rounded-lg shadow-sm flex justify-between items-center cursor-pointer hover:bg-gray-600 transition duration-150 ease-in-out border border-gray-600';
          resultDiv.innerHTML = `
            <div class="flex items-center space-x-3">
              <img src="${member.photoUrl || 'https://placehold.co/40x40/4a5568/a0aec0?text=P'}" onerror="this.src='https://placehold.co/40x40/4a5568/a0aec0?text=P';" alt="Member Photo" class="member-photo">
              <div>
                <p class="text-white font-medium">${member.fullName}</p>
                <p class="text-gray-400 text-sm">ID: ${member.memberId}</p>
              </div>
            </div>
          `;
          resultDiv.addEventListener('click', () => {
            paymentMemberIdInput.value = member.memberId;
            showView('add-payment');
            searchModal.classList.add('hidden');
          });
          searchResultsDiv.appendChild(resultDiv);
        });
      }

      window.openPhotoModal = openPhotoModal;
      window.onload = function () {
        setTimeout(() => {
          splashScreen.classList.add('hidden');
          initFirebase();
        }, 2000);
      };
    </script>
  </body>
</html>
