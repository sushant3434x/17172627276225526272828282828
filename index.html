<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Gym Management Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
    <!-- Firebase SDKs -->
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #1a202c, #2d3748);
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #4a5568;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #a0aec0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #cbd5e0;
        }
        .member-photo {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 50%;
            border: 1px solid #4a5568;
        }
        /* ID Card Photo */
        .id-card-photo {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #6366f1;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .nav-link.active {
            background-color: #4a5568;
            border-left: 4px solid #6366f1;
            color: #e2e8f0;
        }
        #message-display.hidden {
            opacity: 0;
            transform: translateY(-20px);
        }
        #message-display.block {
            opacity: 1;
            transform: translateY(0);
        }
        .line-through-name {
            text-decoration: line-through;
        }
        #photo-view-modal {
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(12px);
            transition: opacity 0.3s ease-in-out;
        }
        #photo-view-modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #photo-view-modal.flex {
            opacity: 1;
            pointer-events: auto;
        }
        #photo-view-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        #photo-view-modal.hidden #photo-view-content {
            transform: scale(0.9);
            opacity: 0;
        }
        #photo-view-modal.flex #photo-view-content {
            transform: scale(1);
            opacity: 1;
        }
        /* Style for the password entry modal */
        #password-entry-modal {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            transition: opacity 0.3s ease-in-out;
        }
        #password-entry-modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #password-entry-modal.flex {
            opacity: 1;
            pointer-events: auto;
        }
        #password-entry-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        #password-entry-modal.hidden #password-entry-content {
            transform: translateY(-20px);
            opacity: 0;
        }
        #password-entry-modal.flex #password-entry-content {
            transform: translateY(0);
            opacity: 1;
        }
        /* Styles for the sliding sidebar */
        #sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        #sidebar.open {
            transform: translateX(0);
        }
        .backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="min-h-screen p-6 flex flex-col items-center justify-center text-base leading-relaxed">

<div class="fixed inset-0 bg-black flex items-center justify-center z-50 text-white text-4xl font-bold" id="splash-screen">Made with ‚ù§Ô∏è by SUSHANT SINGH</div>

<div class="fixed inset-0 flex items-center justify-center z-50 hidden" id="password-entry-modal">
    <div class="bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-sm border border-gray-700" id="password-entry-content">
        <h2 class="text-3xl font-bold text-white mb-6 text-center text-lg">Enter App Password</h2>
        <input class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white placeholder-gray-400 text-center text-xl mb-3" id="app-password-input" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" type="password"/>
        <button class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out text-lg mt-6 mb-3" id="submit-app-password">
            Unlock App
        </button>
    </div>
</div>

<div class="fixed top-6 right-6 p-4 rounded-lg shadow-lg text-white z-50 transition-all duration-300 ease-in-out hidden" id="message-display"></div>
<div class="fixed top-6 left-6 p-4 rounded-lg shadow-lg text-white z-50 transition-all duration-300 ease-in-out hidden" id="loading-spinner-modal">
    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <span>Loading...</span>
</div>

<!-- Sliding Sidebar Navigation -->
<div class="fixed inset-0 z-40 hidden backdrop" id="backdrop"></div>
<nav class="fixed top-0 left-0 w-64 h-full bg-gray-900 shadow-xl z-50 flex flex-col pt-6 transform -translate-x-full transition-transform duration-300 ease-in-out" id="sidebar">
    <div class="flex items-center justify-between p-4 mb-8">
        <h2 class="text-2xl font-bold text-white">Navigation</h2>
        <button class="text-gray-400 hover:text-white focus:outline-none" id="close-sidebar-btn">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
    </div>
    <div class="flex-1 overflow-y-auto">
 <a href="#" class="nav-link flex items-center p-4 text-gray-400 hover:bg-gray-700 hover:text-white transition" id="nav-home">üè† Home</a>
<a href="#" class="nav-link flex items-center p-4 text-gray-400 hover:bg-gray-700 hover:text-white transition" id="nav-manage-member">üë§ Manage Member</a>
<a href="#" class="nav-link flex items-center p-4 text-gray-400 hover:bg-gray-700 hover:text-white transition" id="nav-add-payment">üí≥ Add Payment</a>
<a href="#" class="nav-link flex items-center p-4 text-gray-400 hover:bg-gray-700 hover:text-white transition" id="nav-id-card">ü™™ ID Card View</a>
<a href="#" class="nav-link flex items-center p-4 text-gray-400 hover:bg-gray-700 hover:text-white transition" id="nav-inactive-member">üí§ Inactive Members</a>
            Home
        </a>
        <a href="#" class="nav-link flex items-center p-4 text-gray-400 hover:bg-gray-700 hover:text-white transition duration-150 ease-in-out" id="nav-manage-member">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" />
            </svg>
            Manage Member
        </a>
        <a href="#" class="nav-link flex items-center p-4 text-gray-400 hover:bg-gray-700 hover:text-white transition duration-150 ease-in-out" id="nav-add-payment">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" />
                <path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 12a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5 0a1 1 0 110 2h1a1 1 0 110-2H9z" clip-rule="evenodd" />
            </svg>
            Add Payment
        </a>
        <a href="#" class="nav-link flex items-center p-4 text-gray-400 hover:bg-gray-700 hover:text-white transition duration-150 ease-in-out" id="nav-id-card">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10 2a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V4a2 2 0 00-2-2h-2z" />
                <path fill-rule="evenodd" d="M4 14a2 2 0 012-2h8a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2z" clip-rule="evenodd" />
            </svg>
            ID Card View
        </a>
        <a href="#" class="nav-link flex items-center p-4 text-gray-400 hover:bg-gray-700 hover:text-white transition duration-150 ease-in-out" id="nav-inactive-member">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
            </svg>
            Inactive Members
        </a>
    </div>
</nav>

<div class="bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-2xl mb-8 hidden transform scale-95 opacity-0 transition-all duration-500 ease-out border border-gray-700" id="main-app-section">
    <div class="flex justify-between items-center mb-8">
        <button class="text-white focus:outline-none" id="hamburger-btn">
            <svg class="h-8 w-8 text-gray-400 hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"/>
            </svg>
        </button>
        <h1 class="text-4xl font-extrabold text-white text-lg">Gym Dashboard</h1>
        <div class="text-right text-gray-400 text-sm font-medium" id="datetime-display">
            <div class="text-xl font-semibold text-gray-200" id="current-time"></div>
            <div id="current-date"></div>
            <div id="current-day"></div>
        </div>
        <button class="px-5 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-150 ease-in-out w-full mb-3" id="signout-button">
            Sign Out
        </button>
    </div>
    <div class="text-sm text-gray-400 mb-6 text-center bg-gray-700 p-3 rounded-lg border border-gray-600" id="user-id-display">
        Your User ID: <span class="font-mono text-gray-200 font-semibold" id="user-id-value"></span>
    </div>

    <!-- Main Content Tabs -->
    <div class="tab-content" id="content-home">
     <h2 class="text-2xl font-bold text-white mb-6 text-lg">üè† Dashboard Overview</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-gray-700 p-6 rounded-xl shadow-lg border border-gray-600">
                <p class="text-gray-400 text-sm">Total Members</p>
                <p class="text-white text-3xl font-bold" id="total-members-count">0</p>
            </div>
            <div class="bg-gray-700 p-6 rounded-xl shadow-lg border border-gray-600">
                <p class="text-gray-400 text-sm">Active Members</p>
                <p class="text-green-400 text-3xl font-bold" id="total-active-members-count">0</p>
            </div>
            <div class="bg-gray-700 p-6 rounded-xl shadow-lg border border-gray-600">
                <p class="text-gray-400 text-sm">Overdue Members</p>
                <p class="text-red-400 text-3xl font-bold" id="overdue-members-count-summary">0</p>
            </div>
            <div class="bg-gray-700 p-6 rounded-xl shadow-lg border border-gray-600">
                <p class="text-gray-400 text-sm">Inactive Members</p>
                <p class="text-yellow-400 text-3xl font-bold" id="inactive-members-count-summary">0</p>
            </div>
        </div>

        <div class="mt-8 bg-gray-700 p-6 rounded-xl shadow-inner border border-gray-600">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-white">Overdue Members</h3>
                <span class="text-red-400 text-sm font-semibold" id="overdue-members-count-table">0 Overdue</span>
            </div>
            <div class="overflow-x-auto pr-2">
                <table class="min-w-full divide-y divide-gray-700 rounded-lg overflow-hidden">
                    <thead class="bg-gray-800 sticky top-0">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Photo</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">ID</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Name</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Phone</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Type</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Start Date</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Due Date</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Fee</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Days Overdue</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-gray-800 divide-y divide-gray-700" id="overdue-list">
                        <!-- Overdue member rows will be dynamically inserted here -->
                        <tr>
                            <td colspan="10" class="px-6 py-4 text-center text-gray-400">No overdue members found.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="tab-content bg-gray-700 p-6 rounded-xl shadow-inner hidden border border-gray-600" id="content-manage-member">
        <h2 class="text-2xl font-bold text-white mb-6 text-lg">üë§ Manage Member Details</h2>
        <form class="grid grid-cols-1 md:grid-cols-2 gap-6" id="member-form">
            <div>
                <label class="block text-sm font-medium text-gray-300" for="member-id">Member ID</label>
                <input class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white placeholder-gray-400 mb-3" id="member-id" name="memberId" placeholder="Unique Member ID" required="" type="text"/>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300" for="name">Member Name</label>
                <input class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white placeholder-gray-400 mb-3" id="name" name="name" placeholder="Full Name" required="" type="text"/>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300" for="phone-number">Phone Number</label>
                <input class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white placeholder-gray-400 mb-3" id="phone-number" name="phoneNumber" placeholder="e.g., 123-456-7890" type="tel"/>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300" for="membershipType">Membership Type</label>
                <select class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white mb-3" id="membershipType" name="membershipType" required="">
                    <option value="Monthly">Monthly</option>
                    <option value="Quarterly">Quarterly</option>
                    <option value="HalfYearly">Half Yearly</option>
                    <option value="Annual">Annual</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300" for="startDate">Start Date</label>
                <input class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white mb-3" id="startDate" name="startDate" required="" type="date"/>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300" for="dueDate">Calculated Due Date</label>
                <input class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm bg-gray-900 text-gray-400 cursor-not-allowed mb-3" id="dueDate" name="dueDate" readonly="" required="" type="date"/>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-300 mb-2">Member Photo</label>
                <div class="flex flex-wrap items-center gap-3 mb-4">
                    <input accept="image/*" class="hidden w-full mb-3" id="photo-upload" type="file"/>
                    <button class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-150 ease-in-out text-sm w-full mb-3" id="upload-photo-btn" type="button">
                        Upload Photo
                    </button>
                    <button class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out text-sm w-full mb-3" id="take-photo-btn" type="button">
                        Take Photo
                    </button>
                    <button class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out text-sm hidden w-full mb-3" id="switch-camera-btn" type="button">
                        Switch Camera
                    </button>
                    <button class="px-4 py-2 bg-gray-400 text-white font-semibold rounded-lg shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 transition duration-150 ease-in-out text-sm hidden w-full mb-3" id="clear-photo-btn" type="button">
                        Clear Photo
                    </button>
                </div>
                <div class="flex items-center space-x-4">
                    <img alt="Photo Preview" class="w-28 h-28 rounded-full object-cover border-2 border-gray-500 shadow-sm cursor-pointer" id="photo-preview" src="https://placehold.co/112x112/4a5568/cbd5e0?text=No+Photo"/>
                    <video autoplay="" class="w-28 h-28 rounded-full object-cover border-2 border-gray-500 shadow-sm hidden" id="camera-feed" playsinline=""></video>
                    <canvas class="hidden" id="camera-canvas"></canvas>
                </div>
                <a class="text-indigo-400 hover:underline mt-2 cursor-pointer hidden" id="view-photo-link" target="_blank">View Photo Preview</a>
                <p class="text-xs text-gray-400 mt-2">Note: Photos are uploaded to Firebase Storage. Deletion from app removes link, not image from storage.</p>
            </div>
            <div class="md:col-span-2 flex justify-end space-x-3 pt-4">
                <button class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out text-lg w-full mb-3" id="submit-button" type="submit">
                    Add Member
                </button>
                <button class="px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-150 ease-in-out text-lg hidden w-full mb-3" id="cancel-edit-button" type="button">
                    Cancel Edit
                </button>
            </div>
        </form>

        <div class="mt-8">
            <div class="flex items-center space-x-4 mb-4">
                <input class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white placeholder-gray-400 mb-3" id="member-search" placeholder="Search by ID or Name" type="text"/>
                <button class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out text-sm mb-3" id="clear-search-btn">
                    Clear
                </button>
            </div>
            <div class="flex items-center space-x-4 mb-4">
                <span class="text-gray-400 text-sm font-medium">Total Active Members: <span class="font-semibold text-gray-200" id="total-active-members-count-list">0</span></span>
                <button class="text-indigo-400 hover:text-indigo-200 transition duration-150 ease-in-out text-sm" id="toggle-members-btn">
                    Show Current Members
                </button>
            </div>
            <div class="overflow-x-auto overflow-y-auto max-h-96 pr-2 hidden" id="members-list-container">
                <table class="min-w-full divide-y divide-gray-700 rounded-lg overflow-hidden">
                    <thead class="bg-gray-700 sticky top-0">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Photo</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">ID</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Name</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Phone</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Type</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Start Date</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Due Date</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Fee</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Days Left</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-gray-800 divide-y divide-gray-700" id="members-list">
                        <!-- Member rows will be dynamically inserted here -->
                        <tr>
                            <td colspan="10" class="px-6 py-4 text-center text-gray-400">No active members found.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="tab-content bg-gray-700 p-6 rounded-xl shadow-inner hidden border border-gray-600" id="content-add-payment">
        <h2 class="text-2xl font-bold text-white mb-6 text-lg">üí≥ Add Payment</h2>
        <form class="space-y-6" id="payment-form">
            <div>
                <label class="block text-sm font-medium text-gray-300" for="payment-member-search">Search Member</label>
                <input class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white placeholder-gray-400 mb-3" id="payment-member-search" placeholder="Search by ID, Name or Phone" required="" type="text"/>
                <!-- Hidden input to store the selected member ID -->
                <input type="hidden" id="payment-member-id" name="memberId" required />
            </div>
            <div class="relative max-h-48 overflow-y-auto mb-4 bg-gray-800 rounded-lg border border-gray-600 hidden" id="payment-member-results">
                <!-- Search results will be dynamically inserted here -->
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300" for="payment-membership-type">Payment for</label>
                <select class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white mb-3" id="payment-membership-type" name="membershipType" required="">
                    <option value="Monthly">Monthly</option>
                    <option value="Quarterly">Quarterly</option>
                    <option value="HalfYearly">Half Yearly</option>
                    <option value="Annual">Annual</option>
                </select>
            </div>
            <div class="flex justify-end pt-4">
                <button class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out text-lg w-full mb-3" type="submit">
                    Add Payment
                </button>
            </div>
        </form>
    </div>
    <div class="tab-content bg-gray-700 p-6 rounded-xl shadow-inner hidden border border-gray-600" id="content-id-card">
        <h2 class="text-2xl font-bold text-white mb-6 text-lg">ü™™ ID Card View</h2>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300" for="id-card-member-id">Member ID</label>
                <input class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white placeholder-gray-400 mb-3" id="id-card-member-id" placeholder="Enter Member ID" type="text"/>
            </div>
            <div class="flex justify-center pt-2">
                <button class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out text-lg w-full mb-3" id="id-card-search-btn">
                    Search
                </button>
            </div>
        </div>
        <div class="bg-gray-800 rounded-xl shadow-lg mt-6 p-6 hidden text-white border border-gray-700" id="id-card-result">
            <h3 class="text-xl font-bold text-center mb-4 text-lg" id="id-card-name"></h3>
            <div class="flex flex-col items-center">
                <img alt="Member Photo" class="id-card-photo mb-4" id="id-card-photo" src="https://placehold.co/120x120/4a5568/cbd5e0?text=No+Photo"/>
                <p class="text-sm text-gray-400">Membership ID: <span class="font-bold text-gray-200" id="id-card-id"></span></p>
                <p class="text-sm text-gray-400">Phone: <span class="font-bold text-gray-200" id="id-card-phone"></span></p>
                <p class="text-sm text-gray-400">Status: <span class="font-bold" id="id-card-status"></span></p>
                <p class="text-sm text-gray-400 mt-2">Due Date: <span class="font-bold text-gray-200" id="id-card-due-date"></span></p>
            </div>
        </div>
    </div>
    
    <div class="tab-content bg-gray-700 p-6 rounded-xl shadow-inner hidden border border-gray-600" id="content-inactive-member">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-white">üí§ Inactive Members</h3>
            <span class="text-yellow-400 text-sm font-semibold" id="inactive-members-count-table">0 Inactive</span>
        </div>
        <div class="overflow-x-auto overflow-y-auto max-h-96 pr-2">
            <table class="min-w-full divide-y divide-gray-700 rounded-lg overflow-hidden">
                <thead class="bg-gray-800 sticky top-0">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Photo</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">ID</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Name</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Phone</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Type</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Start Date</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Due Date</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Fee</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Days Overdue</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-gray-800 divide-y divide-gray-700" id="inactive-list">
                    <!-- Inactive member rows will be dynamically inserted here -->
                    <tr>
                        <td colspan="10" class="px-6 py-4 text-center text-gray-400">No inactive members found.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<div class="fixed inset-0 flex items-center justify-center z-50 hidden" id="photo-view-modal">
    <div class="bg-gray-900 rounded-lg p-4 max-w-xl mx-auto border border-gray-700" id="photo-view-content">
        <div class="flex justify-end">
            <button class="text-gray-400 hover:text-gray-200 transition" id="close-photo-modal">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="flex justify-center mt-2">
            <img alt="Full size photo" class="max-w-full h-auto rounded-lg shadow-lg" id="full-size-photo"/>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, addDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // --- Firebase Configuration ---
    // !!! IMPORTANT SECURITY NOTICE !!!
    // This is a temporary measure to get the app running.
    // YOU MUST REPLACE THIS HARDCODED CONFIG WITH YOUR SECURE ENVIRONMENT VARIABLES
    // The preferred and secure method is: const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const firebaseConfig = {
      apiKey: "AIzaSyA1cOHWVufQV6ruZv3LmgdqfRNPGjyzsEI",
      authDomain: "alpha-core-fitness-data.firebaseapp.com",
      projectId: "alpha-core-fitness-data",
      storageBucket: "alpha-core-fitness-data.firebasestorage.app",
      messagingSenderId: "311733734225",
      appId: "1:311733734225:web:697ef2dc197ebb2e662170",
      measurementId: "G-C5EKPN2K2J"
    };
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // Initialize Firebase service variables
    let app, auth, db, storage;
    let userId;
    let isDataLoaded = false;
    let allMembersData = []; // Store all member data from Firestore

    // --- DOM Elements ---
    const splashScreen = document.getElementById('splash-screen');
    const mainAppSection = document.getElementById('main-app-section');
    const passwordModal = document.getElementById('password-entry-modal');
    const passwordInput = document.getElementById('app-password-input');
    const submitPasswordBtn = document.getElementById('submit-app-password');
    const signoutButton = document.getElementById('signout-button');
    const userIdDisplay = document.getElementById('user-id-value');
    const messageDisplay = document.getElementById('message-display');
    const loadingSpinnerModal = document.getElementById('loading-spinner-modal');

    // Sidebar
    const hamburgerBtn = document.getElementById('hamburger-btn');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');
    const sidebar = document.getElementById('sidebar');
    const backdrop = document.getElementById('backdrop');
    const navLinks = document.querySelectorAll('.nav-link');
    const tabContents = document.querySelectorAll('.tab-content');

    // Manage Member Form
    const memberForm = document.getElementById('member-form');
    const memberIdInput = document.getElementById('member-id');
    const nameInput = document.getElementById('name');
    const phoneNumberInput = document.getElementById('phone-number');
    const membershipTypeInput = document.getElementById('membershipType');
    const startDateInput = document.getElementById('startDate');
    const dueDateInput = document.getElementById('dueDate');
    const submitButton = document.getElementById('submit-button');
    const cancelEditButton = document.getElementById('cancel-edit-button');

    // Photo
    const uploadPhotoBtn = document.getElementById('upload-photo-btn');
    const takePhotoBtn = document.getElementById('take-photo-btn');
    const switchCameraBtn = document.getElementById('switch-camera-btn');
    const clearPhotoBtn = document.getElementById('clear-photo-btn');
    const photoPreview = document.getElementById('photo-preview');
    const photoUploadInput = document.getElementById('photo-upload');
    const cameraFeed = document.getElementById('camera-feed');
    const cameraCanvas = document.getElementById('camera-canvas');
    const viewPhotoLink = document.getElementById('view-photo-link');
    const photoViewModal = document.getElementById('photo-view-modal');
    const closePhotoModal = document.getElementById('close-photo-modal');
    const fullSizePhoto = document.getElementById('full-size-photo');
    let currentPhotoFile = null;
    let currentPhotoURL = '';
    let isEditing = false;
    let activeStream = null;
    let currentCameraDeviceId = null;
    let cameraDevices = [];

    // Payment Form
    const paymentForm = document.getElementById('payment-form');
    const paymentMemberSearchInput = document.getElementById('payment-member-search');
    const paymentMemberResultsDiv = document.getElementById('payment-member-results');
    const paymentMemberIdInput = document.getElementById('payment-member-id');
    const paymentMembershipTypeInput = document.getElementById('payment-membership-type');

    // ID Card View
    const idCardMemberIdInput = document.getElementById('id-card-member-id');
    const idCardSearchBtn = document.getElementById('id-card-search-btn');
    const idCardResultDiv = document.getElementById('id-card-result');
    const idCardPhoto = document.getElementById('id-card-photo');
    const idCardName = document.getElementById('id-card-name');
    const idCardId = document.getElementById('id-card-id');
    const idCardPhone = document.getElementById('id-card-phone');
    const idCardStatus = document.getElementById('id-card-status');
    const idCardDueDate = document.getElementById('id-card-due-date');

    // Overdue Members List (on Home)
    const overdueList = document.getElementById('overdue-list');
    const overdueMembersCountSummary = document.getElementById('overdue-members-count-summary');
    const overdueMembersCountTable = document.getElementById('overdue-members-count-table');
    
    // Inactive Members List
    const inactiveList = document.getElementById('inactive-list');
    const inactiveMembersCountSummary = document.getElementById('inactive-members-count-summary');
    const inactiveMembersCountTable = document.getElementById('inactive-members-count-table');

    // Member List (in Manage Member)
    const membersList = document.getElementById('members-list');
    const memberSearchInput = document.getElementById('member-search');
    const clearSearchBtn = document.getElementById('clear-search-btn');
    const totalActiveMembersCount = document.getElementById('total-active-members-count');
    const totalMembersCount = document.getElementById('total-members-count');
    const totalActiveMembersCountList = document.getElementById('total-active-members-count-list');
    const toggleMembersBtn = document.getElementById('toggle-members-btn');
    const membersListContainer = document.getElementById('members-list-container');

    // --- Helper Functions ---
    /**
     * Shows a message temporarily on the screen.
     * @param {string} message The message to display.
     * @param {string} type The type of message ('success' or 'error').
     */
    function showMessage(message, type = 'success') {
        messageDisplay.textContent = message;
        messageDisplay.className = `fixed top-6 right-6 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 ease-in-out block ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} text-white`;
        setTimeout(() => {
            messageDisplay.classList.add('hidden');
            messageDisplay.classList.remove('block');
        }, 5000);
    }

    /**
     * Calculates the due date based on membership type and start date.
     * @param {string} membershipType The type of membership.
     * @param {string} startDateString The start date in 'YYYY-MM-DD' format.
     * @returns {string} The due date in 'YYYY-MM-DD' format.
     */
    function calculateDueDate(membershipType, startDateString) {
        if (!startDateString) return '';
        const startDate = new Date(startDateString + 'T00:00:00'); // Use 'T00:00:00' to avoid timezone issues
        let dueDate = new Date(startDate)-1;

        switch (membershipType) {
            case 'Monthly':
                dueDate.setMonth(startDate.getMonth() + 1);
                break;
            case 'Quarterly':
                dueDate.setMonth(startDate.getMonth() + 3);
                break;
            case 'HalfYearly':
                dueDate.setMonth(startDate.getMonth() + 6);
                break;
            case 'Annual':
                dueDate.setFullYear(startDate.getFullYear() + 1);
                break;
        }

        // Adjust for potential month overflow (e.g., Jan 31 + 1 month -> March 3)
        if (dueDate.getDate() !== startDate.getDate()) {
            dueDate.setDate(0); // Set to last day of previous month
        }

        return dueDate.toISOString().split('T')[0];
    }

    /**
     * Uploads a file to Firebase Storage.
     * @param {File} file The file to upload.
     * @param {string} memberId The member ID for the file path.
     * @returns {Promise<string>} The download URL of the uploaded image.
     */
    async function uploadToFirebaseStorage(file, memberId) {
        if (!file) return '';
        loadingSpinnerModal.classList.remove('hidden');
        const fileExtension = file.name.split('.').pop();
        const fileName = `${memberId}_photo_${Date.now()}.${fileExtension}`;
        const storageRef = ref(storage, `/artifacts/${appId}/public/data/memberPhotos/${fileName}`);

        try {
            await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(storageRef);
            loadingSpinnerModal.classList.add('hidden');
            return downloadURL;
        } catch (error) {
            console.error('Firebase Storage upload failed:', error);
            showMessage('Photo upload failed. Please try again.', 'error');
            loadingSpinnerModal.classList.add('hidden');
            return '';
        }
    }

    /**
     * Fetches a single member document from Firestore by ID.
     * @param {string} memberId The ID of the member.
     * @returns {Promise<Object|null>} The member data or null if not found.
     */
    async function getMember(memberId) {
        try {
            const memberDocRef = doc(db, `/artifacts/${appId}/public/data/gymMembers`, memberId);
            const memberDoc = await getDoc(memberDocRef);
            if (memberDoc.exists()) {
                return { id: memberDoc.id, ...memberDoc.data() };
            }
        } catch (error) {
            console.error('Error fetching member:', error);
            showMessage('Error fetching member data.', 'error');
        }
        return null;
    }

    /**
     * Adds a new member to Firestore.
     * @param {Object} memberData The member data.
     */
    async function addMember(memberData) {
        try {
            const memberDocRef = doc(db, `/artifacts/${appId}/public/data/gymMembers`, memberData.memberId);
            const memberDoc = await getDoc(memberDocRef);

            if (memberDoc.exists()) {
                showMessage('Member ID already exists. Use a different ID or edit the existing member.', 'error');
                return;
            }

            await setDoc(memberDocRef, { ...memberData, status: 'active' });
            showMessage('Member added successfully!');
            memberForm.reset();
            photoPreview.src = 'https://placehold.co/112x112/4a5568/cbd5e0?text=No+Photo';
            currentPhotoURL = '';
            clearPhotoBtn.classList.add('hidden');
            memberIdInput.readOnly = false;
        } catch (error) {
            console.error('Error adding member:', error);
            showMessage('Error adding member. Please check Member ID.', 'error');
        }
    }

    /**
     * Updates an existing member in Firestore.
     * @param {string} memberId The ID of the member to update.
     * @param {Object} memberData The updated member data.
     */
    async function updateMember(memberId, memberData) {
        try {
            const memberDocRef = doc(db, `/artifacts/${appId}/public/data/gymMembers`, memberId);
            await updateDoc(memberDocRef, memberData);
            showMessage('Member updated successfully!');
            memberForm.reset();
            photoPreview.src = 'https://placehold.co/112x112/4a5568/cbd5e0?text=No+Photo';
            currentPhotoURL = '';
            clearPhotoBtn.classList.add('hidden');
            memberIdInput.readOnly = false;
            submitButton.textContent = 'Add Member';
            cancelEditButton.classList.add('hidden');
            isEditing = false;
        } catch (error) {
            console.error('Error updating member:', error);
            showMessage('Error updating member.', 'error');
        }
    }

    /**
     * Adds a payment document to a member's subcollection in Firestore and updates the member's due date.
     * @param {string} memberId The ID of the member.
     * @param {Object} paymentData The payment data.
     * @param {string} renewalType The selected renewal type (Monthly, Quarterly, etc.).
     */
    async function addPayment(memberId, paymentData, renewalType) {
        try {
            const memberDocRef = doc(db, `/artifacts/${appId}/public/data/gymMembers`, memberId);
            const memberDoc = await getDoc(memberDocRef);

            if (memberDoc.exists()) {
                const memberData = memberDoc.data();
                let newDueDate;
                // If member is overdue or inactive, use today's date as the start date
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const currentDueDate = new Date(memberData.dueDate + 'T00:00:00');
                if (memberData.status === 'inactive' || currentDueDate < today) {
                    newDueDate = calculateDueDate(renewalType, today.toISOString().split('T')[0]);
                } else {
                    newDueDate = calculateDueDate(renewalType, memberData.dueDate);
                }
                
                // Add the payment document
                const paymentsCollectionRef = collection(db, `/artifacts/${appId}/public/data/gymMembers/${memberId}/payments`);
                await addDoc(paymentsCollectionRef, paymentData);

                // Update the member's main document with the new due date and membership type
                await updateDoc(memberDocRef, {
                    dueDate: newDueDate,
                    membershipType: renewalType, // Update the membership type as well
                    status: 'active'
                });

                showMessage('Payment added and due date updated successfully!');
            } else {
                showMessage('Member not found. Payment not added.', 'error');
            }

            paymentForm.reset();
            // Clear payment search field and results
            paymentMemberSearchInput.value = '';
            paymentMemberIdInput.value = '';
            paymentMemberResultsDiv.innerHTML = '';
            paymentMemberResultsDiv.classList.add('hidden');
        } catch (error) {
            console.error('Error adding payment:', error);
            showMessage('Error adding payment. Member not found or invalid data.', 'error');
        }
    }
    
    /**
     * Deletes a member from Firestore.
     * @param {string} memberId The ID of the member to delete.
     */
    async function deleteMember(memberId) {
        try {
            const memberDocRef = doc(db, `/artifacts/${appId}/public/data/gymMembers`, memberId);
            await deleteDoc(memberDocRef);
            showMessage('Member deleted successfully!');
        } catch (error) {
            console.error('Error deleting member:', error);
            showMessage('Error deleting member.', 'error');
        }
    }

    /**
     * Renders member data into a table row.
     * @param {Object} member The member data.
     * @param {string} type The list type ('active', 'overdue', 'inactive').
     * @returns {string} The HTML string for the table row.
     */
    function renderTableRow(member, type) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const dueDate = new Date(member.dueDate + 'T00:00:00');

        let daysText = 'N/A';
        let actionsHtml = '';
        let rowClass = 'text-gray-300';
        let photoUrl = member.photoURL || 'https://placehold.co/40x40/4a5568/cbd5e0?text=No+Photo';

        if (type === 'active') {
            const diffInTime = dueDate.getTime() - today.getTime();
            const diffInDays = Math.ceil(diffInTime / (1000 * 3600 * 24));
            if (diffInDays <= 0) {
                 daysText = `${Math.abs(diffInDays)} day${Math.abs(diffInDays) === 1 ? '' : 's'} overdue`;
                 rowClass = 'text-red-400';
            } else {
                daysText = `${diffInDays} day${diffInDays === 1 ? '' : 's'} left`;
                if (diffInDays <= 7) {
                    daysText = `<span class="text-yellow-400">${daysText}</span>`;
                }
            }
            actionsHtml = `
                <button class="text-indigo-400 hover:text-indigo-200 edit-btn mr-4" data-id="${member.memberId}">Edit</button>
                <button class="text-yellow-400 hover:text-yellow-200 mark-inactive-btn mr-4" data-id="${member.memberId}">Mark Inactive</button>
                <button class="text-red-400 hover:text-red-200 delete-btn" data-id="${member.memberId}">Delete</button>
            `;
        } else if (type === 'overdue') {
            const diffInTime = today.getTime() - dueDate.getTime();
            const diffInDays = Math.floor(diffInTime / (1000 * 3600 * 24));
            daysText = `${diffInDays} day${diffInDays === 1 ? '' : 's'} overdue`;
            rowClass = 'text-red-400';
            actionsHtml = `
                <button class="text-green-400 hover:text-green-200 renew-btn" data-id="${member.memberId}">Renew</button>
            `;
        } else if (type === 'inactive') {
            daysText = 'N/A';
            rowClass = 'text-yellow-400';
            actionsHtml = `
                <button class="text-green-400 hover:text-green-200 reactivate-btn mr-4" data-id="${member.memberId}">Reactivate</button>
                <button class="text-red-400 hover:text-red-200 delete-btn" data-id="${member.memberId}">Delete</button>
            `;
        }

        return `
            <tr class="transition-colors duration-200 ease-in-out hover:bg-gray-700 ${rowClass}">
                <td class="px-3 py-4 whitespace-nowrap">
                    <img class="member-photo" src="${photoUrl}" alt="${member.name}" onerror="this.onerror=null;this.src='https://placehold.co/40x40/4a5568/cbd5e0?text=No+Photo';">
                </td>
                <td class="px-3 py-4 whitespace-nowrap text-sm font-medium">${member.memberId}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm">${member.name}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm">${member.phoneNumber || 'N/A'}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm">${member.membershipType}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm">${member.startDate}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm">${member.dueDate}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm">N/A</td> <!-- Fee is not tracked per member in this schema -->
                <td class="px-3 py-4 whitespace-nowrap text-sm">${daysText}</td>
                <td class="px-3 py-4 whitespace-nowrap text-right text-sm font-medium">
                    ${actionsHtml}
                </td>
            </tr>
        `;
    }

    /**
     * Displays a list of active members in the main table.
     * @param {Array<Object>} members The list of member data.
     */
    function displayActiveMembers(members) {
        membersList.innerHTML = '';
        totalActiveMembersCountList.textContent = members.length;
        if (members.length === 0) {
            membersList.innerHTML = `<tr><td colspan="10" class="px-6 py-4 text-center text-gray-400">No active members found.</td></tr>`;
            return;
        }
        members.forEach(member => {
            membersList.innerHTML += renderTableRow(member, 'active');
        });
    }

    /**
     * Displays a list of overdue members in the overdue table.
     * @param {Array<Object>} overdueMembers The list of overdue member data.
     */
    function displayOverdueMembers(overdueMembers) {
        overdueList.innerHTML = '';
        overdueMembersCountSummary.textContent = overdueMembers.length;
        overdueMembersCountTable.textContent = `${overdueMembers.length} Overdue`;
        if (overdueMembers.length === 0) {
            overdueList.innerHTML = `
                <tr>
                    <td colspan="10" class="px-6 py-4 text-center text-gray-400">No overdue members found.</td>
                </tr>
            `;
            return;
        }
        overdueMembers.forEach(member => {
            overdueList.innerHTML += renderTableRow(member, 'overdue');
        });
    }

    /**
     * Displays a list of inactive members in the inactive table.
     * @param {Array<Object>} inactiveMembers The list of inactive member data.
     */
    function displayInactiveMembers(inactiveMembers) {
        inactiveList.innerHTML = '';
        inactiveMembersCountSummary.textContent = inactiveMembers.length;
        inactiveMembersCountTable.textContent = `${inactiveMembers.length} Inactive`;
        if (inactiveMembers.length === 0) {
            inactiveList.innerHTML = `
                <tr>
                    <td colspan="10" class="px-6 py-4 text-center text-gray-400">No inactive members found.</td>
                </tr>
            `;
            return;
        }
        inactiveMembers.forEach(member => {
            inactiveList.innerHTML += renderTableRow(member, 'inactive');
        });
    }

    /**
     * Renders a list of members for the payment search results.
     * @param {Array<Object>} members The list of members to display.
     */
    function renderPaymentMemberResults(members) {
        if (members.length > 0) {
            paymentMemberResultsDiv.classList.remove('hidden');
            paymentMemberResultsDiv.innerHTML = '';
            members.forEach(member => {
                const resultItem = document.createElement('div');
                resultItem.className = 'p-3 hover:bg-gray-700 cursor-pointer transition-colors duration-150 ease-in-out';
                resultItem.dataset.id = member.memberId;
                resultItem.dataset.name = member.name;
                resultItem.innerHTML = `<p class="text-white font-medium">${member.name}</p><p class="text-sm text-gray-400">ID: ${member.memberId} | Phone: ${member.phoneNumber || 'N/A'}</p>`;
                paymentMemberResultsDiv.appendChild(resultItem);
            });
        } else {
            paymentMemberResultsDiv.classList.add('hidden');
            paymentMemberResultsDiv.innerHTML = '';
        }
    }


    /**
     * Loads member data for editing.
     * @param {string} memberId The ID of the member to edit.
     */
    async function loadMemberForEdit(memberId) {
        const member = await getMember(memberId);
        if (member) {
            isEditing = true;
            memberIdInput.value = member.memberId;
            memberIdInput.readOnly = true;
            nameInput.value = member.name;
            phoneNumberInput.value = member.phoneNumber;
            membershipTypeInput.value = member.membershipType;
            startDateInput.value = member.startDate;
            dueDateInput.value = member.dueDate;
            if (member.photoURL) {
                photoPreview.src = member.photoURL;
                currentPhotoURL = member.photoURL;
                viewPhotoLink.classList.remove('hidden');
                viewPhotoLink.href = member.photoURL;
            } else {
                photoPreview.src = 'https://placehold.co/112x112/4a5568/cbd5e0?text=No+Photo';
                viewPhotoLink.classList.add('hidden');
            }
            clearPhotoBtn.classList.remove('hidden');
            submitButton.textContent = 'Update Member';
            cancelEditButton.classList.remove('hidden');
            
            // Switch to the Manage Member tab
            document.getElementById('nav-manage-member').click();
        } else {
            showMessage('Member not found for editing.', 'error');
        }
    }

    // --- Event Listeners and Logic ---

    // Initial Authentication and Data Loading
    window.onload = async () => {
        splashScreen.classList.add('hidden');
        
        // Initialize Firebase services
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
            
            // Set up the authentication state listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    console.log("User authenticated with UID:", userId);
                    
                    // Show password modal after successful auth
                    passwordModal.classList.remove('hidden');
                    passwordModal.classList.add('flex');
                    
                } else {
                    console.log("User signed out or authentication failed.");
                    mainAppSection.classList.add('hidden');
                    passwordModal.classList.remove('hidden');
                    passwordModal.classList.add('flex');
                    passwordInput.value = '';
                }
            });

            // Attempt to sign in with the provided custom token
            try {
                const customAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (customAuthToken) {
                    console.log("Attempting sign-in with custom token...");
                    await signInWithCustomToken(auth, customAuthToken);
                } else {
                    console.log("No custom token found, signing in anonymously...");
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                if (error.code === 'auth/invalid-api-key') {
                    showMessage('Firebase initialization failed: The provided API key is invalid. Please check the environment configuration.', 'error');
                    console.error('Critical Error: Firebase authentication failed due to an invalid API key. This is an environment configuration issue and cannot be fixed in the code. Please ensure your Firebase API key is correct.');
                } else {
                    showMessage(`Authentication failed: ${error.message}`, 'error');
                }
            }

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            if (error.code === 'auth/invalid-api-key') {
                 showMessage('Firebase initialization failed: The provided API key is invalid. Please check the environment configuration.', 'error');
                 console.error('Critical Error: Firebase initialization failed due to an invalid API key. This is an environment configuration issue and cannot be fixed in the code. Please ensure your Firebase API key is correct.');
            } else {
                 showMessage(`Firebase initialization failed: ${error.message}`, 'error');
            }
        }
    };
    
    submitPasswordBtn.addEventListener('click', () => {
        const password = passwordInput.value;
        if (password === '2003') { 
            passwordModal.classList.remove('flex');
            passwordModal.classList.add('hidden');
            mainAppSection.classList.remove('hidden', 'opacity-0', 'scale-95');
            mainAppSection.classList.add('opacity-100', 'scale-100');
            
            // Only attach the listener once after successful password entry
            if (!isDataLoaded) {
                const q = query(collection(db, `/artifacts/${appId}/public/data/gymMembers`));
                onSnapshot(q, (querySnapshot) => {
                    allMembersData = [];
                    const activeMembers = [];
                    const overdueMembers = [];
                    const inactiveMembers = [];
                    let totalMembers = 0;
                    const today = new Date();
                    today.setHours(0, 0, 0, 0); // Normalize today's date

                    querySnapshot.forEach((doc) => {
                        const memberData = doc.data();
                        allMembersData.push(memberData);
                        totalMembers++;
                        const dueDate = new Date(memberData.dueDate + 'T00:00:00');
                        
                        if (memberData.status === 'inactive') {
                            inactiveMembers.push(memberData);
                        } else if (dueDate <= today) {
                            overdueMembers.push(memberData);
                        } else {
                            activeMembers.push(memberData);
                        }
                    });
                    
                    // Sort overdue members by days overdue (max to min)
                    overdueMembers.sort((a, b) => {
                        const today = new Date();
                        const dueDateA = new Date(a.dueDate + 'T00:00:00');
                        const dueDateB = new Date(b.dueDate + 'T00:00:00');
                        const daysOverdueA = Math.floor((today.getTime() - dueDateA.getTime()) / (1000 * 3600 * 24));
                        const daysOverdueB = Math.floor((today.getTime() - dueDateB.getTime()) / (1000 * 3600 * 24));
                        return daysOverdueB - daysOverdueA;
                    });
                    
                    // Sort active members by days left (min to max)
                    activeMembers.sort((a, b) => {
                        const today = new Date();
                        const dueDateA = new Date(a.dueDate + 'T00:00:00');
                        const dueDateB = new Date(b.dueDate + 'T00:00:00');
                        const daysLeftA = Math.ceil((dueDateA.getTime() - today.getTime()) / (1000 * 3600 * 24));
                        const daysLeftB = Math.ceil((dueDateB.getTime() - today.getTime()) / (1000 * 3600 * 24));
                        return daysLeftA - daysLeftB;
                    });

                    totalMembersCount.textContent = totalMembers;
                    totalActiveMembersCount.textContent = activeMembers.length;
                    totalActiveMembersCountList.textContent = activeMembers.length;
                    
                    displayActiveMembers(activeMembers);
                    displayOverdueMembers(overdueMembers);
                    displayInactiveMembers(inactiveMembers);
                    
                    isDataLoaded = true;
                }, (error) => {
                    console.error("Error getting data: ", error);
                    showMessage('Failed to connect to Firestore. Check your console for details.', 'error');
                });
            }
        } else {
            showMessage('Incorrect password. Please try again.', 'error');
            passwordInput.value = '';
        }
    });

    signoutButton.addEventListener('click', async () => {
        await auth.signOut();
        showMessage('Signed out successfully.');
    });

    // Sidebar navigation logic
    hamburgerBtn.addEventListener('click', () => {
        sidebar.classList.add('open');
        backdrop.classList.remove('hidden');
    });

    closeSidebarBtn.addEventListener('click', () => {
        sidebar.classList.remove('open');
        backdrop.classList.add('hidden');
    });

    backdrop.addEventListener('click', () => {
        sidebar.classList.remove('open');
        backdrop.classList.add('hidden');
    });

    const defaultEmojis = {
    'nav-home': 'üè† Home',
    'nav-manage-member': 'üë§ Manage Member',
    'nav-add-payment': 'üí≥ Add Payment',
    'nav-id-card': 'ü™™ ID Card View',
    'nav-inactive-member': 'üí§ Inactive Members'
};

navLinks.forEach(link => {
    link.addEventListener('click', (e) => {
        e.preventDefault();

        // Reset all tabs back to their default emoji + text
        navLinks.forEach(l => {
            l.classList.remove('active');
            l.textContent = defaultEmojis[l.id];
        });

        // Mark clicked tab as active and give ‚ú® emoji
        const activeTab = e.target.closest('.nav-link');
        activeTab.classList.add('active');
        activeTab.textContent = `‚ú® ${activeTab.textContent.replace('‚ú®','').trim()}`;

        // Switch tab content
        tabContents.forEach(c => c.classList.add('hidden'));
        const targetId = activeTab.id.replace('nav-', 'content-');
        document.getElementById(targetId).classList.remove('hidden');
    });
});

    // Default tab active on load
    document.getElementById('nav-home').click();

    // Due Date Calculation
    startDateInput.addEventListener('change', () => {
        const dueDate = calculateDueDate(membershipTypeInput.value, startDateInput.value);
        dueDateInput.value = dueDate;
    });
    membershipTypeInput.addEventListener('change', () => {
        const dueDate = calculateDueDate(membershipTypeInput.value, startDateInput.value);
        dueDateInput.value = dueDate;
    });

    // Photo Management
    uploadPhotoBtn.addEventListener('click', () => {
        photoUploadInput.click();
    });

    takePhotoBtn.addEventListener('click', async () => {
        if (activeStream) {
            // Take photo
            cameraCanvas.width = cameraFeed.videoWidth;
            cameraCanvas.height = cameraFeed.videoHeight;
            const context = cameraCanvas.getContext('2d');
            context.drawImage(cameraFeed, 0, 0, cameraCanvas.width, cameraCanvas.height);
            const dataUrl = cameraCanvas.toDataURL('image/jpeg');

            photoPreview.src = dataUrl;
            currentPhotoFile = dataURLtoFile(dataUrl, `photo_${Date.now()}.jpeg`);
            currentPhotoURL = dataUrl;

            // Stop camera feed
            activeStream.getTracks().forEach(track => track.stop());
            cameraFeed.classList.add('hidden');
            photoPreview.classList.remove('hidden');
            takePhotoBtn.textContent = 'Take Photo';
            switchCameraBtn.classList.add('hidden');
            clearPhotoBtn.classList.remove('hidden');
            viewPhotoLink.classList.remove('hidden');
            viewPhotoLink.href = dataUrl;
        } else {
            // Start camera
            try {
                const constraints = { video: { facingMode: 'user' } };
                activeStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraFeed.srcObject = activeStream;
                cameraFeed.classList.remove('hidden');
                photoPreview.classList.add('hidden');
                takePhotoBtn.textContent = 'Capture Photo';
                clearPhotoBtn.classList.remove('hidden');
                viewPhotoLink.classList.add('hidden');

                const devices = await navigator.mediaDevices.enumerateDevices();
                cameraDevices = devices.filter(d => d.kind === 'videoinput');
                if (cameraDevices.length > 1) {
                    switchCameraBtn.classList.remove('hidden');
                    currentCameraDeviceId = cameraDevices[0].deviceId;
                }
            } catch (err) {
                console.error("Error accessing camera: ", err);
                showMessage('Failed to access camera. Please check permissions.', 'error');
            }
        }
    });

    switchCameraBtn.addEventListener('click', async () => {
        if (!activeStream) return;
        activeStream.getTracks().forEach(track => track.stop());

        const currentIndex = cameraDevices.findIndex(d => d.deviceId === currentCameraDeviceId);
        const nextIndex = (currentIndex + 1) % cameraDevices.length;
        currentCameraDeviceId = cameraDevices[nextIndex].deviceId;

        const constraints = { video: { deviceId: { exact: currentCameraDeviceId } } };
        try {
            activeStream = await navigator.mediaDevices.getUserMedia(constraints);
            cameraFeed.srcObject = activeStream;
        } catch (err) {
            console.error("Error switching camera: ", err);
            showMessage('Failed to switch camera.', 'error');
        }
    });

    clearPhotoBtn.addEventListener('click', () => {
        if (activeStream) {
            activeStream.getTracks().forEach(track => track.stop());
            cameraFeed.classList.add('hidden');
            photoPreview.classList.remove('hidden');
            takePhotoBtn.textContent = 'Take Photo';
            switchCameraBtn.classList.add('hidden');
        }
        photoPreview.src = 'https://placehold.co/112x112/4a5568/cbd5e0?text=No+Photo';
        photoPreview.classList.remove('hidden');
        clearPhotoBtn.classList.add('hidden');
        switchCameraBtn.classList.add('hidden');
        currentPhotoFile = null;
        currentPhotoURL = '';
        viewPhotoLink.classList.add('hidden');
    });

    photoUploadInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            currentPhotoFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                photoPreview.src = e.target.result;
                currentPhotoURL = e.target.result;
                viewPhotoLink.classList.remove('hidden');
                viewPhotoLink.href = e.target.result;
                clearPhotoBtn.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    });

    // Helper function to convert data URL to File object
    function dataURLtoFile(dataurl, filename) {
        const arr = dataurl.split(',');
        const mime = arr[0].match(/:(.*?);/)[1];
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint16Array(n);
        while (n--) {
            u8arr[n] = bstr.charCodeAt(n);
        }
        return new File([u8arr], filename, { type: mime });
    }

    // View photo in modal
    photoPreview.addEventListener('click', () => {
        if (currentPhotoURL) {
            fullSizePhoto.src = currentPhotoURL;
            photoViewModal.classList.remove('hidden');
            photoViewModal.classList.add('flex');
        }
    });

    closePhotoModal.addEventListener('click', () => {
        photoViewModal.classList.remove('flex');
        photoViewModal.classList.add('hidden');
    });

    // Form Submission
    memberForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        submitButton.disabled = true; // Disable button to prevent double clicks
        
        const memberId = memberIdInput.value.trim();
        const name = nameInput.value.trim();
        const phoneNumber = phoneNumberInput.value.trim();
        const membershipType = membershipTypeInput.value;
        const startDate = startDateInput.value;
        const dueDate = dueDateInput.value;

        if (!isEditing) {
            const memberExists = await getMember(memberId);
            if (memberExists) {
                showMessage('Error: Member with this ID already exists. Please use a unique ID.', 'error');
                submitButton.disabled = false;
                return;
            }
        }

        let photoURL = currentPhotoURL;
        if (currentPhotoFile) {
            photoURL = await uploadToFirebaseStorage(currentPhotoFile, memberId);
        }

        const memberData = {
            memberId,
            name,
            phoneNumber,
            membershipType,
            startDate,
            dueDate,
            photoURL,
        };

        if (isEditing) {
            await updateMember(memberId, memberData);
        } else {
            await addMember(memberData);
        }
        
        submitButton.disabled = false;
    });

    cancelEditButton.addEventListener('click', () => {
        memberForm.reset();
        isEditing = false;
        memberIdInput.readOnly = false;
        submitButton.textContent = 'Add Member';
        cancelEditButton.classList.add('hidden');
        photoPreview.src = 'https://placehold.co/112x112/4a5568/cbd5e0?text=No+Photo';
        currentPhotoURL = '';
        clearPhotoBtn.classList.add('hidden');
        viewPhotoLink.classList.add('hidden');
    });

    // Add Payment Form Logic
    paymentMemberSearchInput.addEventListener('input', () => {
        const query = paymentMemberSearchInput.value.toLowerCase().trim();
        // Reset selected member ID if search changes
        paymentMemberIdInput.value = '';
        if (query.length > 0) {
            const filteredMembers = allMembersData.filter(member =>
                member.name.toLowerCase().includes(query) ||
                member.memberId.toLowerCase().includes(query) ||
                (member.phoneNumber && member.phoneNumber.toLowerCase().includes(query))
            );
            renderPaymentMemberResults(filteredMembers);
        } else {
            paymentMemberResultsDiv.classList.add('hidden');
            paymentMemberResultsDiv.innerHTML = '';
        }
    });

    paymentMemberResultsDiv.addEventListener('click', (e) => {
        const selectedItem = e.target.closest('div');
        if (selectedItem && selectedItem.dataset.id) {
            const memberId = selectedItem.dataset.id;
            const memberName = selectedItem.dataset.name;
            // Set the value of the hidden input
            paymentMemberIdInput.value = memberId;
            // Display the selected member's name in the search box for user feedback
            paymentMemberSearchInput.value = memberName;
            // Hide the results list
            paymentMemberResultsDiv.classList.add('hidden');
        }
    });

    paymentForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const memberId = paymentMemberIdInput.value.trim();
        const renewalType = paymentMembershipTypeInput.value;
        
        if (!memberId) {
            showMessage('Please select a member from the search results.', 'error');
            return;
        }

        // Automatically set the payment date to today's date
        const today = new Date();
        const date = today.toISOString().split('T')[0];

        // Create a simple payment data object with only the renewal type and date
        const paymentData = { date, renewalType };
        await addPayment(memberId, paymentData, renewalType);
    });

    // ID Card Search
    idCardSearchBtn.addEventListener('click', async () => {
        const memberId = idCardMemberIdInput.value.trim();
        if (memberId) {
            const member = await getMember(memberId);
            if (member) {
                idCardName.textContent = member.name;
                idCardId.textContent = member.memberId;
                idCardPhone.textContent = member.phoneNumber || 'N/A';
                idCardDueDate.textContent = member.dueDate;
                idCardPhoto.src = member.photoURL || 'https://placehold.co/120x120/4a5568/cbd5e0?text=No+Photo';
                
                const today = new Date();
                const dueDate = new Date(member.dueDate);
                if (member.status === 'inactive') {
                    idCardStatus.textContent = 'Inactive (Manually)';
                    idCardStatus.className = 'font-bold text-yellow-400';
                } else if (dueDate <= today) {
                    idCardStatus.textContent = 'Inactive (Overdue)';
                    idCardStatus.className = 'font-bold text-red-400';
                } else {
                    idCardStatus.textContent = 'Active';
                    idCardStatus.className = 'font-bold text-green-400';
                }
                idCardResultDiv.classList.remove('hidden');
            } else {
                showMessage('Member not found.', 'error');
                idCardResultDiv.classList.add('hidden');
            }
        }
    });

    // Overdue List Actions
    overdueList.addEventListener('click', async (e) => {
        if (e.target.classList.contains('renew-btn')) {
            const memberId = e.target.dataset.id;
            const member = await getMember(memberId);
            if (member) {
                // Pre-populate payment form with member ID and their current membership type for renewal
                paymentMemberIdInput.value = member.memberId;
                paymentMemberSearchInput.value = member.name;
                paymentMembershipTypeInput.value = member.membershipType;
                // Switch to the payment tab
                document.getElementById('nav-add-payment').click();
            }
        }
    });

    // Member List actions
    membersList.addEventListener('click', async (e) => {
        if (e.target.classList.contains('edit-btn')) {
            const memberId = e.target.dataset.id;
            await loadMemberForEdit(memberId);
        }
        if (e.target.classList.contains('delete-btn')) {
            const memberId = e.target.dataset.id;
            await deleteMember(memberId);
        }
        if (e.target.classList.contains('mark-inactive-btn')) {
            const memberId = e.target.dataset.id;
            await updateMember(memberId, { status: 'inactive' });
            showMessage('Member marked as inactive.');
        }
    });

    // Inactive List actions
    inactiveList.addEventListener('click', async (e) => {
        if (e.target.classList.contains('reactivate-btn')) {
            const memberId = e.target.dataset.id;
            await updateMember(memberId, { status: 'active' });
            showMessage('Member reactivated.');
        }
        if (e.target.classList.contains('delete-btn')) {
            const memberId = e.target.dataset.id;
            await deleteMember(memberId);
        }
    });

    // Member Search
    memberSearchInput.addEventListener('input', (e) => {
        const searchText = e.target.value.toLowerCase();
        const rows = membersList.querySelectorAll('tr');
        rows.forEach(row => {
            const memberId = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            const memberName = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
            if (memberId.includes(searchText) || memberName.includes(searchText)) {
                row.classList.remove('hidden');
            } else {
                row.classList.add('hidden');
            }
        });
    });

    clearSearchBtn.addEventListener('click', () => {
        memberSearchInput.value = '';
        memberSearchInput.dispatchEvent(new Event('input'));
    });

    toggleMembersBtn.addEventListener('click', () => {
        membersListContainer.classList.toggle('hidden');
        toggleMembersBtn.textContent = membersListContainer.classList.contains('hidden') ? `Show Current Members (${totalActiveMembersCountList.textContent})` : 'Hide Current Members';
    });

    // Date and Time Display
    function updateDateTime() {
        const now = new Date();
        const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
        const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
        const dayOptions = { weekday: 'long' };

        document.getElementById('current-time').textContent = now.toLocaleTimeString('en-US', timeOptions);
        document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', dateOptions);
        document.getElementById('current-day').textContent = now.toLocaleDateString('en-US', dayOptions);
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();
</script>

<footer class="fixed bottom-0 w-full bg-gray-900 text-gray-400 text-center py-3 border-t border-gray-700">
    Made with ‚ù§Ô∏è by SUSHANT SINGH
</footer>
</body>

</html>
 
