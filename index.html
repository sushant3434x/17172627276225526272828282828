<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Management Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #1a202c, #2d3748);
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #4a5568;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #a0aec0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #cbd5e0;
        }
        .member-photo {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 50%;
            border: 1px solid #4a5568;
        }
        /* ID Card Photo */
        .id-card-photo {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #6366f1;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .tab-active {
            border-color: #6366f1;
            color: #818cf8;
            font-weight: 600;
        }
        #message-display.hidden {
            opacity: 0;
            transform: translateY(-20px);
        }
        #message-display.block {
            opacity: 1;
            transform: translateY(0);
        }
        .line-through-name {
            text-decoration: line-through;
        }
        #photo-view-modal {
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(12px);
            transition: opacity 0.3s ease-in-out;
        }
        #photo-view-modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #photo-view-modal.flex {
            opacity: 1;
            pointer-events: auto;
        }
        #photo-view-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        #photo-view-modal.hidden #photo-view-content {
            transform: scale(0.9);
            opacity: 0;
        }
        #photo-view-modal.flex #photo-view-content {
            transform: scale(1);
            opacity: 1;
        }
        /* Style for the password entry modal */
        #password-entry-modal {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            transition: opacity 0.3s ease-in-out;
        }
        #password-entry-modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #password-entry-modal.flex {
            opacity: 1;
            pointer-events: auto;
        }
        #password-entry-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        #password-entry-modal.hidden #password-entry-content {
            transform: translateY(-20px);
            opacity: 0;
        }
        #password-entry-modal.flex #password-entry-content {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body class="min-h-screen p-6 flex flex-col items-center justify-center">

    <!-- Message Display -->
    <div id="message-display" class="fixed top-6 right-6 p-4 rounded-lg shadow-lg text-white z-50 transition-all duration-300 ease-in-out hidden"></div>

    <!-- Authentication Section (Re-introduced) -->
    <div id="auth-section" class="bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-md mb-8 hidden border border-gray-700">
        <h1 class="text-4xl font-extrabold text-white mb-6 text-center">Gym Manager</h1>
        <p class="text-gray-300 text-center mb-8 text-lg">Sign in or sign up to access your dashboard.</p>

        <div class="space-y-5">
            <div>
                <label for="auth-email" class="block text-sm font-medium text-gray-300">Email Address</label>
                <input type="email" id="auth-email" class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out bg-gray-700 text-white placeholder-gray-400" placeholder="your@example.com">
            </div>
            <div>
                <label for="auth-password" class="block text-sm font-medium text-gray-300">Password</label>
                <input type="password" id="auth-password" class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out bg-gray-700 text-white placeholder-gray-400" placeholder="••••••••">
            </div>

            <div class="flex flex-col space-y-4 pt-2">
                <button id="signin-button" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out text-lg">
                    Sign In
                </button>
                <button id="signup-button" class="w-full py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out text-lg">
                    Sign Up
                </button>
                <div class="text-center text-gray-400 text-sm">— OR —</div>
                <button id="anonymous-signin-button" class="w-full py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-150 ease-in-out text-lg">
                    Continue Anonymously
                </button>
            </div>
        </div>
    </div>

    <!-- Password Entry Modal -->
    <div id="password-entry-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div id="password-entry-content" class="bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-sm border border-gray-700">
            <h2 class="text-3xl font-bold text-white mb-6 text-center">Enter App Password</h2>
            <input type="password" id="app-password-input" class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white placeholder-gray-400 text-center text-xl" placeholder="••••" maxlength="4">
            <button id="submit-app-password" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out text-lg mt-6">
                Unlock App
            </button>
        </div>
    </div>


    <!-- Main Gym App Section -->
    <div id="main-app-section" class="bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-2xl mb-8 hidden transform scale-95 opacity-0 transition-all duration-500 ease-out border border-gray-700">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-extrabold text-white">Gym Dashboard</h1>
            <!-- Date, Time, Day Display -->
            <div id="datetime-display" class="text-right text-gray-400 text-sm font-medium">
                <div id="current-time" class="text-xl font-semibold text-gray-200"></div>
                <div id="current-date"></div>
                <div id="current-day"></div>
            </div>
            <button id="signout-button" class="px-5 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                Sign Out
            </button>
        </div>

        <!-- User ID Display for collaborative environment -->
        <div id="user-id-display" class="text-sm text-gray-400 mb-6 text-center bg-gray-700 p-3 rounded-lg border border-gray-600">
            Your User ID: <span id="user-id-value" class="font-mono text-gray-200 font-semibold"></span>
        </div>

        <!-- Tabs for Member Forms -->
        <div class="flex border-b border-gray-700 mb-8">
            <button id="tab-manage-member" class="py-3 px-6 text-base font-medium text-center text-gray-300 border-b-2 border-transparent hover:text-indigo-400 hover:border-indigo-600 focus:outline-none transition duration-150 ease-in-out">
                Manage Member Details
            </button>
            <button id="tab-add-existing" class="py-3 px-6 text-base font-medium text-center text-gray-500 border-b-2 border-transparent hover:text-gray-300 hover:border-gray-600 focus:outline-none transition duration-150 ease-in-out">
                Add Existing Member
            </button>
            <button id="tab-add-payment" class="py-3 px-6 text-base font-medium text-center text-gray-500 border-b-2 border-transparent hover:text-gray-300 hover:border-gray-600 focus:outline-none transition duration-150 ease-in-out">
                Add Payment
            </button>
            <button id="tab-id-card" class="py-3 px-6 text-base font-medium text-center text-gray-500 border-b-2 border-transparent hover:text-gray-300 hover:border-gray-600 focus:outline-none transition duration-150 ease-in-out">
                ID Card View
            </button>
        </div>

        <!-- Tab Content: Manage Member Details (Existing Form) -->
        <div id="content-manage-member" class="tab-content bg-gray-700 p-6 rounded-xl shadow-inner hidden border border-gray-600">
            <h2 class="text-2xl font-bold text-white mb-6">Manage Member Details</h2>
            <form id="member-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="member-id" class="block text-sm font-medium text-gray-300">Member ID</label>
                    <input
                        type="text"
                        id="member-id"
                        name="memberId"
                        class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white placeholder-gray-400"
                        placeholder="Unique Member ID"
                        required
                    />
                </div>
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-300">Member Name</label>
                    <input
                        type="text"
                        id="name"
                        name="name"
                        class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white placeholder-gray-400"
                        placeholder="Full Name"
                        required
                    />
                </div>
                <div>
                    <label for="phone-number" class="block text-sm font-medium text-gray-300">Phone Number</label>
                    <input
                        type="tel"
                        id="phone-number"
                        name="phoneNumber"
                        class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white placeholder-gray-400"
                        placeholder="e.g., 123-456-7890"
                    />
                </div>
                <div>
                    <label for="membershipType" class="block text-sm font-medium text-gray-300">Membership Type</label>
                    <select
                        id="membershipType"
                        name="membershipType"
                        class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white"
                        required
                    >
                        <option value="Monthly">Monthly</option>
                        <option value="Quarterly">Quarterly</option>
                        <option value="HalfYearly">Half Yearly</option>
                        <option value="Annual">Annual</option>
                    </select>
                </div>
                <div>
                    <label for="startDate" class="block text-sm font-medium text-gray-300">Start Date</label>
                    <input
                        type="date"
                        id="startDate"
                        name="startDate"
                        class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white"
                        required
                    />
                </div>
                <div>
                    <label for="dueDate" class="block text-sm font-medium text-gray-300">Calculated Due Date</label>
                    <input
                        type="date"
                        id="dueDate"
                        name="dueDate"
                        class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm bg-gray-900 text-gray-400 cursor-not-allowed"
                        readonly
                        required
                    />
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Member Photo</label>
                    <div class="flex flex-wrap items-center gap-3 mb-4">
                        <input type="file" id="photo-upload" accept="image/*" class="hidden">
                        <button type="button" id="upload-photo-btn" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-150 ease-in-out text-sm">
                            Upload Photo
                        </button>
                        <button type="button" id="take-photo-btn" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out text-sm">
                            Take Photo
                        </button>
                        <button type="button" id="switch-camera-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out text-sm hidden">
                            Switch Camera
                        </button>
                        <button type="button" id="clear-photo-btn" class="px-4 py-2 bg-gray-400 text-white font-semibold rounded-lg shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 transition duration-150 ease-in-out text-sm hidden">
                            Clear Photo
                        </button>
                    </div>
                    <div class="flex items-center space-x-4">
                        <img id="photo-preview" class="w-28 h-28 rounded-full object-cover border-2 border-gray-500 shadow-sm cursor-pointer" src="https://placehold.co/112x112/4a5568/cbd5e0?text=No+Photo" alt="Photo Preview">
                        <video id="camera-feed" class="w-28 h-28 rounded-full object-cover border-2 border-gray-500 shadow-sm hidden" autoplay playsinline></video>
                        <canvas id="camera-canvas" class="hidden"></canvas>
                    </div>
                    <a id="view-photo-link" class="text-indigo-400 hover:underline mt-2 cursor-pointer hidden" target="_blank">View Photo Preview</a>
                    <p class="text-xs text-gray-400 mt-2">Note: Photos are uploaded to Cloudinary. Deletion from app removes link, not image from Cloudinary.</p>
                </div>

                <div class="md:col-span-2 flex justify-end space-x-3 pt-4">
                    <button
                        type="submit"
                        id="submit-button"
                        class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out text-lg"
                    >
                        Add Member
                    </button>
                    <button
                        type="button"
                        id="cancel-edit-button"
                        class="px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-150 ease-in-out text-lg hidden"
                    >
                        Cancel Edit
                    </button>
                </div>
            </form>
        </div>

        <!-- Tab Content: Add Existing Member (New Form) -->
        <div id="content-add-existing" class="tab-content bg-gray-700 p-6 rounded-xl shadow-inner hidden border border-gray-600">
            <h2 class="text-2xl font-bold text-white mb-6">Add Existing Member</h2>
            <form id="existing-member-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="existing-member-id" class="block text-sm font-medium text-gray-300">Member ID</label>
                    <input
                        type="text"
                        id="existing-member-id"
                        name="memberId"
                        class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white placeholder-gray-400"
                        placeholder="Unique Member ID"
                        required
                    />
                </div>
                <div>
                    <label for="existing-name" class="block text-sm font-medium text-gray-300">Member Name</label>
                    <input
                        type="text"
                        id="existing-name"
                        name="name"
                        class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white placeholder-gray-400"
                        placeholder="Full Name"
                        required
                    />
                </div>
                <div>
                    <label for="existing-phone-number" class="block text-sm font-medium text-gray-300">Phone Number</label>
                    <input
                        type="tel"
                        id="existing-phone-number"
                        name="phoneNumber"
                        class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white placeholder-gray-400"
                        placeholder="e.g., 123-456-7890"
                    />
                </div>
                <div>
                    <label for="existing-membershipType" class="block text-sm font-medium text-gray-300">Membership Type</label>
                    <select
                        id="existing-membershipType"
                        name="membershipType"
                        class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white"
                        required
                    >
                        <option value="Monthly">Monthly</option>
                        <option value="Quarterly">Quarterly</option>
                        <option value="HalfYearly">Half Yearly</option>
                        <option value="Annual">Annual</option>
                    </select>
                </div>
                <div>
                    <label for="existing-startDate" class="block text-sm font-medium text-gray-300">Joining Date</label>
                    <input
                        type="date"
                        id="existing-startDate"
                        name="startDate"
                        class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white"
                        required
                    />
                </div>
                <div>
                    <label for="calculated-dueDate" class="block text-sm font-medium text-gray-300">Calculated Due Date</label>
                    <input
                        type="date"
                        id="calculated-dueDate"
                        name="dueDate"
                        class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm bg-gray-900 text-gray-400 cursor-not-allowed"
                        readonly
                        required
                    />
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Member Photo</label>
                    <div class="flex flex-wrap items-center gap-3 mb-4">
                        <input type="file" id="existing-photo-upload" accept="image/*" class="hidden">
                        <button type="button" id="existing-upload-photo-btn" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-150 ease-in-out text-sm">
                            Upload Photo
                        </button>
                        <button type="button" id="existing-take-photo-btn" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out text-sm">
                            Take Photo
                        </button>
                        <button type="button" id="existing-switch-camera-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out text-sm hidden">
                            Switch Camera
                        </button>
                        <button type="button" id="existing-clear-photo-btn" class="px-4 py-2 bg-gray-400 text-white font-semibold rounded-lg shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 transition duration-150 ease-in-out text-sm hidden">
                            Clear Photo
                        </button>
                    </div>
                    <div class="flex items-center space-x-4">
                        <img id="existing-photo-preview" class="w-28 h-28 rounded-full object-cover border-2 border-gray-500 shadow-sm cursor-pointer" src="https://placehold.co/112x112/4a5568/cbd5e0?text=No+Photo" alt="Photo Preview">
                        <video id="existing-camera-feed" class="w-28 h-28 rounded-full object-cover border-2 border-500 shadow-sm hidden" autoplay playsinline></video>
                        <canvas id="existing-camera-canvas" class="hidden"></canvas>
                    </div>
                    <a id="existing-view-photo-link" class="text-indigo-400 hover:underline mt-2 cursor-pointer hidden" target="_blank">View Photo Preview</a>
                    <p class="text-xs text-gray-400 mt-2">Note: Photos are uploaded to Cloudinary. Deletion from app removes link, not image from Cloudinary.</p>
                </div>

                <div class="md:col-span-2 flex justify-end pt-4">
                    <button
                        type="submit"
                        class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-150 ease-in-out text-lg"
                    >
                        Add Existing Member
                    </button>
                </div>
            </form>
        </div>

        <!-- Tab Content: Add Payment -->
        <div id="content-add-payment" class="tab-content bg-gray-700 p-6 rounded-xl shadow-inner hidden border border-gray-600">
            <h2 class="text-2xl font-bold text-white mb-6">Process Payment</h2>
            <form id="add-payment-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-2">
                    <label for="add-payment-member-search" class="block text-sm font-medium text-gray-300">Search Member</label>
                    <input
                        type="text"
                        id="add-payment-member-search"
                        class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white placeholder-gray-400"
                        placeholder="Type name or ID to search..."
                    />
                </div>
                <div>
                    <label for="add-payment-member-select" class="block text-sm font-medium text-gray-300">Select Member</label>
                    <select
                        id="add-payment-member-select"
                        class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white"
                        required
                    >
                        <option value="">-- Select a Member --</option>
                        <!-- Options populated by JavaScript -->
                    </select>
                </div>
                <div>
                    <label for="add-payment-current-dueDate" class="block text-sm font-medium text-gray-300">Current Due Date</label>
                    <input
                        type="text"
                        id="add-payment-current-dueDate"
                        class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm bg-gray-900 text-gray-400 cursor-not-allowed"
                        readonly
                    />
                </div>
                <div>
                    <label for="add-payment-membershipType" class="block text-sm font-medium text-gray-300">Payment Plan Type</label>
                    <select
                        id="add-payment-membershipType"
                        class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white"
                        required
                    >
                        <option value="Monthly">Monthly</option>
                        <option value="Quarterly">Quarterly</option>
                        <option value="HalfYearly">Half Yearly</option>
                        <option value="Annual">Annual</option>
                    </select>
                </div>
                <div>
                    <label for="add-payment-new-dueDate" class="block text-sm font-medium text-gray-300">New Due Date (Calculated)</label>
                    <input
                        type="text"
                        id="add-payment-new-dueDate"
                        class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm bg-gray-900 text-gray-400 cursor-not-allowed"
                        readonly
                    />
                </div>
                <div class="md:col-span-2 flex justify-end pt-4">
                    <button
                        type="submit"
                        class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out text-lg"
                    >
                        Process Payment
                    </button>
                </div>
            </form>
        </div>

        <!-- Tab Content: ID Card View (New Tab) -->
        <div id="content-id-card" class="tab-content bg-gray-700 p-6 rounded-xl shadow-inner hidden border border-gray-600">
            <h2 class="text-2xl font-bold text-white mb-6">Member ID Card View</h2>
            <div class="mb-6">
                <label for="id-card-member-search" class="block text-sm font-medium text-gray-300">Search Member</label>
                <input
                    type="text"
                    id="id-card-member-search"
                    class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white placeholder-gray-400"
                    placeholder="Type name or ID to search..."
                />
            </div>
            <div class="mb-6">
                <label for="id-card-member-select" class="block text-sm font-medium text-gray-300">Select Member</label>
                <select
                    id="id-card-member-select"
                    class="mt-1 block w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white"
                >
                    <option value="">-- Select a Member --</option>
                </select>
            </div>

            <div id="id-card-display" class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-600 flex flex-col md:flex-row items-center md:items-start gap-6 hidden">
                <div class="flex-shrink-0">
                    <img id="id-card-photo" class="id-card-photo" src="https://placehold.co/120x120/4a5568/cbd5e0?text=No+Photo" alt="Member Photo">
                </div>
                <div class="flex-grow text-white">
                    <h3 id="id-card-name" class="text-3xl font-bold mb-2"></h3>
                    <p class="text-gray-300 text-lg mb-1"><span class="font-semibold">Member ID:</span> <span id="id-card-member-id"></span></p>
                    <p class="text-gray-300 text-lg mb-1"><span class="font-semibold">Phone:</span> <span id="id-card-phone"></span></p>
                    <p class="text-gray-300 text-lg mb-1"><span class="font-semibold">Membership Type:</span> <span id="id-card-membership-type"></span></p>
                    <p class="text-gray-300 text-lg mb-1"><span class="font-semibold">Start Date:</span> <span id="id-card-start-date"></span></p>
                    <p class="text-gray-300 text-lg mb-1"><span class="font-semibold">Due Date:</span> <span id="id-card-due-date"></span></p>
                    <p class="text-gray-300 text-lg mb-1"><span class="font-semibold">Fee:</span> <span id="id-card-fee"></span></p>
                    <p class="text-gray-300 text-lg mb-1"><span class="font-semibold">Status:</span> <span id="id-card-status"></span></p>
                </div>
            </div>
            <p id="no-id-card-selected-message" class="text-gray-400 text-center p-6">Select a member to view their ID card.</p>
        </div>


        <!-- Search and Filter -->
        <div class="flex flex-col sm:flex-row gap-4 mb-6 mt-8 p-4 bg-gray-700 rounded-xl shadow-inner border border-gray-600">
            <input
                type="text"
                id="search-input"
                placeholder="Search by Name or Member ID..."
                class="flex-grow p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white placeholder-gray-400"
            />
            <select
                id="filter-status"
                class="p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-white"
            >
                <option value="All">All Statuses</option>
                <option value="Active">Active</option>
                <option value="Overdue">Overdue</option>
                <option value="Inactive">Inactive</option>
                <option value="Paid">Paid</option>
            </select>
        </div>

        <!-- Overdue Members List (Moved Up) -->
        <h2 class="text-2xl font-bold text-red-500 mb-4 mt-8">Overdue Members</h2>
        <div id="overdue-members-list-container" class="overflow-x-auto rounded-xl shadow-lg border border-red-800">
            <table class="min-w-full divide-y divide-red-800">
                <thead class="bg-red-900">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-red-200 uppercase tracking-wider">Photo</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-red-200 uppercase tracking-wider">Member ID</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-red-200 uppercase tracking-wider">Name</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-red-200 uppercase tracking-wider">Phone Number</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-red-200 uppercase tracking-wider">Type</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-red-200 uppercase tracking-wider">Start Date</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-red-200 uppercase tracking-wider">Due Date</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-red-200 uppercase tracking-wider">Fee</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-red-200 uppercase tracking-wider">Days Overdue</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-red-200 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="overdue-members-table-body" class="bg-gray-800 divide-y divide-gray-700">
                    <!-- Overdue member rows will be inserted here by JavaScript -->
                </tbody>
            </table>
            <p id="no-overdue-members-message" class="text-gray-400 text-center p-6 hidden">No members are currently overdue. Great job!</p>
        </div>

        <!-- Members List (Moved Down) -->
        <h2 class="text-2xl font-bold text-white mb-4 mt-8">Current Members</h2>
        <div id="members-list-container" class="overflow-x-auto rounded-xl shadow-lg border border-gray-700">
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-indigo-900">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-indigo-200 uppercase tracking-wider">Photo</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-indigo-200 uppercase tracking-wider">Member ID</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-indigo-200 uppercase tracking-wider">Name</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-indigo-200 uppercase tracking-wider">Phone Number</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-indigo-200 uppercase tracking-wider">Type</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-indigo-200 uppercase tracking-wider">Start Date</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-indigo-200 uppercase tracking-wider">Due Date</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-indigo-200 uppercase tracking-wider">Fee</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-indigo-200 uppercase tracking-wider">Days Left</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-indigo-200 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="members-table-body" class="bg-gray-800 divide-y divide-gray-700">
                    <!-- Member rows will be inserted here by JavaScript -->
                </tbody>
            </table>
            <p id="no-members-message" class="text-gray-400 text-center p-6 hidden">No members found. Add a new member above!</p>
        </div>


        <!-- Credits -->
        <div class="mt-10 text-center text-gray-500 text-sm">
            Built with ❤️ by <span class="font-semibold text-indigo-400">Sushant Singh</span>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95 opacity-0 border border-gray-700" id="delete-modal-content">
            <h3 class="text-2xl font-bold text-white mb-4 text-center">Confirm Deletion</h3>
            <p class="text-gray-300 mb-8 text-center">
                Are you sure you want to delete member "<span id="member-to-delete-name" class="font-semibold text-indigo-400"></span>"? This action cannot be undone.
            </p>
            <div class="flex justify-center space-x-4">
                <button
                    id="cancel-delete-button"
                    class="px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition duration-150 ease-in-out shadow-md"
                >
                    Cancel
                </button>
                <button
                    id="confirm-delete-button"
                    class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 ease-in-out shadow-md"
                >
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Photo View Modal -->
    <div id="photo-view-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center z-50 hidden">
        <div id="photo-view-content" class="relative bg-gray-800 p-4 rounded-xl shadow-2xl max-w-2xl max-h-[90vh] w-full flex flex-col items-center justify-center transform transition-all duration-300 scale-95 opacity-0 border border-gray-700">
            <button id="close-photo-modal-btn" class="absolute top-3 right-3 text-gray-400 hover:text-white text-3xl font-bold focus:outline-none">
                &times;
            </button>
            <img id="enlarged-photo" class="max-w-full max-h-[calc(90vh-60px)] object-contain rounded-lg shadow-md" src="" alt="Enlarged Member Photo">
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // Global variables for Firebase instances
        let app;
        let db;
        let auth;
        let currentUserId = null;
        let editingMemberId = null;
        let memberToDelete = null;
        let allMembers = []; // To store all members fetched from Firestore
        let currentPhotoBase64 = null; // To store the base64 for temporary preview or existing photo URL for main form
        let existingPhotoBase64 = null; // To store the base64 for temporary preview or existing photo URL for existing member form

        let currentCameraFacingMode = 'user'; // 'user' for front, 'environment' for back

        // Hardcoded default plan amounts
        const defaultPlanAmounts = {
            Monthly: 700.00,
            Quarterly: 2000.00,
            HalfYearly: 3500.00,
            Annual: 6000.00
        };

        // The in-app password
        const APP_PASSWORD = "2003";

        // Firebase project details provided by the user
        const firebaseConfig = {
            apiKey: "AIzaSyA1cOHWVufQV6ruZv3LmgdqfRNPGjyzsEI",
            authDomain: "alpha-core-fitness-data.firebaseapp.com",
            projectId: "alpha-core-fitness-data",
            storageBucket: "alpha-core-fitness-data.firebasestorage.app",
            messagingSenderId: "311733734225",
            appId: "1:311733734225:web:697ef2dc197ebb2e662170",
            measurementId: "G-C5EKPN2K2J"
        };

        // Cloudinary Configuration
        const CLOUDINARY_CLOUD_NAME = 'dbm2s6xd2';
        const CLOUDINARY_UPLOAD_PRESET = 'gym_member_photos_preset';

        // Access global appId and initialAuthToken provided by the environment
        const envAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // DOM Elements for Authentication
        const authSection = document.getElementById('auth-section');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const signInButton = document.getElementById('signin-button');
        const signUpButton = document.getElementById('signup-button');
        const anonymousSignInButton = document.getElementById('anonymous-signin-button');

        // DOM Elements for In-App Password Entry
        const passwordEntryModal = document.getElementById('password-entry-modal');
        const appPasswordInput = document.getElementById('app-password-input');
        const submitAppPasswordBtn = document.getElementById('submit-app-password');


        // DOM Elements for Main App
        const mainAppSection = document.getElementById('main-app-section');
        const signOutButton = document.getElementById('signout-button');

        // Tab Buttons and Content
        const tabManageMember = document.getElementById('tab-manage-member');
        const tabAddExisting = document.getElementById('tab-add-existing');
        const tabAddPayment = document.getElementById('tab-add-payment'); // Renamed ID and text
        const tabIdCard = document.getElementById('tab-id-card');
        const contentManageMember = document.getElementById('content-manage-member');
        const contentAddExisting = document.getElementById('content-add-existing');
        const contentAddPayment = document.getElementById('content-add-payment'); // Renamed ID
        const contentIdCard = document.getElementById('content-id-card');

        // Main Member Form (Manage Member Details)
        const memberForm = document.getElementById('member-form');
        const memberIdInput = document.getElementById('member-id');
        const nameInput = document.getElementById('name');
        const phoneNumberInput = document.getElementById('phone-number');
        const membershipTypeInput = document.getElementById('membershipType');
        const startDateInput = document.getElementById('startDate');
        const dueDateInput = document.getElementById('dueDate');
        const submitButton = document.getElementById('submit-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');

        // Existing Member Form
        const existingMemberForm = document.getElementById('existing-member-form');
        const existingMemberIdInput = document.getElementById('existing-member-id');
        const existingNameInput = document.getElementById('existing-name');
        const existingPhoneNumberInput = document.getElementById('existing-phone-number');
        const existingMembershipTypeInput = document.getElementById('existing-membershipType');
        const existingStartDateInput = document.getElementById('existing-startDate');
        const calculatedDueDateInput = document.getElementById('calculated-dueDate');

        // Add Payment Form (formerly Advance Payment)
        const addPaymentForm = document.getElementById('add-payment-form'); // Renamed ID
        const addPaymentMemberSearchInput = document.getElementById('add-payment-member-search'); // Renamed ID
        const addPaymentMemberSelect = document.getElementById('add-payment-member-select'); // Renamed ID
        const addPaymentCurrentDueDateInput = document.getElementById('add-payment-current-dueDate'); // Renamed ID
        const addPaymentMembershipTypeInput = document.getElementById('add-payment-membershipType'); // Renamed ID
        const addPaymentNewDueDateInput = document.getElementById('add-payment-new-dueDate'); // Renamed ID

        // ID Card Tab Elements
        const idCardMemberSearchInput = document.getElementById('id-card-member-search');
        const idCardMemberSelect = document.getElementById('id-card-member-select');
        const idCardDisplay = document.getElementById('id-card-display');
        const idCardPhoto = document.getElementById('id-card-photo');
        const idCardName = document.getElementById('id-card-name');
        const idCardMemberId = document.getElementById('id-card-member-id');
        const idCardPhone = document.getElementById('id-card-phone');
        const idCardMembershipType = document.getElementById('id-card-membership-type');
        const idCardStartDate = document.getElementById('id-card-start-date');
        const idCardDueDate = document.getElementById('id-card-due-date');
        const idCardFee = document.getElementById('id-card-fee');
        const idCardStatus = document.getElementById('id-card-status');
        const noIdCardSelectedMessage = document.getElementById('no-id-card-selected-message');


        // Other DOM Elements
        const messageDisplay = document.getElementById('message-display');
        const userIdDisplay = document.getElementById('user-id-display');
        const userIdValue = document.getElementById('user-id-value');
        const searchInput = document.getElementById('search-input');
        const filterStatusSelect = document.getElementById('filter-status');
        const membersTableBody = document.getElementById('members-table-body');
        const noMembersMessage = document.getElementById('no-members-message');
        const deleteModal = document.getElementById('delete-modal');
        const deleteModalContent = document.getElementById('delete-modal-content');
        const memberToDeleteName = document.getElementById('member-to-delete-name');
        const cancelDeleteButton = document.getElementById('cancel-delete-button');
        const confirmDeleteButton = document.getElementById('confirm-delete-button');

        // Overdue Members specific DOM elements
        const overdueMembersTableBody = document.getElementById('overdue-members-table-body');
        const noOverdueMembersMessage = document.getElementById('no-overdue-members-message');

        // Date & Time Display elements
        const currentTimeDisplay = document.getElementById('current-time');
        const currentDateDisplay = document.getElementById('current-date');
        const currentDayDisplay = document.getElementById('current-day');


        // Photo related DOM elements for Manage Member Details tab
        const photoUploadInput = document.getElementById('photo-upload');
        const uploadPhotoBtn = document.getElementById('upload-photo-btn');
        const takePhotoBtn = document.getElementById('take-photo-btn');
        const switchCameraBtn = document.getElementById('switch-camera-btn');
        const clearPhotoBtn = document.getElementById('clear-photo-btn');
        const photoPreview = document.getElementById('photo-preview');
        const cameraFeed = document.getElementById('camera-feed');
        const cameraCanvas = document.getElementById('camera-canvas');
        const viewPhotoLink = document.getElementById('view-photo-link');
        let cameraStream = null; // To hold the camera stream for main tab

        // Photo related DOM elements for Add Existing Member tab
        const existingPhotoUploadInput = document.getElementById('existing-photo-upload');
        const existingUploadPhotoBtn = document.getElementById('existing-upload-photo-btn');
        const existingTakePhotoBtn = document.getElementById('existing-take-photo-btn');
        const existingSwitchCameraBtn = document.getElementById('existing-switch-camera-btn');
        const existingClearPhotoBtn = document.getElementById('existing-clear-photo-btn');
        const existingPhotoPreview = document.getElementById('existing-photo-preview');
        const existingCameraFeed = document.getElementById('existing-camera-feed');
        const existingCameraCanvas = document.getElementById('existing-camera-canvas');
        const existingViewPhotoLink = document.getElementById('existing-view-photo-link');
        let existingCameraStream = null; // To hold the camera stream for existing member tab


        // Photo View Modal elements
        const photoViewModal = document.getElementById('photo-view-modal');
        const enlargedPhoto = document.getElementById('enlarged-photo');
        const closePhotoModalBtn = document.getElementById('close-photo-modal-btn');
        const photoViewContent = document.getElementById('photo-view-content');

        // Double tap detection variables
        let lastTap = 0;
        const TAP_THRESHOLD = 300; // milliseconds

        /**
         * Formats a date string from YYYY-MM-DD to DD-MM-YYYY.
         * @param {string} dateString - The date string in YYYY-MM-DD format.
         * @returns {string} The date string in DD-MM-YYYY format, or original if invalid.
         */
        function formatToDDMMYYYY(dateString) {
            if (!dateString) return 'N/A';
            const parts = dateString.split('-');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1]}-${parts[0]}`;
            }
            return dateString; // Return original if format is unexpected
        }

        /**
         * Displays a message to the user.
         * @param {string} text - The message text.
         * @param {'success'|'error'} type - The type of message (success or error).
         */
        function showMessage(text, type) {
            messageDisplay.textContent = text;
            messageDisplay.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'opacity-0');
            if (type === 'success') {
                messageDisplay.classList.add('bg-green-500');
            } else {
                messageDisplay.classList.add('bg-red-500');
            }
            messageDisplay.classList.add('block', 'opacity-100'); // Show with transition

            setTimeout(() => {
                messageDisplay.classList.remove('opacity-100'); // Start fade out
                messageDisplay.classList.add('opacity-0');
                setTimeout(() => {
                    messageDisplay.classList.add('hidden'); // Hide after fade
                    messageDisplay.classList.remove('bg-green-500', 'bg-red-500');
                    messageDisplay.textContent = '';
                }, 300); // Match transition duration
            }, 3000); // Message visible for 3 seconds
        }

        /**
         * Checks if a due date is overdue.
         * @param {string} dueDateString - The due date in 'YYYY-MM-DD' format.
         * @returns {boolean} True if the due date is in the past, false otherwise.
         */
        function isOverdue(dueDateString) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today to start of day
            const due = new Date(dueDateString);
            due.setHours(0, 0, 0, 0); // Normalize due date to start of day
            return due < today;
        }

        /**
         * Calculates the number of days left until the due date.
         * @param {string} dueDateString - The due date in 'YYYY-MM-DD' format.
         * @returns {string} Formatted string indicating days left, "Overdue", or "Due Today".
         */
        function getDaysLeft(dueDateString) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dueDate = new Date(dueDateString);
            dueDate.setHours(0, 0, 0, 0);

            const diffTime = dueDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                return 'Overdue';
            } else if (diffDays === 0) {
                return 'Due Today';
            } else {
                return `${diffDays} days`;
            }
        }

        /**
         * Adds a duration (based on membership type) to a given date.
         * Handles month-end overflows correctly.
         * @param {string} baseDateString - The date string (YYYY-MM-DD) to add duration to.
         * @param {string} membershipType - The type of membership (Monthly, Quarterly, HalfYearly, Annual).
         * @returns {string} The new date string in 'YYYY-MM-DD' format.
         */
        function addDurationToDate(baseDateString, membershipType) {
            if (!baseDateString) return '';

            const baseDate = new Date(baseDateString + 'T00:00:00'); // Ensure consistent timezone
            let newDate = new Date(baseDate);

            // Store original day to handle month-end rollovers
            const originalDay = newDate.getDate();

            switch (membershipType) {
                case 'Monthly':
                    newDate.setMonth(newDate.getMonth() + 1);
                    break;
                case 'Quarterly':
                    newDate.setMonth(newDate.getMonth() + 3);
                    break;
                case 'HalfYearly':
                    newDate.setMonth(newDate.getMonth() + 6);
                    break;
                case 'Annual':
                    newDate.setFullYear(newDate.getFullYear() + 1);
                    break;
                default:
                    return '';
            }

            // If the original day was the last day of the month, and the new month has fewer days,
            // set the day to the last day of the new month.
            if (originalDay !== newDate.getDate()) {
                newDate.setDate(0);
            }

            const year = newDate.getFullYear();
            const month = String(newDate.getMonth() + 1).padStart(2, '0');
            const day = String(newDate.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * Calculates a new due date for an overdue member after payment.
         * @param {string} selectedPlanType - The new membership plan type.
         * @param {string} currentDueDateString - The member's current overdue due date (YYYY-MM-DD).
         * @returns {string} The new due date in YYYY-MM-DD format.
         */
        function calculateOverduePaidDueDate(selectedPlanType, currentDueDateString) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const overdueDate = new Date(currentDueDateString);
            overdueDate.setHours(0, 0, 0, 0);

            // Calculate days overdue
            const diffTimeOverdue = today.getTime() - overdueDate.getTime();
            const daysOverdue = Math.floor(diffTimeOverdue / (1000 * 60 * 60 * 24));

            // Determine plan duration in months for calculation
            let planMonths = 0;
            switch (selectedPlanType) {
                case 'Monthly': planMonths = 1; break;
                case 'Quarterly': planMonths = 3; break;
                case 'HalfYearly': planMonths = 6; break;
                case 'Annual': planMonths = 12; break;
            }

            // Calculate the new due date: today + plan duration (in months) - days overdue
            let newCalculatedDate = new Date(today);
            newCalculatedDate.setMonth(newCalculatedDate.getMonth() + planMonths);

            // Subtract days overdue from this new date
            newCalculatedDate.setDate(newCalculatedDate.getDate() - daysOverdue);

            const year = newCalculatedDate.getFullYear();
            const month = String(newCalculatedDate.getMonth() + 1).padStart(2, '0');
            const day = String(newCalculatedDate.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }


        /**
         * Opens the photo view modal with the given image URL.
         * @param {string} imageUrl - The URL of the image to display.
         */
        function openPhotoModal(imageUrl) {
            // Check if the image is a placeholder before opening
            if (imageUrl && !imageUrl.includes("placehold.co")) {
                enlargedPhoto.src = imageUrl;
                photoViewModal.classList.remove('hidden');
                photoViewModal.classList.add('flex');
            } else {
                showMessage('No photo available to enlarge.', 'error');
            }
        }

        /**
         * Closes the photo view modal.
         */
        function closePhotoModal() {
            photoViewModal.classList.remove('flex');
            photoViewModal.classList.add('hidden');
            enlargedPhoto.src = ''; // Clear image source
        }

        /**
         * Attaches double-tap/click event listeners to a photo element.
         * @param {HTMLElement} photoElement - The image element to attach listeners to.
         */
        function addPhotoEnlargeListeners(photoElement) {
            // Double click for desktop to open modal
            photoElement.addEventListener('dblclick', (e) => {
                openPhotoModal(e.target.src);
            });

            // Double tap for mobile to open modal
            let lastTouchEndTime = 0;
            photoElement.addEventListener('touchend', function(event) {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTouchEndTime;

                // Check for double tap within threshold
                if (tapLength < TAP_THRESHOLD && tapLength > 0) {
                    event.preventDefault(); // Prevent default browser behavior (e.g., zoom)
                    openPhotoModal(this.src);
                }
                lastTouchEndTime = currentTime;
            });
        }

        /**
         * Uploads an image file or data URL to Cloudinary.
         * @param {File|string} fileOrDataUrl - The File object or base64 data URL to upload.
         * @returns {Promise<string|null>} The secure Cloudinary URL, or null if upload fails.
         */
        async function uploadImageToCloudinary(fileOrDataUrl) {
            if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET) {
                showMessage('Cloudinary credentials are not set. Please update CLOUDINARY_CLOUD_NAME and CLOUDINARY_UPLOAD_PRESET in the code.', 'error');
                return null;
            }

            const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
            const formData = new FormData();
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

            if (typeof fileOrDataUrl === 'string' && fileOrDataUrl.startsWith('data:')) {
                // It's a base64 data URL
                formData.append('file', fileOrDataUrl);
            } else if (fileOrDataUrl instanceof File) {
                // It's a File object
                formData.append('file', fileOrDataUrl);
            } else {
                showMessage('Invalid file type for Cloudinary upload.', 'error');
                return null;
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Cloudinary upload error:', errorData);
                    showMessage(`Cloudinary upload failed: ${errorData.error?.message || response.statusText}`, 'error');
                    return null;
                }

                const data = await response.json();
                return data.secure_url; // This is the public URL of the uploaded image
            } catch (error) {
                console.error('Network or Cloudinary API error:', error);
                showMessage('Failed to upload photo to Cloudinary. Check your network and Cloudinary settings.', 'error');
                return null;
            }
        }


        /**
         * Renders the list of members in the table.
         * Applies search and filter criteria.
         */
        function renderMembers() {
            membersTableBody.innerHTML = ''; // Clear existing current members rows
            overdueMembersTableBody.innerHTML = ''; // Clear existing overdue members rows

            const searchTerm = searchInput.value.toLowerCase();
            const filterStatus = filterStatusSelect.value;

            const filteredAndSortedMembers = allMembers.filter(member => {
                const matchesSearch = (member.name && member.name.toLowerCase().includes(searchTerm)) ||
                                      (member.memberId && member.memberId.toLowerCase().includes(searchTerm)) ||
                                      (member.phoneNumber && member.phoneNumber.toLowerCase().includes(searchTerm)) ||
                                      (member.membershipType && member.membershipType.toLowerCase().includes(searchTerm));
                const matchesStatus = filterStatus === 'All' || (member.status && member.status === filterStatus);
                return matchesSearch && matchesStatus;
            }).sort((a, b) => {
                // Sort by due date, overdue first
                const dateA = new Date(a.dueDate);
                const dateB = new Date(b.dueDate);
                return dateA - dateB;
            });


            let hasOverdueMembers = false;

            if (filteredAndSortedMembers.length === 0) {
                noMembersMessage.classList.remove('hidden');
                noOverdueMembersMessage.classList.remove('hidden'); // Also show for overdue if no members
                membersTableBody.innerHTML = '';
            } else {
                noMembersMessage.classList.add('hidden');
                filteredAndSortedMembers.forEach(member => {
                    const row = membersTableBody.insertRow();
                    const overdueClass = isOverdue(member.dueDate) && member.status !== 'Paid' ? 'bg-red-900' : 'bg-gray-800'; // Darker overdue row
                    row.className = `${overdueClass} hover:bg-gray-700 transition-colors duration-150 ease-in-out`; // Hover effect

                    const daysLeftText = getDaysLeft(member.dueDate);
                    const nameClass = member.status === 'Inactive' ? 'line-through-name' : '';
                    const photoSrc = member.photoURL || "https://placehold.co/40x40/4a5568/cbd5e0?text=👤"; // Use actual photo or generic placeholder

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-200">
                            <a href="${photoSrc}" target="_blank" class="block">
                                <img src="${photoSrc}" alt="Member Photo" class="member-photo cursor-pointer" onerror="this.onerror=null;this.src='https://placehold.co/40x40/4a5568/cbd5e0?text=👤';">
                            </a>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-200">${member.memberId || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-200 ${nameClass}">${member.name || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${member.phoneNumber || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${member.membershipType || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formatToDDMMYYYY(member.startDate) || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                            ${formatToDDMMYYYY(member.dueDate) || 'N/A'}
                            ${isOverdue(member.dueDate) && member.status !== 'Paid' ? `
                                <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-700 text-red-100">
                                    Overdue
                                </span>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">$${(member.feeAmount || 0).toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                            ${daysLeftText === 'Overdue' ? `
                                <span class="text-red-500 font-semibold">${daysLeftText}</span>
                            ` : daysLeftText === 'Due Today' ? `
                                <span class="text-yellow-500 font-semibold">${daysLeftText}</span>
                            ` : daysLeftText}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex items-center space-x-2">
                            <button data-id="${member.id}" class="edit-btn text-blue-400 hover:text-blue-200" title="Edit Member">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-3.586 3.586l-4 4V14h4l4-4L10 7.172z" />
                                </svg>
                            </button>
                            ${member.status === 'Active' || member.status === 'Overdue' ? `
                                <button data-id="${member.id}" class="pause-btn text-yellow-500 hover:text-yellow-300" title="Pause Membership">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd" />
                                    </svg>
                                </button>
                            ` : `
                                <button data-id="${member.id}" class="activate-btn text-green-500 hover:text-green-300" title="Activate Membership">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                                    </svg>
                                </button>
                            `}
                            <button data-id="${member.id}" class="delete-btn text-red-500 hover:text-red-300" title="Delete Member">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                    <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clipRule="evenodd" />
                                </svg>
                            </button>
                        </td>
                    `;
                    // Attach double-tap/click listener to the photo in the row (on the <img> inside <a>)
                    const photoElementInRow = row.querySelector('.member-photo');
                    if (photoElementInRow) {
                        addPhotoEnlargeListeners(photoElementInRow);
                    }


                    // Populate Overdue Members table
                    if (isOverdue(member.dueDate) && member.status !== 'Paid') {
                        hasOverdueMembers = true;
                        const overdueRow = overdueMembersTableBody.insertRow();
                        const today = new Date();
                        today.setHours(0,0,0,0);
                        const dueDate = new Date(member.dueDate);
                        dueDate.setHours(0,0,0,0);
                        const daysOverdue = Math.ceil(Math.abs(today - dueDate) / (1000 * 60 * 60 * 24));


                        overdueRow.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-200">
                                <a href="${photoSrc}" target="_blank" class="block">
                                    <img src="${photoSrc}" alt="Member Photo" class="member-photo cursor-pointer" onerror="this.onerror=null;this.src='https://placehold.co/40x40/4a5568/cbd5e0?text=👤';">
                                </a>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-200">${member.memberId || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-200">${member.name || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${member.phoneNumber || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${member.membershipType || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formatToDDMMYYYY(member.startDate) || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formatToDDMMYYYY(member.dueDate) || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">$${(member.feeAmount || 0).toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-red-500 font-semibold">${daysOverdue} days</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex items-center space-x-2">
                                <button data-id="${member.id}" class="edit-btn text-blue-400 hover:text-blue-200" title="Edit Member">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-3.586 3.586l-4 4V14h4l4-4L10 7.172z" />
                                    </svg>
                                </button>
                                <button data-id="${member.id}" class="pause-btn text-yellow-500 hover:text-yellow-300" title="Pause Membership">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd" />
                                    </svg>
                                </button>
                                <button data-id="${member.id}" class="delete-btn text-red-500 hover:text-red-300" title="Delete Member">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                        <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clipRule="evenodd" />
                                    </svg>
                                </button>
                            </td>
                        `;
                        // Attach double-tap/click listener to the photo in the row (on the <img> inside <a>)
                        const photoElementInOverdueRow = overdueRow.querySelector('.member-photo');
                        if (photoElementInOverdueRow) {
                            addPhotoEnlargeListeners(photoElementInOverdueRow);
                        }
                    }
                });

                // Attach event listeners to new buttons (for both tables)
                document.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        const member = allMembers.find(m => m.id === id);
                        if (member) {
                            handleEdit(member);
                        }
                    });
                });
                document.querySelectorAll('.pause-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        handlePauseToggle(id, 'Inactive');
                    });
                });
                document.querySelectorAll('.activate-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        handlePauseToggle(id, 'Active');
                    });
                });
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        const member = allMembers.find(m => m.id === id);
                        if (member) {
                            confirmDelete(member);
                        }
                    });
                });
            }

            if (hasOverdueMembers) {
                noOverdueMembersMessage.classList.add('hidden');
            } else {
                noOverdueMembersMessage.classList.remove('hidden');
            }
        }

        /**
         * Clears the main member form inputs and photo preview.
         */
        function clearMainForm() {
            memberIdInput.value = ''; // Clear Member ID
            nameInput.value = '';
            phoneNumberInput.value = ''; // Clear Phone Number
            membershipTypeInput.value = 'Monthly';
            startDateInput.value = '';
            dueDateInput.value = ''; // Clear calculated due date
            editingMemberId = null;
            submitButton.textContent = 'Add Member';
            cancelEditButton.classList.add('hidden');
            currentPhotoBase64 = null; // Clear the temporary photo
            photoPreview.src = "https://placehold.co/112x112/4a5568/cbd5e0?text=No+Photo";
            clearPhotoBtn.classList.add('hidden');
            switchCameraBtn.classList.add('hidden'); // Hide switch camera button
            photoUploadInput.value = ''; // Clear file input
            stopCamera(cameraFeed, cameraStream); // Stop camera if active for main form
            viewPhotoLink.classList.add('hidden'); // Hide the photo link
            viewPhotoLink.href = '#'; // Reset href
        }

        /**
         * Clears the existing member form inputs and photo preview.
         */
        function clearExistingMemberForm() {
            existingMemberIdInput.value = ''; // Clear Existing Member ID
            existingNameInput.value = '';
            existingPhoneNumberInput.value = ''; // Clear Existing Phone Number
            existingMembershipTypeInput.value = 'Monthly';
            existingStartDateInput.value = '';
            calculatedDueDateInput.value = '';
            existingPhotoBase64 = null; // Clear the temporary photo
            existingPhotoPreview.src = "https://placehold.co/112x112/4a5568/cbd5e0?text=No+Photo";
            existingClearPhotoBtn.classList.add('hidden');
            existingSwitchCameraBtn.classList.add('hidden'); // Hide switch camera button
            existingPhotoUploadInput.value = ''; // Clear file input
            stopCamera(existingCameraFeed, existingCameraStream); // Stop camera if active for existing form
            existingViewPhotoLink.classList.add('hidden'); // Hide the photo link
            existingViewPhotoLink.href = '#'; // Reset href
        }

        /**
         * Clears the add payment form inputs.
         */
        function clearAddPaymentForm() { // Renamed function
            addPaymentMemberSearchInput.value = ''; // Clear search input
            addPaymentMemberSelect.innerHTML = '<option value="">-- Select a Member --</option>'; // Clear and reset options
            addPaymentCurrentDueDateInput.value = '';
            addPaymentMembershipTypeInput.value = 'Monthly';
            addPaymentNewDueDateInput.value = '';
        }

        /**
         * Clears the ID card display.
         */
        function clearIdCardDisplay() {
            idCardMemberSearchInput.value = ''; // Clear search input
            idCardMemberSelect.innerHTML = '<option value="">-- Select a Member --</option>'; // Clear and reset options
            idCardDisplay.classList.add('hidden');
            noIdCardSelectedMessage.classList.remove('hidden');
            idCardPhoto.src = "https://placehold.co/120x120/4a5568/cbd5e0?text=No+Photo";
            idCardName.textContent = '';
            idCardMemberId.textContent = '';
            idCardPhone.textContent = '';
            idCardMembershipType.textContent = '';
            idCardStartDate.textContent = '';
            idCardDueDate.textContent = '';
            idCardFee.textContent = '';
            idCardStatus.textContent = '';
        }

        /**
         * Populates the main form with member data for editing.
         * @param {object} member - The member object to edit.
         */
        function handleEdit(member) {
            // Switch to the "Manage Member Details" tab
            showTab('manage-member');

            memberIdInput.value = member.memberId || ''; // Populate Member ID
            nameInput.value = member.name;
            phoneNumberInput.value = member.phoneNumber || ''; // Populate Phone Number
            membershipTypeInput.value = member.membershipType;
            startDateInput.value = member.startDate;
            // When editing, the dueDate will be recalculated based on startDate and membershipType
            dueDateInput.value = addDurationToDate(member.startDate, membershipTypeInput.value); // Use form's membership type
            editingMemberId = member.id;
            submitButton.textContent = 'Update Member';
            cancelEditButton.classList.remove('hidden');

            // Set photo preview to existing photo or default
            if (member.photoURL) {
                photoPreview.src = member.photoURL;
                currentPhotoBase64 = member.photoURL; // Treat existing URL as current "base64" for simpler logic
                clearPhotoBtn.classList.remove('hidden');
                viewPhotoLink.href = member.photoURL;
                viewPhotoLink.textContent = 'View Permanent Photo';
                viewPhotoLink.classList.remove('hidden');
            } else {
                photoPreview.src = "https://placehold.co/112x112/4a5568/cbd5e0?text=No+Photo";
                currentPhotoBase64 = null;
                clearPhotoBtn.classList.add('hidden');
                viewPhotoLink.classList.add('hidden');
                viewPhotoLink.href = '#';
            }
            photoUploadInput.value = ''; // Clear file input
            stopCamera(cameraFeed, cameraStream); // Stop camera if active
            switchCameraBtn.classList.add('hidden'); // Hide switch camera button when editing
        }

        /**
         * Handles pausing/activating a member's membership.
         * @param {string} memberId - The ID of the member to update.
         * @param {string} newStatus - The new status to set ('Active' or 'Inactive').
         */
        async function handlePauseToggle(memberId, newStatus) {
            if (!db || !currentUserId) {
                showMessage('Database not ready or user not authenticated. Please sign in.', 'error');
                return;
            }

            try {
                const memberDocRef = doc(db, `artifacts/${envAppId}/public/data/gymMembers`, memberId);
                await updateDoc(memberDocRef, {
                    status: newStatus,
                    updatedAt: serverTimestamp(),
                    updatedBy: currentUserId,
                });
                showMessage(`Member status updated to '${newStatus}' successfully!`, 'success');
            } catch (error) {
                console.error("Error updating member status:", error);
                showMessage('Failed to update member status. Please try again.', 'error');
            }
        }

        /**
         * Displays the delete confirmation modal.
         * @param {object} member - The member object to be deleted.
         */
        function confirmDelete(member) {
            memberToDelete = member;
            memberToDeleteName.textContent = member.name || member.memberId || 'this member';
            deleteModal.classList.remove('hidden');
            // Add scale and opacity for transition
            setTimeout(() => {
                deleteModalContent.classList.remove('scale-95', 'opacity-0');
                deleteModalContent.classList.add('scale-100', 'opacity-100');
            }, 10); // Small delay to allow 'hidden' to apply first
        }

        /**
         * Handles the deletion of a member from Firestore.
         * Note: Photo deletion from Cloudinary is not handled client-side for security.
         */
        async function handleDelete() {
            if (!db || !memberToDelete) {
                showMessage('Database not ready or no member selected for deletion.', 'error');
                return;
            }

            try {
                // Delete member document from Firestore
                await deleteDoc(doc(db, `artifacts/${envAppId}/public/data/gymMembers`, memberToDelete.id));

                showMessage('Member deleted successfully! (Note: Associated photo on Cloudinary is not deleted from the app for security reasons.)', 'success');
                deleteModal.classList.add('hidden');
                deleteModalContent.classList.add('scale-95', 'opacity-0'); // Reset for next time
                memberToDelete = null;
            } catch (error) {
                console.error("Error deleting member:", error);
                showMessage('Failed to delete member. Please try again.', 'error');
            }
        }

        /**
         * Starts the camera feed for a given video element and updates related UI.
         * @param {HTMLVideoElement} videoElement - The video element to display the camera feed.
         * @param {string} facingMode - 'user' for front, 'environment' for back camera.
         * @returns {Promise<MediaStream>} The camera stream.
         */
        async function startCamera(videoElement, facingMode) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: facingMode } });
                videoElement.srcObject = stream;
                videoElement.classList.remove('hidden');
                // Show switch camera button only if camera started successfully
                if (videoElement === cameraFeed) {
                    switchCameraBtn.classList.remove('hidden');
                } else if (videoElement === existingCameraFeed) {
                    existingSwitchCameraBtn.classList.remove('hidden');
                }
                return stream;
            } catch (err) {
                console.error("Error accessing camera: ", err);
                showMessage('Could not access camera. Please ensure permissions are granted and no other app is using it.', 'error');
                videoElement.classList.add('hidden');
                // Hide switch camera button if camera fails to start
                if (videoElement === cameraFeed) {
                    switchCameraBtn.classList.add('hidden');
                } else if (videoElement === existingCameraFeed) {
                    existingSwitchCameraBtn.classList.add('hidden');
                }
                return null;
            }
        }

        /**
         * Stops the camera feed for a given video element and stream.
         * @param {HTMLVideoElement} videoElement - The video element whose stream to stop.
         * @param {MediaStream} stream - The camera stream to stop.
         */
        function stopCamera(videoElement, stream) {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
            }
            videoElement.classList.add('hidden');
            // Hide switch camera button when camera is stopped
            if (videoElement === cameraFeed) {
                switchCameraBtn.classList.add('hidden');
            } else if (videoElement === existingCameraFeed) {
                existingSwitchCameraBtn.classList.add('hidden');
            }
        }

        /**
         * Captures a photo from the camera feed and updates the photo preview.
         * @param {HTMLVideoElement} videoElement - The video element to capture from.
         * @param {HTMLCanvasElement} canvasElement - The canvas element to draw the image on.
         * @param {HTMLImageElement} previewElement - The image element to show the preview.
         * @returns {string|null} The base64 data URL of the captured photo, or null if capture failed.
         */
        function capturePhoto(videoElement, canvasElement, previewElement) {
            if (videoElement.srcObject && !videoElement.classList.contains('hidden')) {
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                const context = canvasElement.getContext('2d');
                context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
                const dataUrl = canvasElement.toDataURL('image/png');
                previewElement.src = dataUrl;
                return dataUrl;
            } else {
                showMessage('Camera is not active. Please start camera first.', 'error');
                return null;
            }
        }

        /**
         * Generic function to handle photo upload from file input.
         * @param {Event} event - The change event from the file input.
         * @param {HTMLImageElement} previewElement - The image element to show the preview.
         * @param {HTMLButtonElement} clearBtn - The clear photo button.
         * @param {HTMLButtonElement} switchCameraBtnElement - The switch camera button.
         * @param {HTMLVideoElement} cameraFeedElement - The camera feed element.
         * @param {MediaStream} cameraStreamVar - The camera stream variable to clear.
         * @param {HTMLAnchorElement} viewLinkElement - The link element to update.
         * @param {Function} setPhotoBase64Callback - Callback to set the appropriate currentPhotoBase64/existingPhotoBase64.
         */
        function handleFileUpload(event, previewElement, clearBtn, switchCameraBtnElement, cameraFeedElement, cameraStreamVar, viewLinkElement, setPhotoBase64Callback) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewElement.src = e.target.result;
                    setPhotoBase64Callback(e.target.result); // Set the correct base64 variable
                    clearBtn.classList.remove('hidden');
                    switchCameraBtnElement.classList.add('hidden'); // Hide switch camera button
                    stopCamera(cameraFeedElement, cameraStreamVar); // Stop camera if active
                    viewLinkElement.href = e.target.result;
                    viewLinkElement.textContent = 'View Photo Preview';
                    viewLinkElement.classList.remove('hidden');
                    previewElement.classList.remove('hidden'); // Ensure preview is visible
                };
                reader.readAsDataURL(file);
            }
        }

        /**
         * Generic function to handle taking a photo from camera.
         * @param {HTMLVideoElement} cameraFeedElement - The camera feed element.
         * @param {HTMLCanvasElement} cameraCanvasElement - The canvas element.
         * @param {HTMLImageElement} previewElement - The image preview element.
         * @param {HTMLButtonElement} clearBtn - The clear photo button.
         * @param {HTMLButtonElement} switchCameraBtnElement - The switch camera button.
         * @param {HTMLAnchorElement} viewLinkElement - The link element to update.
         * @param {Function} setPhotoBase64Callback - Callback to set the appropriate currentPhotoBase64/existingPhotoBase64.
         * @param {string} currentFacingModeParam - The current camera facing mode.
         * @param {Function} setCameraStreamCallback - Callback to set the camera stream variable.
         */
        async function handleTakePhoto(cameraFeedElement, cameraCanvasElement, previewElement, clearBtn, switchCameraBtnElement, viewLinkElement, setPhotoBase64Callback, currentFacingModeParam, setCameraStreamCallback) {
            if (cameraFeedElement.srcObject && !cameraFeedElement.classList.contains('hidden')) {
                // If camera is already active, capture photo
                const dataUrl = capturePhoto(cameraFeedElement, cameraCanvasElement, previewElement);
                if (dataUrl) {
                    setPhotoBase64Callback(dataUrl);
                    stopCamera(cameraFeedElement, cameraFeedElement.srcObject); // Stop camera after capture
                    setCameraStreamCallback(null); // Clear stream variable
                    clearBtn.classList.remove('hidden');
                    switchCameraBtnElement.classList.add('hidden'); // Hide switch camera button
                    viewLinkElement.href = dataUrl;
                    viewLinkElement.textContent = 'View Photo Preview';
                    viewLinkElement.classList.remove('hidden');
                    previewElement.classList.remove('hidden'); // Ensure preview is visible
                }
            } else {
                // Otherwise, start camera
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingModeParam } });
                if (stream) {
                    setCameraStreamCallback(stream);
                    cameraFeedElement.srcObject = stream;
                    cameraFeedElement.classList.remove('hidden');
                    previewElement.classList.add('hidden'); // Hide static preview while camera is on
                    viewLinkElement.classList.add('hidden'); // Hide link while camera is live
                    switchCameraBtnElement.classList.remove('hidden'); // Show switch camera button
                } else {
                    showMessage('Could not access camera. Please ensure permissions are granted and no other app is using it.', 'error');
                }
            }
        }


        /**
         * Generic function to handle clearing a photo.
         * @param {HTMLImageElement} previewElement - The image preview element.
         * @param {HTMLButtonElement} clearBtn - The clear photo button.
         * @param {HTMLButtonElement} switchCameraBtnElement - The switch camera button.
         * @param {HTMLInputElement} fileInput - The file input element.
         * @param {HTMLVideoElement} cameraFeedElement - The camera feed element.
         * @param {MediaStream} cameraStreamVar - The camera stream variable to clear.
         * @param {HTMLAnchorElement} viewLinkElement - The link element to update.
         * @param {Function} setPhotoBase64Callback - Callback to set the appropriate currentPhotoBase64/existingPhotoBase64.
         * @param {string|null} memberId - The ID of the member if editing, null if adding new.
         */
        async function handleClearPhoto(previewElement, clearBtn, switchCameraBtnElement, fileInput, cameraFeedElement, cameraStreamVar, viewLinkElement, setPhotoBase64Callback, memberId) {
            setPhotoBase64Callback(null);
            previewElement.src = "https://placehold.co/112x112/4a5568/cbd5e0?text=No+Photo";
            clearBtn.classList.add('hidden');
            switchCameraBtnElement.classList.add('hidden'); // Hide switch camera button
            fileInput.value = ''; // Clear file input
            stopCamera(cameraFeedElement, cameraStreamVar); // Stop camera if active
            viewLinkElement.classList.add('hidden'); // Hide the photo link
            viewLinkElement.href = '#'; // Reset href
            previewElement.classList.remove('hidden'); // Ensure preview is visible

            // If editing, and the user clears the photo, we need to ensure the photoURL is removed from Firestore
            if (memberId) {
                try {
                    await updateDoc(doc(db, `artifacts/${envAppId}/public/data/gymMembers`, memberId), { photoURL: null });
                    showMessage('Photo link removed from member. (Image remains on Cloudinary)', 'success');
                } catch (error) {
                    console.error("Error removing photoURL from Firestore:", error);
                    showMessage('Failed to clear photo link from member. Please try again.', 'error');
                }
            }
        }

        /**
         * Generic function to handle switching cameras.
         * @param {HTMLVideoElement} cameraFeedElement - The camera feed element.
         * @param {MediaStream} cameraStreamVar - The camera stream variable.
         * @param {Function} setCameraStreamCallback - Callback to set the camera stream variable.
         * @param {Function} setFacingModeCallback - Callback to set the current facing mode.
         * @param {string} currentFacingModeParam - The current camera facing mode.
         * @param {HTMLImageElement} previewElement - The image preview element.
         * @param {HTMLAnchorElement} viewLinkElement - The link element to update.
         */
        async function handleSwitchCamera(cameraFeedElement, cameraStreamVar, setCameraStreamCallback, setFacingModeCallback, currentFacingModeParam, previewElement, viewLinkElement) {
            stopCamera(cameraFeedElement, cameraStreamVar);
            const newFacingMode = currentFacingModeParam === 'user' ? 'environment' : 'user';
            setFacingModeCallback(newFacingMode); // Update the facing mode
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: newFacingMode } });
            if (stream) {
                setCameraStreamCallback(stream);
                cameraFeedElement.srcObject = stream;
                cameraFeedElement.classList.remove('hidden');
                previewElement.classList.add('hidden'); // Hide static preview while camera is on
                viewLinkElement.classList.add('hidden'); // Hide link while camera is live
            } else {
                showMessage('Could not switch camera. Please ensure permissions are granted.', 'error');
            }
        }


        /**
         * Populates the member select dropdown in the Add Payment tab.
         * Filters based on search input.
         */
        function populateAddPaymentMemberSelect(searchTerm = '') { // Renamed function
            addPaymentMemberSelect.innerHTML = '<option value="">-- Select a Member --</option>';
            const lowerCaseSearchTerm = searchTerm.toLowerCase();

            const filteredMembers = allMembers.filter(member =>
                (member.name && member.name.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (member.memberId && member.memberId.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (member.phoneNumber && member.phoneNumber.toLowerCase().includes(lowerCaseSearchTerm))
            );

            filteredMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = `${member.name} (ID: ${member.memberId})`;
                addPaymentMemberSelect.appendChild(option);
            });
        }

        /**
         * Populates the member select dropdown in the ID Card tab.
         * Filters based on search input.
         */
        function populateIdCardMemberSelect(searchTerm = '') {
            idCardMemberSelect.innerHTML = '<option value="">-- Select a Member --</option>';
            const lowerCaseSearchTerm = searchTerm.toLowerCase();

            const filteredMembers = allMembers.filter(member =>
                (member.name && member.name.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (member.memberId && member.memberId.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (member.phoneNumber && member.phoneNumber.toLowerCase().includes(lowerCaseSearchTerm))
            );

            filteredMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = `${member.name} (ID: ${member.memberId})`;
                idCardMemberSelect.appendChild(option);
            });
        }

        /**
         * Displays the selected member's details in the ID card format.
         * @param {string} memberId - The ID of the member to display.
         */
        function displayIdCard(memberId) {
            const member = allMembers.find(m => m.id === memberId);
            if (member) {
                idCardPhoto.src = member.photoURL || "https://placehold.co/120x120/4a5568/cbd5e0?text=No+Photo";
                idCardPhoto.onerror = () => idCardPhoto.src = "https://placehold.co/120x120/4a5568/cbd5e0?text=No+Photo"; // Fallback on error
                idCardName.textContent = member.name || 'N/A';
                idCardMemberId.textContent = member.memberId || 'N/A';
                idCardPhone.textContent = member.phoneNumber || 'N/A';
                idCardMembershipType.textContent = member.membershipType || 'N/A';
                idCardStartDate.textContent = formatToDDMMYYYY(member.startDate) || 'N/A';
                idCardDueDate.textContent = formatToDDMMYYYY(member.dueDate) || 'N/A';
                idCardFee.textContent = `$${(member.feeAmount || 0).toFixed(2)}`;
                idCardStatus.textContent = member.status || 'N/A';

                idCardDisplay.classList.remove('hidden');
                noIdCardSelectedMessage.classList.add('hidden');
            } else {
                idCardDisplay.classList.add('hidden');
                noIdCardSelectedMessage.classList.remove('hidden');
            }
        }


        /**
         * Handles tab switching.
         * @param {string} tabId - The ID of the tab to show ('manage-member', 'add-existing', 'add-payment', 'id-card').
         */
        function showTab(tabId) {
            // Deactivate all tabs and hide all content
            [tabManageMember, tabAddExisting, tabAddPayment, tabIdCard].forEach(tab => { // Updated tab ID
                tab.classList.remove('tab-active');
                tab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-300', 'hover:border-gray-600');
            });

            [contentManageMember, contentAddExisting, contentAddPayment, contentIdCard].forEach(content => { // Updated content ID
                content.classList.add('hidden');
            });

            // Activate the selected tab and show its content
            if (tabId === 'manage-member') {
                tabManageMember.classList.add('tab-active');
                tabManageMember.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-300', 'hover:border-gray-600');
                contentManageMember.classList.remove('hidden');
                clearExistingMemberForm(); // Clear other forms
                clearAddPaymentForm(); // Updated function call
                clearIdCardDisplay(); // Clear ID card display
                // Ensure camera is stopped if active in other tabs
                stopCamera(existingCameraFeed, existingCameraStream);
            } else if (tabId === 'add-existing') {
                tabAddExisting.classList.add('tab-active');
                tabAddExisting.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-300', 'hover:border-gray-600');
                contentAddExisting.classList.remove('hidden');
                clearMainForm(); // Clear other forms
                clearAddPaymentForm(); // Updated function call
                clearIdCardDisplay(); // Clear ID card display
                // Ensure camera is stopped if active in other tabs
                stopCamera(cameraFeed, cameraStream);
            } else if (tabId === 'add-payment') { // Updated tab ID
                tabAddPayment.classList.add('tab-active'); // Updated tab ID
                tabAddPayment.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-300', 'hover:border-gray-600');
                contentAddPayment.classList.remove('hidden'); // Updated content ID
                clearMainForm(); // Clear other forms
                clearExistingMemberForm();
                populateAddPaymentMemberSelect(addPaymentMemberSearchInput.value); // Updated function call
                clearAddPaymentForm(); // Clear the add payment form itself (updated function call)
                clearIdCardDisplay(); // Clear ID card display
                // Ensure camera is stopped if active in other tabs
                stopCamera(cameraFeed, cameraStream);
                stopCamera(existingCameraFeed, existingCameraStream);
            } else if (tabId === 'id-card') {
                tabIdCard.classList.add('tab-active');
                tabIdCard.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-300', 'hover:border-gray-600');
                contentIdCard.classList.remove('hidden');
                clearMainForm();
                clearExistingMemberForm();
                clearAddPaymentForm(); // Updated function call
                populateIdCardMemberSelect(idCardMemberSearchInput.value); // Populate member dropdown for ID card
                displayIdCard(null); // Clear displayed ID card
                // Ensure camera is stopped if active in other tabs
                stopCamera(cameraFeed, cameraStream);
                stopCamera(existingCameraFeed, existingCameraStream);
            }
        }

        /**
         * Updates the current date, time, and day displayed in the header.
         */
        function updateDateTime() {
            const now = new Date();

            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
            const timeString = now.toLocaleTimeString('en-US', timeOptions);

            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
            const dateString = now.toLocaleDateString('en-US', dateOptions);

            const dayOptions = { weekday: 'long' };
            const dayString = now.toLocaleDateString('en-US', dayOptions);

            currentTimeDisplay.textContent = timeString;
            currentDateDisplay.textContent = dateString;
            currentDayDisplay.textContent = dayString;
        }

        // Initialize Firebase and App Password Check on window load
        window.onload = async function() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                showMessage('Failed to initialize Firebase. Check console for errors.', 'error');
                return;
            }

            // Start updating date/time immediately and then every second
            updateDateTime();
            setInterval(updateDateTime, 1000);

            // Listen for authentication state changes (Firebase login)
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    userIdValue.textContent = currentUserId;
                    authSection.classList.add('hidden'); // Hide Firebase auth section
                    passwordEntryModal.classList.remove('hidden'); // Show in-app password modal
                    passwordEntryModal.classList.add('flex');
                    appPasswordInput.value = ''; // Clear input
                    appPasswordInput.focus();

                    // Start listening to Firestore for gym members ONLY AFTER Firebase auth is successful
                    const membersCollectionRef = collection(db, `artifacts/${envAppId}/public/data/gymMembers`);
                    onSnapshot(membersCollectionRef, (snapshot) => {
                        allMembers = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        renderMembers(); // Re-render whenever data changes
                        // If add payment tab is active, re-populate member select
                        if (!contentAddPayment.classList.contains('hidden')) { // Updated content ID
                             populateAddPaymentMemberSelect(addPaymentMemberSearchInput.value); // Updated function call
                        }
                        // If ID card tab is active, re-populate member select
                        if (!contentIdCard.classList.contains('hidden')) {
                            populateIdCardMemberSelect(idCardMemberSearchInput.value);
                            // If a member was selected, re-display their card
                            if (idCardMemberSelect.value) {
                                displayIdCard(idCardMemberSelect.value);
                            }
                        }
                    }, (error) => {
                        console.error("Error fetching members:", error);
                        showMessage('Failed to load members. Check your internet connection.', 'error');
                    });

                } else {
                    currentUserId = null;
                    userIdValue.textContent = ''; // Clear user ID
                    mainAppSection.classList.add('hidden', 'scale-95', 'opacity-0'); // Hide main app
                    passwordEntryModal.classList.add('hidden'); // Ensure in-app password modal is hidden
                    authSection.classList.remove('hidden'); // Show Firebase auth section
                    // Clear members list if not authenticated
                    allMembers = [];
                    renderMembers();
                }
            });

            // Initial sign-in attempt with custom token if available, otherwise anonymously
            // This happens first to establish Firebase auth, then the in-app password takes over
            if (!auth.currentUser) {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Initial sign-in error:", error);
                    showMessage('Failed to automatically sign in to backend. Please use the options below.', 'error');
                }
            }
        };

        // Authentication Event Listeners
        signInButton.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            if (!email || !password) {
                showMessage('Please enter both email and password.', 'error');
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage('Signed in successfully!', 'success');
                // onAuthStateChanged will handle showing passwordEntryModal
            } catch (error) {
                console.error("Sign in error:", error);
                showMessage(`Sign in failed: ${error.message}`, 'error');
            }
        });

        signUpButton.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            if (!email || !password) {
                showMessage('Please enter both email and password.', 'error');
                return;
            }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showMessage('Account created and signed in successfully!', 'success');
                // onAuthStateChanged will handle showing passwordEntryModal
            } catch (error) {
                console.error("Sign up error:", error);
                showMessage(`Sign up failed: ${error.message}`, 'error');
            }
        });

        anonymousSignInButton.addEventListener('click', async () => {
            try {
                await signInAnonymously(auth);
                showMessage('Signed in anonymously!', 'success');
                // onAuthStateChanged will handle showing passwordEntryModal
            } catch (error) {
                console.error("Anonymous sign in error:", error);
                showMessage(`Anonymous sign in failed: ${error.message}`, 'error');
            }
        });

        // In-App Password Entry Event Listener
        submitAppPasswordBtn.addEventListener('click', () => {
            const enteredPassword = appPasswordInput.value;
            if (enteredPassword === APP_PASSWORD) {
                passwordEntryModal.classList.remove('flex');
                passwordEntryModal.classList.add('hidden');
                // Show main app section with animation
                mainAppSection.classList.remove('hidden');
                setTimeout(() => {
                    mainAppSection.classList.remove('scale-95', 'opacity-0');
                    mainAppSection.classList.add('scale-100', 'opacity-100');
                }, 10); // Small delay to allow 'hidden' to apply first
                showTab('manage-member'); // Show default tab on successful app password entry
            } else {
                showMessage('Incorrect password. Please try again.', 'error');
                appPasswordInput.value = '';
                appPasswordInput.focus();
            }
        });

        // Allow pressing Enter in password field
        appPasswordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitAppPasswordBtn.click();
            }
        });


        // Sign Out Button (logs out from Firebase and returns to Firebase login screen)
        signOutButton.addEventListener('click', async () => {
            try {
                await signOut(auth); // This signs out the Firebase user (anonymous or email/password)
                showMessage('Signed out successfully! Please log in again.', 'success');
                clearMainForm();
                clearExistingMemberForm();
                clearAddPaymentForm(); // Updated function call
                clearIdCardDisplay();
                // onAuthStateChanged will handle showing authSection and hiding mainAppSection/passwordEntryModal
            } catch (error) {
                console.error("Sign out error:", error);
                showMessage(`Sign out failed: ${error.message}`, 'error');
            }
        });

        // Tab Event Listeners
        tabManageMember.addEventListener('click', () => showTab('manage-member'));
        tabAddExisting.addEventListener('click', () => showTab('add-existing'));
        tabAddPayment.addEventListener('click', () => showTab('add-payment')); // Updated ID
        tabIdCard.addEventListener('click', () => showTab('id-card'));


        // Main Member Form Event Listener (for adding new or updating existing)
        memberForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db || !currentUserId) {
                showMessage('Database not ready or user not authenticated. Please sign in.', 'error');
                return;
            }

            const membershipType = membershipTypeInput.value;
            const calculatedDueDate = addDurationToDate(startDateInput.value, membershipType);
            const feeAmount = defaultPlanAmounts[membershipType]; // Get fee from hardcoded default plans

            if (feeAmount === undefined) {
                showMessage(`Error: Default fee for ${membershipType} is not defined.`, 'error');
                return;
            }

            let memberData = {
                memberId: memberIdInput.value.trim(),
                name: nameInput.value.trim(),
                phoneNumber: phoneNumberInput.value.trim(),
                membershipType: membershipType,
                startDate: startDateInput.value,
                dueDate: calculatedDueDate,
                feeAmount: parseFloat(feeAmount), // Use the default amount
                status: 'Active', // New members are always 'Active' initially
                updatedAt: serverTimestamp(),
                createdBy: currentUserId,
            };

            if (!memberData.memberId) {
                showMessage('Member ID is required.', 'error');
                return;
            }

            try {
                let docRef;
                let photoURL = null; // Initialize photoURL

                // Handle photo upload if a new photo is present
                if (currentPhotoBase64 && !currentPhotoBase64.startsWith('https://res.cloudinary.com/')) {
                    // Only upload if it's a new base64 image (not an existing Cloudinary URL)
                    photoURL = await uploadImageToCloudinary(currentPhotoBase64);
                    if (!photoURL) {
                        // If upload fails, stop the process or handle appropriately
                        showMessage('Failed to upload photo to Cloudinary. Member not saved.', 'error');
                        return;
                    }
                    memberData.photoURL = photoURL;
                } else if (currentPhotoBase64 && currentPhotoBase64.startsWith('https://res.cloudinary.com/')) {
                    // If it's an existing Cloudinary URL, retain it
                    memberData.photoURL = currentPhotoBase64;
                } else {
                    // If photo was cleared or never set
                    memberData.photoURL = null;
                }


                if (editingMemberId) {
                    // Update existing member
                    docRef = doc(db, `artifacts/${envAppId}/public/data/gymMembers`, editingMemberId);
                    await updateDoc(docRef, memberData);
                    showMessage('Member updated successfully!', 'success');

                } else {
                    // Add new member
                    memberData.createdAt = serverTimestamp(); // Set createdAt only for new members
                    docRef = await addDoc(collection(db, `artifacts/${envAppId}/public/data/gymMembers`), memberData);
                    showMessage('Member added successfully!', 'success');
                }
                clearMainForm();
            } catch (error) {
                console.error("Error adding/updating member or uploading photo:", error);
                showMessage('Failed to save member. Please try again.', 'error');
            }
        });

        // Auto-calculate dueDate for main form
        startDateInput.addEventListener('input', () => {
            dueDateInput.value = addDurationToDate(startDateInput.value, membershipTypeInput.value);
        });
        membershipTypeInput.addEventListener('change', () => {
            dueDateInput.value = addDurationToDate(startDateInput.value, membershipTypeInput.value);
        });


        cancelEditButton.addEventListener('click', clearMainForm);
        searchInput.addEventListener('input', renderMembers);
        filterStatusSelect.addEventListener('change', renderMembers);
        cancelDeleteButton.addEventListener('click', () => {
            deleteModal.classList.add('hidden');
            deleteModalContent.classList.add('scale-95', 'opacity-0'); // Reset for next time
        });
        confirmDeleteButton.addEventListener('click', handleDelete);

        // Photo related event listeners for Manage Member Details tab
        uploadPhotoBtn.addEventListener('click', () => photoUploadInput.click()); // Trigger file input click
        photoUploadInput.addEventListener('change', (event) => handleFileUpload(event, photoPreview, clearPhotoBtn, switchCameraBtn, cameraFeed, cameraStream, viewPhotoLink, (data) => currentPhotoBase64 = data));

        takePhotoBtn.addEventListener('click', () => handleTakePhoto(cameraFeed, cameraCanvas, photoPreview, clearPhotoBtn, switchCameraBtn, viewPhotoLink, (data) => currentPhotoBase64 = data, currentCameraFacingMode, (stream) => cameraStream = stream));

        switchCameraBtn.addEventListener('click', () => handleSwitchCamera(cameraFeed, cameraStream, (stream) => cameraStream = stream, (mode) => currentCameraFacingMode = mode, currentCameraFacingMode, photoPreview, viewPhotoLink));

        cameraFeed.addEventListener('click', () => {
            const dataUrl = capturePhoto(cameraFeed, cameraCanvas, photoPreview);
            if (dataUrl) {
                currentPhotoBase64 = dataUrl;
                stopCamera(cameraFeed, cameraStream);
                cameraStream = null;
                clearPhotoBtn.classList.remove('hidden');
                switchCameraBtn.classList.add('hidden');
                viewPhotoLink.href = dataUrl;
                viewPhotoLink.textContent = 'View Photo Preview';
                viewPhotoLink.classList.remove('hidden');
            }
        });

        // Clear photo button now only clears the link in Firestore
        clearPhotoBtn.addEventListener('click', () => handleClearPhoto(photoPreview, clearPhotoBtn, switchCameraBtn, photoUploadInput, cameraFeed, cameraStream, viewPhotoLink, (data) => currentPhotoBase64 = data, editingMemberId));

        // Add double-tap/click listener to the photo preview in the form
        addPhotoEnlargeListeners(photoPreview);


        // Existing Member Form Event Listeners
        existingStartDateInput.addEventListener('input', () => {
            const startDate = existingStartDateInput.value;
            const membershipType = existingMembershipTypeInput.value;
            calculatedDueDateInput.value = addDurationToDate(startDate, membershipType);
        });

        existingMembershipTypeInput.addEventListener('change', () => {
            const startDate = existingStartDateInput.value;
            const membershipType = existingMembershipTypeInput.value;
            calculatedDueDateInput.value = addDurationToDate(startDate, membershipType);
        });

        existingMemberForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db || !currentUserId) {
                showMessage('Database not ready or user not authenticated. Please sign in.', 'error');
                return;
            }

            const membershipType = existingMembershipTypeInput.value;
            const feeAmount = defaultPlanAmounts[membershipType]; // Get fee from hardcoded default plans

            if (feeAmount === undefined) {
                showMessage(`Error: Default fee for ${membershipType} is not defined.`, 'error');
                return;
            }

            const memberData = {
                memberId: existingMemberIdInput.value.trim(), // Get Member ID
                name: existingNameInput.value.trim(),
                phoneNumber: existingPhoneNumberInput.value.trim(), // Get Phone Number
                membershipType: membershipType,
                startDate: existingStartDateInput.value,
                dueDate: calculatedDueDateInput.value, // Use the calculated due date
                feeAmount: parseFloat(feeAmount), // Use the default amount
                status: 'Active', // Existing members are always 'Active' initially
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
                createdBy: currentUserId,
            };

            if (!memberData.memberId) {
                showMessage('Member ID is required.', 'error');
                return;
            }

            try {
                let photoURL = null;
                if (existingPhotoBase64) {
                    photoURL = await uploadImageToCloudinary(existingPhotoBase64);
                    if (!photoURL) {
                        showMessage('Failed to upload photo to Cloudinary. Member not added.', 'error');
                        return;
                    }
                    memberData.photoURL = photoURL;
                } else {
                    memberData.photoURL = null;
                }

                const docRef = await addDoc(collection(db, `artifacts/${envAppId}/public/data/gymMembers`), memberData);
                showMessage('Existing member added successfully!', 'success');
                clearExistingMemberForm();
            } catch (error) {
                console.error("Error adding existing member:", error);
                showMessage('Failed to add existing member. Please try again.', 'error');
            }
        });

        // Photo related event listeners for Add Existing Member tab
        existingUploadPhotoBtn.addEventListener('click', () => existingPhotoUploadInput.click());
        existingPhotoUploadInput.addEventListener('change', (event) => handleFileUpload(event, existingPhotoPreview, existingClearPhotoBtn, existingSwitchCameraBtn, existingCameraFeed, existingCameraStream, existingViewPhotoLink, (data) => existingPhotoBase64 = data));

        existingTakePhotoBtn.addEventListener('click', () => handleTakePhoto(existingCameraFeed, existingCameraCanvas, existingPhotoPreview, existingClearPhotoBtn, existingSwitchCameraBtn, existingViewPhotoLink, (data) => existingPhotoBase64 = data, currentCameraFacingMode, (stream) => existingCameraStream = stream));

        existingSwitchCameraBtn.addEventListener('click', () => handleSwitchCamera(existingCameraFeed, existingCameraStream, (stream) => existingCameraStream = stream, (mode) => currentCameraFacingMode = mode, currentCameraFacingMode, existingPhotoPreview, existingViewPhotoLink));

        existingCameraFeed.addEventListener('click', () => {
            const dataUrl = capturePhoto(existingCameraFeed, existingCameraCanvas, existingPhotoPreview);
            if (dataUrl) {
                existingPhotoBase64 = dataUrl;
                stopCamera(existingCameraFeed, existingCameraStream);
                existingCameraStream = null;
                existingClearPhotoBtn.classList.remove('hidden');
                existingSwitchCameraBtn.classList.add('hidden');
                existingViewPhotoLink.href = dataUrl;
                existingViewPhotoLink.textContent = 'View Photo Preview';
                existingViewPhotoLink.classList.remove('hidden');
            }
        });

        existingClearPhotoBtn.addEventListener('click', () => handleClearPhoto(existingPhotoPreview, existingClearPhotoBtn, existingSwitchCameraBtn, existingPhotoUploadInput, existingCameraFeed, existingCameraStream, existingViewPhotoLink, (data) => existingPhotoBase64 = data, null)); // Pass null for new member, as no existing photo to delete from Firestore/Storage yet

        // Add double-tap/click listener to the photo preview in the existing form
        addPhotoEnlargeListeners(existingPhotoPreview);


        // Add Payment Form Event Listeners (formerly Advance Payment)
        addPaymentMemberSearchInput.addEventListener('input', (e) => { // Updated ID
            populateAddPaymentMemberSelect(e.target.value); // Updated function call
            // Clear details if search changes
            addPaymentMemberSelect.value = '';
            addPaymentCurrentDueDateInput.value = '';
            addPaymentNewDueDateInput.value = '';
        });

        addPaymentMemberSelect.addEventListener('change', () => { // Updated ID
            const selectedMemberId = addPaymentMemberSelect.value; // Updated ID
            const selectedMember = allMembers.find(m => m.id === selectedMemberId);

            if (selectedMember) {
                addPaymentCurrentDueDateInput.value = formatToDDMMYYYY(selectedMember.dueDate); // Display formatted // Updated ID
                // If member is overdue, use the special calculation for new due date
                if (isOverdue(selectedMember.dueDate)) {
                    addPaymentNewDueDateInput.value = formatToDDMMYYYY(calculateOverduePaidDueDate(addPaymentMembershipTypeInput.value, selectedMember.dueDate)); // Updated ID
                } else {
                    addPaymentNewDueDateInput.value = formatToDDMMYYYY(addDurationToDate(selectedMember.dueDate, addPaymentMembershipTypeInput.value)); // Updated ID
                }
            } else {
                addPaymentCurrentDueDateInput.value = ''; // Updated ID
                addPaymentNewDueDateInput.value = ''; // Updated ID
            }
        });

        addPaymentMembershipTypeInput.addEventListener('change', () => { // Updated ID
            const selectedMemberId = addPaymentMemberSelect.value; // Updated ID
            const selectedMember = allMembers.find(m => m.id === selectedMemberId);

            if (selectedMember) {
                // Calculate new due date based on current due date and selected payment type
                // If member is overdue, use the special calculation for new due date
                if (isOverdue(selectedMember.dueDate)) {
                    addPaymentNewDueDateInput.value = formatToDDMMYYYY(calculateOverduePaidDueDate(addPaymentMembershipTypeInput.value, selectedMember.dueDate)); // Updated ID
                } else {
                    addPaymentNewDueDateInput.value = formatToDDMMYYYY(addDurationToDate(selectedMember.dueDate, addPaymentMembershipTypeInput.value)); // Updated ID
                }
            } else {
                addPaymentNewDueDateInput.value = ''; // Updated ID
            }
        });

        addPaymentForm.addEventListener('submit', async (e) => { // Updated ID
            e.preventDefault();
            if (!db || !currentUserId) {
                showMessage('Database not ready or user not authenticated. Please sign in.', 'error');
                return;
            }

            const selectedMemberId = addPaymentMemberSelect.value; // Updated ID
            const newMembershipType = addPaymentMembershipTypeInput.value; // Updated ID
            let newDueDate = addPaymentNewDueDateInput.value; // This is already formatted as DD-MM-YYYY // Updated ID
            const selectedMember = allMembers.find(m => m.id === selectedMemberId);

            if (!selectedMemberId || !newDueDate || !selectedMember) {
                showMessage('Please select a member and a payment plan.', 'error');
                return;
            }

            const feeAmount = defaultPlanAmounts[newMembershipType]; // Get fee from hardcoded default plans
            if (feeAmount === undefined) {
                showMessage(`Error: Default fee for ${newMembershipType} is not defined.`, 'error');
                return;
            }

            // Convert newDueDate back to YYYY-MM-DD for Firestore storage
            const parts = newDueDate.split('-');
            const newDueDateForFirestore = `${parts[2]}-${parts[1]}-${parts[0]}`;


            try {
                const memberDocRef = doc(db, `artifacts/${envAppId}/public/data/gymMembers`, selectedMemberId);

                await updateDoc(memberDocRef, {
                    dueDate: newDueDateForFirestore, // Store in YYYY-MM-DD
                    membershipType: newMembershipType, // Update membership type as well
                    feeAmount: parseFloat(feeAmount), // Update fee amount
                    status: 'Active', // Always set to Active on add payment
                    updatedAt: serverTimestamp(),
                    updatedBy: currentUserId,
                });
                showMessage('Payment processed and due date updated successfully!', 'success'); // Updated message
                clearAddPaymentForm(); // Updated function call
            } catch (error) {
                console.error("Error processing payment:", error); // Updated message
                showMessage('Failed to process payment. Please try again.', 'error'); // Updated message
            }
        });

        // ID Card Tab Event Listeners
        idCardMemberSearchInput.addEventListener('input', (e) => {
            populateIdCardMemberSelect(e.target.value);
            displayIdCard(null); // Clear displayed card when search changes
        });

        idCardMemberSelect.addEventListener('change', (e) => {
            displayIdCard(e.target.value);
        });

        // Photo View Modal Event Listeners
        closePhotoModalBtn.addEventListener('click', closePhotoModal);
        photoViewModal.addEventListener('click', (e) => {
            // Close modal if clicking outside the enlarged image (on the overlay)
            if (e.target === photoViewModal) {
                closePhotoModal();
            }
        });

    </script>
</body>
</html>
