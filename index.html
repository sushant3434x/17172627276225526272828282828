<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Alpha Core Fitness — Member Manager</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* Inter font from Google Fonts */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
  body { font-family: 'Inter', sans-serif; }
  
  /* Utilities */
  .tab-active { border-bottom-width: 2px; border-color: rgb(99 102 241); color: rgb(196 181 253); }
  .line-through-name { text-decoration: line-through; text-decoration-thickness: 2px; }
  .drawer-open body { overflow: hidden; }

  /* Row accents */
  .row-overdue { background-color: rgb(127 29 29); }   /* red-900 */
  .row-normal  { background-color: rgb(31 41 55); }    /* gray-800 */
  .row-inactive{ background-color: rgb(133 77 14); }   /* amber-900 */

  /* Slide-in drawer */
  #hamburger-drawer {
    transition: transform 0.25s ease;
    transform: translateX(-100%);
  }
  #hamburger-drawer.open { transform: translateX(0%); }

  /* Splash Screen */
  #splash-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #0c0a09; /* Stone-950 */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 100;
    transition: opacity 0.5s ease-in-out;
  }
  .spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #1f2937; /* Gray-800 */
    border-top-color: #3b82f6; /* Blue-500 */
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">

<!-- Splash Screen -->
<div id="splash-screen">
  <h1 class="text-4xl font-bold mb-4 text-gray-100">Alpha Core Fitness</h1>
  <div class="spinner"></div>
</div>

<!-- Top bar -->
<header class="sticky top-0 z-40 bg-gray-950/80 backdrop-blur border-b border-gray-800 hidden" id="top-bar">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
    <button id="hamburger-btn" class="p-2 rounded-lg bg-gray-800 hover:bg-gray-700 focus:outline-none" aria-label="Menu">☰</button>
    <h1 class="text-lg font-bold">Alpha Core Fitness — Gym Dashboard</h1>
    <div class="ml-auto flex items-center gap-4 text-sm">
      <div class="text-right">
        <div id="current-time" class="font-semibold"></div>
        <div id="current-date"></div>
        <div id="current-day"></div>
      </div>
      <button id="signout-button" class="px-3 py-2 bg-red-600 hover:bg-red-700 rounded-lg">Sign Out</button>
    </div>
  </div>
</header>

<!-- Drawer -->
<aside id="hamburger-drawer" class="fixed top-0 left-0 h-full w-72 bg-gray-950 border-r border-gray-800 p-4 z-50">
  <div class="flex items-center justify-between mb-4">
    <span class="font-bold">Navigation</span>
    <button id="drawer-close" class="text-2xl leading-none">&times;</button>
  </div>
  <nav class="grid gap-2 text-sm">
    <button class="drawer-link text-left px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700" data-target="dashboard">📊 Dashboard</button>
    <button class="drawer-link text-left px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700" data-target="current">👥 Current Members</button>
    <button class="drawer-link text-left px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700" data-target="overdue">⏰ Overdue</button>
    <button class="drawer-link text-left px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700" data-target="inactive">💤 Inactive</button>
    <hr class="border-gray-800 my-2" />
    <button class="drawer-link text-left px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700" data-target="manage">✍️ Manage Member</button>
    <button class="drawer-link text-left px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700" data-target="existing">📋 Add Existing</button>
    <button class="drawer-link text-left px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700" data-target="payment">💳 Add Payment</button>
    <button class="drawer-link text-left px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700" data-target="idcard">🆔 ID Card</button>
    <button class="drawer-link text-left px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700" data-target="payments-history">📜 Payments History</button>
  </nav>
</aside>

<!-- Auth Screen -->
<section id="auth-section" class="max-w-md mx-auto mt-10 p-6 bg-gray-800 rounded-xl border border-gray-700 hidden">
  <h2 class="text-xl font-semibold mb-4">Sign in to Firebase</h2>
  <div class="space-y-3">
    <input id="auth-password" class="w-full p-3 bg-gray-900 border border-gray-700 rounded" placeholder="Password" type="password" />
    <div class="flex gap-2">
      <button id="signin-button" class="flex-1 px-3 py-2 bg-indigo-600 rounded hover:bg-indigo-700">Sign In</button>
    </div>
  </div>
</section>

<!-- Main App -->
<main id="main-app-section" class="hidden max-w-6xl mx-auto px-4 py-6 space-y-10">

  <!-- Dashboard -->
  <section id="view-dashboard" class="space-y-6">
    <!-- Counts -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
      <div class="p-4 rounded-xl border border-gray-700 bg-gray-800 text-center">
        <div class="text-xs text-gray-400">Current</div>
        <div id="count-current" class="text-2xl font-bold">0</div>
      </div>
      <div class="p-4 rounded-xl border border-gray-700 bg-gray-800 text-center">
        <div class="text-xs text-gray-400">Overdue</div>
        <div id="count-overdue" class="text-2xl font-bold text-red-400">0</div>
      </div>
      <div class="p-4 rounded-xl border border-gray-700 bg-gray-800 text-center">
        <div class="text-xs text-gray-400">Inactive 💤</div>
        <div id="count-inactive" class="text-2xl font-bold text-yellow-300">0</div>
      </div>
      <div class="p-4 rounded-xl border border-gray-700 bg-gray-800 text-center">
        <div class="text-xs text-gray-400">Paid</div>
        <div id="count-paid" class="text-2xl font-bold text-emerald-300">0</div>
      </div>
    </div>

    <!-- Expanded Overdue -->
    <div class="bg-gray-800 border border-red-800 rounded-xl">
      <div class="flex items-center justify-between p-4">
        <h3 class="text-lg font-bold text-red-400">Overdue Members</h3>
        <input id="dash-overdue-search" placeholder="Search overdue…" class="p-2 bg-gray-900 border border-gray-700 rounded w-60">
      </div>
      <div id="overdue-container" class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-red-900">
            <tr>
              <th class="px-4 py-2 text-left text-red-200">Photo</th>
              <th class="px-4 py-2 text-left text-red-200">Member ID</th>
              <th class="px-4 py-2 text-left text-red-200">Name</th>
              <th class="px-4 py-2 text-left text-red-200">Phone</th>
              <th class="px-4 py-2 text-left text-red-200">Type</th>
              <th class="px-4 py-2 text-left text-red-200">Start</th>
              <th class="px-4 py-2 text-left text-red-200">Due</th>
              <th class="px-4 py-2 text-left text-red-200">Days Overdue</th>
              <th class="px-4 py-2 text-left text-red-200">Actions</th>
            </tr>
          </thead>
          <tbody id="overdue-tbody" class="divide-y divide-gray-700"></tbody>
        </table>
        <p id="no-overdue" class="p-4 text-center text-gray-400 hidden">No overdue members. 🎉</p>
      </div>
    </div>
  </section>

  <!-- Current Members -->
  <section id="view-current" class="space-y-4 hidden">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-bold">Current Members</h3>
      <input id="current-search" placeholder="Search current…" class="p-2 bg-gray-900 border border-gray-700 rounded w-60">
    </div>
    <div class="overflow-x-auto rounded-xl border border-gray-700">
      <table class="min-w-full text-sm">
        <thead class="bg-indigo-900">
          <tr>
            <th class="px-4 py-2 text-left text-indigo-200">Photo</th>
            <th class="px-4 py-2 text-left text-indigo-200">Member ID</th>
            <th class="px-4 py-2 text-left text-indigo-200">Name</th>
            <th class="px-4 py-2 text-left text-indigo-200">Phone</th>
            <th class="px-4 py-2 text-left text-indigo-200">Type</th>
            <th class="px-4 py-2 text-left text-indigo-200">Start</th>
            <th class="px-4 py-2 text-left text-indigo-200">Due</th>
            <th class="px-4 py-2 text-left text-indigo-200">Days Left</th>
            <th class="px-4 py-2 text-left text-indigo-200">Actions</th>
          </tr>
        </thead>
        <tbody id="current-tbody" class="divide-y divide-gray-700"></tbody>
      </table>
      <p id="no-current" class="p-4 text-center text-gray-400 hidden">No current members.</p>
    </div>
  </section>

  <!-- Overdue (separate view) -->
  <section id="view-overdue" class="space-y-4 hidden">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-bold text-red-400">Overdue</h3>
      <input id="overdue-search" placeholder="Search overdue…" class="p-2 bg-gray-900 border border-gray-700 rounded w-60">
    </div>
    <div class="overflow-x-auto rounded-xl border border-red-800">
      <table class="min-w-full text-sm">
        <thead class="bg-red-900">
          <tr>
            <th class="px-4 py-2 text-left text-red-200">Photo</th>
            <th class="px-4 py-2 text-left text-red-200">Member ID</th>
            <th class="px-4 py-2 text-left text-red-200">Name</th>
            <th class="px-4 py-2 text-left text-red-200">Phone</th>
            <th class="px-4 py-2 text-left text-red-200">Type</th>
            <th class="px-4 py-2 text-left text-red-200">Start</th>
            <th class="px-4 py-2 text-left text-red-200">Due</th>
            <th class="px-4 py-2 text-left text-red-200">Days Overdue</th>
            <th class="px-4 py-2 text-left text-red-200">Actions</th>
          </tr>
        </thead>
        <tbody id="overdue2-tbody" class="divide-y divide-gray-700"></tbody>
      </table>
      <p id="no-overdue2" class="p-4 text-center text-gray-400 hidden">No overdue members.</p>
    </div>
  </section>

  <!-- Inactive -->
  <section id="view-inactive" class="space-y-4 hidden">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-bold text-yellow-300">Inactive Members 💤</h3>
      <input id="inactive-search" placeholder="Search inactive…" class="p-2 bg-gray-900 border border-gray-700 rounded w-60">
    </div>
    <div class="overflow-x-auto rounded-xl border border-yellow-700">
      <table class="min-w-full text-sm">
        <thead class="bg-yellow-900">
          <tr>
            <th class="px-4 py-2 text-left text-yellow-200">Photo</th>
            <th class="px-4 py-2 text-left text-yellow-200">Member ID</th>
            <th class="px-4 py-2 text-left text-yellow-200">Name</th>
            <th class="px-4 py-2 text-left text-yellow-200">Phone</th>
            <th class="px-4 py-2 text-left text-yellow-200">Last Type</th>
            <th class="px-4 py-2 text-left text-yellow-200">Start</th>
            <th class="px-4 py-2 text-left text-yellow-200">Due</th>
            <th class="px-4 py-2 text-left text-yellow-200">Status</th>
            <th class="px-4 py-2 text-left text-yellow-200">Actions</th>
          </tr>
        </thead>
        <tbody id="inactive-tbody" class="divide-y divide-gray-700"></tbody>
      </table>
      <p id="no-inactive" class="p-4 text-center text-gray-400 hidden">No inactive members.</p>
    </div>
  </section>

  <!-- Payments History -->
  <section id="view-payments-history" class="space-y-4 hidden">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-bold">Payments History</h3>
      <input id="payments-search" placeholder="Search payments…" class="p-2 bg-gray-900 border border-gray-700 rounded w-60">
    </div>
    <div class="overflow-x-auto rounded-xl border border-gray-700">
      <table class="min-w-full text-sm">
        <thead class="bg-emerald-900">
          <tr>
            <th class="px-4 py-2 text-left text-emerald-200">Member Name</th>
            <th class="px-4 py-2 text-left text-emerald-200">Member ID</th>
            <th class="px-4 py-2 text-left text-emerald-200">Plan</th>
            <th class="px-4 py-2 text-left text-emerald-200">Amount</th>
            <th class="px-4 py-2 text-left text-emerald-200">Payment Date</th>
          </tr>
        </thead>
        <tbody id="payments-tbody" class="divide-y divide-gray-700"></tbody>
      </table>
      <p id="no-payments" class="p-4 text-center text-gray-400 hidden">No payments have been recorded yet.</p>
    </div>
  </section>

  <!-- Manage Member (add/update) -->
  <section id="view-manage" class="hidden">
    <h3 class="text-lg font-bold mb-2">Manage Member Details</h3>
    <form id="member-form" class="grid sm:grid-cols-2 gap-4 bg-gray-800 border border-gray-700 p-4 rounded-xl">
      <input id="member-id" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="Member ID" required>
      <input id="member-name" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="Name" required>
      <input id="member-phone" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="Phone">
      <select id="member-plan" class="p-3 bg-gray-900 border border-gray-700 rounded">
        <option>Monthly</option><option>Quarterly</option><option>HalfYearly</option><option>Annual</option>
      </select>
      <input id="member-start" type="date" class="p-3 bg-gray-900 border border-gray-700 rounded" required>
      <input id="member-due" type="date" class="p-3 bg-gray-900 border border-gray-700 rounded" readonly>
      <div class="sm:col-span-2 flex gap-2">
        <button id="submit-member" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded">Save</button>
        <button id="cancel-edit" type="button" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded hidden">Cancel Edit</button>
      </div>
    </form>
  </section>

  <!-- Add Existing -->
  <section id="view-existing" class="hidden">
    <h3 class="text-lg font-bold mb-2">Add Existing Member</h3>
    <form id="existing-member-form" class="grid sm:grid-cols-2 gap-4 bg-gray-800 border border-gray-700 p-4 rounded-xl">
      <input id="existing-member-id" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="Member ID" required>
      <input id="existing-name" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="Name" required>
      <input id="existing-phone-number" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="Phone">
      <select id="existing-membershipType" class="p-3 bg-gray-900 border border-gray-700 rounded">
        <option>Monthly</option><option>Quarterly</option><option>HalfYearly</option><option>Annual</option>
      </select>
      <input id="existing-startDate" type="date" class="p-3 bg-gray-900 border border-gray-700 rounded" required>
      <input id="calculated-dueDate" type="date" class="p-3 bg-gray-900 border border-gray-700 rounded" readonly>
      <button class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded sm:col-span-2">Add</button>
    </form>
  </section>

  <!-- Add Payment -->
  <section id="view-payment" class="hidden">
    <h3 class="text-lg font-bold mb-2">Add Payment / Extend</h3>
    <form id="add-payment-form" class="grid sm:grid-cols-2 gap-4 bg-gray-800 border border-gray-700 p-4 rounded-xl">
      <input id="add-payment-member-search" class="p-3 bg-gray-900 border border-gray-700 rounded sm:col-span-2" placeholder="Search member…">
      <select id="add-payment-member-select" class="p-3 bg-gray-900 border border-gray-700 rounded sm:col-span-2"></select>
      <input id="add-payment-current-dueDate" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="Current Due" readonly>
      <select id="add-payment-membershipType" class="p-3 bg-gray-900 border border-gray-700 rounded">
        <option>Monthly</option><option>Quarterly</option><option>HalfYearly</option><option>Annual</option>
      </select>
      <input id="add-payment-new-dueDate" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="New Due" readonly>
      <button class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded sm:col-span-2">Apply Payment</button>
    </form>
  </section>

  <!-- ID Card -->
  <section id="view-idcard" class="hidden">
    <h3 class="text-lg font-bold mb-2">ID Card</h3>
    <div class="grid sm:grid-cols-2 gap-4 bg-gray-800 border border-gray-700 p-4 rounded-xl">
      <input id="id-card-member-search" class="p-3 bg-gray-900 border border-gray-700 rounded sm:col-span-2" placeholder="Search member…">
      <select id="id-card-member-select" class="p-3 bg-gray-900 border border-gray-700 rounded sm:col-span-2"></select>
      <div id="id-card-display" class="sm:col-span-2 hidden">
        <div class="p-4 rounded-lg bg-gray-900 border border-gray-700">
          <div class="font-mono text-sm" id="id-card-member-id"></div>
          <div class="text-xl font-bold" id="id-card-name"></div>
          <div id="id-card-phone"></div>
          <div id="id-card-membership-type"></div>
          <div id="id-card-start-date"></div>
          <div id="id-card-due-date"></div>
          <div id="id-card-fee"></div>
          <div id="id-card-status"></div>
        </div>
      </div>
      <p id="no-id-card-selected-message" class="sm:col-span-2 text-gray-400">Choose a member to view their ID card.</p>
    </div>
  </section>

</main>

<!-- Info/Error Message Box -->
<div id="message-box" class="fixed bottom-4 right-4 p-4 rounded-lg text-sm transition-opacity duration-300 opacity-0 z-50 pointer-events-none"></div>

<!-- Footer -->
<footer class="py-4 text-center text-gray-400 text-sm mt-10">
  Made with ❤️ by SUSHANT SINGH
</footer>

<script type="module">
  // All JavaScript, including Firebase imports, is in a single block to ensure
  // that all functions and modules are properly loaded and scoped.

  // Firebase SDK imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, query, where, onSnapshot, updateDoc, deleteDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Tailwind CSS configuration for custom styles
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          'gray-950': '#08080c',
        }
      }
    }
  }

  // Firebase configuration and initialization
  const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

  let userId;
  let allMembers = [];

  // DOM elements
  const splashScreen = document.getElementById('splash-screen');
  const authSection = document.getElementById('auth-section');
  const mainAppSection = document.getElementById('main-app-section');
  const topBar = document.getElementById('top-bar');
  const hamburgerBtn = document.getElementById('hamburger-btn');
  const drawer = document.getElementById('hamburger-drawer');
  const drawerCloseBtn = document.getElementById('drawer-close');
  const drawerLinks = document.querySelectorAll('.drawer-link');
  const signoutButton = document.getElementById('signout-button');
  const messageBox = document.getElementById('message-box');
  
  const authPasswordInput = document.getElementById('auth-password');

  const memberForm = document.getElementById('member-form');
  const memberIdInput = document.getElementById('member-id');
  const memberNameInput = document.getElementById('member-name');
  const memberPhoneInput = document.getElementById('member-phone');
  const memberPlanInput = document.getElementById('member-plan');
  const memberStartInput = document.getElementById('member-start');
  const memberDueInput = document.getElementById('member-due');
  const submitMemberBtn = document.getElementById('submit-member');
  const cancelEditBtn = document.getElementById('cancel-edit');

  const existingMemberForm = document.getElementById('existing-member-form');
  const existingMemberIdInput = document.getElementById('existing-member-id');
  const existingNameInput = document.getElementById('existing-name');
  const existingPhoneInput = document.getElementById('existing-phone-number');
  const existingMembershipType = document.getElementById('existing-membershipType');
  const existingStartDate = document.getElementById('existing-startDate');
  const calculatedDueDate = document.getElementById('calculated-dueDate');

  const addPaymentForm = document.getElementById('add-payment-form');
  const addPaymentSearch = document.getElementById('add-payment-member-search');
  const addPaymentSelect = document.getElementById('add-payment-member-select');
  const addPaymentCurrentDue = document.getElementById('add-payment-current-dueDate');
  const addPaymentMembershipType = document.getElementById('add-payment-membershipType');
  const addPaymentNewDue = document.getElementById('add-payment-new-dueDate');

  const idCardSearch = document.getElementById('id-card-member-search');
  const idCardSelect = document.getElementById('id-card-member-select');
  const idCardDisplay = document.getElementById('id-card-display');
  const idCardName = document.getElementById('id-card-name');
  const idCardMemberId = document.getElementById('id-card-member-id');
  const idCardPhone = document.getElementById('id-card-phone');
  const idCardType = document.getElementById('id-card-membership-type');
  const idCardStart = document.getElementById('id-card-start-date');
  const idCardDue = document.getElementById('id-card-due-date');
  const idCardFee = document.getElementById('id-card-fee');
  const idCardStatus = document.getElementById('id-card-status');
  
  const currentTbody = document.getElementById('current-tbody');
  const overdueTbody = document.getElementById('overdue-tbody');
  const overdue2Tbody = document.getElementById('overdue2-tbody');
  const inactiveTbody = document.getElementById('inactive-tbody');
  const paymentsTbody = document.getElementById('payments-tbody');

  const countCurrent = document.getElementById('count-current');
  const countOverdue = document.getElementById('count-overdue');
  const countInactive = document.getElementById('count-inactive');
  const countPaid = document.getElementById('count-paid');

  const noCurrent = document.getElementById('no-current');
  const noOverdue = document.getElementById('no-overdue');
  const noOverdue2 = document.getElementById('no-overdue2');
  const noInactive = document.getElementById('no-inactive');
  const noPayments = document.getElementById('no-payments');

  let currentEditingMemberId = null;

  // Helper functions
  const showMessage = (message, type = 'info') => {
    messageBox.textContent = message;
    messageBox.style.opacity = '1';
    messageBox.classList.add('pointer-events-auto');

    if (type === 'error') {
      messageBox.className = 'fixed bottom-4 right-4 p-4 rounded-lg text-sm transition-opacity duration-300 opacity-100 z-50 pointer-events-auto bg-red-800 text-white';
    } else if (type === 'success') {
      messageBox.className = 'fixed bottom-4 right-4 p-4 rounded-lg text-sm transition-opacity duration-300 opacity-100 z-50 pointer-events-auto bg-green-800 text-white';
    } else {
      messageBox.className = 'fixed bottom-4 right-4 p-4 rounded-lg text-sm transition-opacity duration-300 opacity-100 z-50 pointer-events-auto bg-gray-800 text-white';
    }

    setTimeout(() => {
      messageBox.style.opacity = '0';
      messageBox.classList.remove('pointer-events-auto');
    }, 3000);
  };

  const getDueDate = (startDate, plan) => {
    if (!startDate || !plan) return '';
    const date = new Date(startDate);
    
    switch (plan) {
      case 'Monthly':
        date.setMonth(date.getMonth() + 1);
        break;
      case 'Quarterly':
        date.setMonth(date.getMonth() + 3);
        break;
      case 'HalfYearly':
        date.setMonth(date.getMonth() + 6);
        break;
      case 'Annual':
        date.setFullYear(date.getFullYear() + 1);
        break;
      default:
        return '';
    }
    return date.toISOString().split('T')[0];
  };

  const ddmmyyyy = (dateStr) => {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}-${month}-${year}`;
  };

  const daysDiff = (dateStr) => {
    if (!dateStr) return 'N/A';
    const oneDay = 24 * 60 * 60 * 1000;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const due = new Date(dateStr);
    due.setHours(0, 0, 0, 0);
    const diff = Math.round((due - today) / oneDay);
    return diff;
  };

  const formatCurrency = (amount) => {
    return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount);
  };

  const getMembershipFee = (plan) => {
    switch (plan) {
      case 'Monthly': return 500;
      case 'Quarterly': return 1200;
      case 'HalfYearly': return 2200;
      case 'Annual': return 4000;
      default: return 0;
    }
  };

  const getMemberStatus = (member) => {
    const days = daysDiff(member.dueDate);
    if (days >= 0) {
      return 'current';
    } else if (days < 0 && days >= -30) {
      return 'overdue';
    } else {
      return 'inactive';
    }
  };

  const renderTable = (members, tbody, type) => {
    let rows = '';
    
    if (members.length === 0) {
      document.getElementById(`no-${type}`).classList.remove('hidden');
    } else {
      document.getElementById(`no-${type}`).classList.add('hidden');
    }

    members.forEach(m => {
      const days = daysDiff(m.dueDate);
      const isOverdue = days < 0;
      const daysLeft = isOverdue ? Math.abs(days) : days;
      const daysText = isOverdue ? `${daysLeft} days overdue` : `${daysLeft} days left`;
      
      const rowClass = isOverdue ? 'row-overdue' : 'row-normal';
      const nameClass = m.isRemoved ? 'line-through-name' : '';
      const statusText = m.isRemoved ? 'Removed' : (isOverdue ? 'Overdue' : 'Active');

      rows += `
        <tr data-id="${m.id}" class="${rowClass} hover:bg-gray-700 transition-colors">
          <td class="px-4 py-2 border-r border-gray-700"><img src="https://placehold.co/40x40/4b5563/ffffff?text=U" alt="Profile" class="rounded-full"></td>
          <td class="px-4 py-2 border-r border-gray-700">${m.memberId || ''}</td>
          <td class="px-4 py-2 border-r border-gray-700 ${nameClass}">${m.name || ''}</td>
          <td class="px-4 py-2 border-r border-gray-700">${m.phoneNumber || ''}</td>
          <td class="px-4 py-2 border-r border-gray-700">${m.membershipType || ''}</td>
          <td class="px-4 py-2 border-r border-gray-700">${ddmmyyyy(m.startDate)}</td>
          <td class="px-4 py-2 border-r border-gray-700">${ddmmyyyy(m.dueDate)}</td>
          <td class="px-4 py-2 border-r border-gray-700">${daysLeft}</td>
          <td class="px-4 py-2">
            <div class="flex gap-2">
              <button class="edit-btn px-2 py-1 bg-yellow-600 rounded-md hover:bg-yellow-700 text-white" data-id="${m.id}">Edit</button>
              <button class="remove-btn px-2 py-1 bg-red-600 rounded-md hover:bg-red-700 text-white" data-id="${m.id}">Remove</button>
              <button class="mark-paid-btn px-2 py-1 bg-green-600 rounded-md hover:bg-green-700 text-white" data-id="${m.id}">Mark Paid</button>
            </div>
          </td>
        </tr>
      `;
    });
    tbody.innerHTML = rows;

    document.querySelectorAll('.edit-btn').forEach(btn => btn.onclick = (e) => handleEdit(e.target.dataset.id));
    document.querySelectorAll('.remove-btn').forEach(btn => btn.onclick = (e) => handleRemove(e.target.dataset.id));
    document.querySelectorAll('.mark-paid-btn').forEach(btn => btn.onclick = (e) => handleMarkPaid(e.target.dataset.id));
  };
  
  const updateCounts = (members) => {
    const current = members.filter(m => getMemberStatus(m) === 'current').length;
    const overdue = members.filter(m => getMemberStatus(m) === 'overdue').length;
    const inactive = members.filter(m => getMemberStatus(m) === 'inactive').length;
    
    countCurrent.textContent = current;
    countOverdue.textContent = overdue;
    countInactive.textContent = inactive;
  };
  
  const renderPaymentsTable = (payments) => {
      let rows = '';
      if (payments.length === 0) {
          noPayments.classList.remove('hidden');
      } else {
          noPayments.classList.add('hidden');
      }

      payments.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());

      payments.forEach(p => {
          rows += `
              <tr class="bg-gray-800 hover:bg-gray-700 transition-colors">
                  <td class="px-4 py-2 border-r border-gray-700">${p.memberName || ''}</td>
                  <td class="px-4 py-2 border-r border-gray-700">${p.memberId || ''}</td>
                  <td class="px-4 py-2 border-r border-gray-700">${p.plan || ''}</td>
                  <td class="px-4 py-2 border-r border-gray-700">${formatCurrency(p.amount)}</td>
                  <td class="px-4 py-2">${p.timestamp ? ddmmyyyy(p.timestamp.toDate().toISOString().split('T')[0]) : 'N/A'}</td>
              </tr>
          `;
      });
      paymentsTbody.innerHTML = rows;
  };

  const renderMemberData = (members) => {
    allMembers = members;
    updateCounts(allMembers);

    const currentMembers = allMembers.filter(m => getMemberStatus(m) === 'current');
    const overdueMembers = allMembers.filter(m => getMemberStatus(m) === 'overdue');
    const inactiveMembers = allMembers.filter(m => getMemberStatus(m) === 'inactive');

    renderTable(currentMembers, currentTbody, 'current');
    renderTable(overdueMembers, overdueTbody, 'overdue');
    renderTable(overdueMembers, overdue2Tbody, 'overdue2');
    renderTable(inactiveMembers, inactiveTbody, 'inactive');

    populatePaymentSelect();
    populateIdCardSelect();
  };

  const populatePaymentSelect = (q = '') => {
    const list = allMembers.filter(m => (m.name || '').toLowerCase().includes(q.toLowerCase()) || (m.memberId || '').toLowerCase().includes(q.toLowerCase()));
    addPaymentSelect.innerHTML = '<option value="">Select member…</option>' + list.map(m => `<option value="${m.id}">${m.name} (${m.memberId})</option>`).join('');
  };

  const populateIdCardSelect = (q = '') => {
    const list = allMembers.filter(m => (m.name || '').toLowerCase().includes(q.toLowerCase()) || (m.memberId || '').toLowerCase().includes(q.toLowerCase()));
    idCardSelect.innerHTML = '<option value="">Select member…</option>' + list.map(m => `<option value="${m.id}">${m.name} (${m.memberId})</option>`).join('');
  };

  // Main Firestore Logic
  const setupFirestore = () => {
    // The path for private user data
    const membersCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'members');
    const paymentsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'payments');

    // Set up real-time listener for members
    onSnapshot(membersCollectionRef, (querySnapshot) => {
      const members = [];
      querySnapshot.forEach((doc) => {
        members.push({ id: doc.id, ...doc.data() });
      });
      renderMemberData(members);
    }, (error) => {
      console.error("Error fetching documents:", error);
      showMessage("Error fetching data.", 'error');
    });

    // Set up real-time listener for payments
    onSnapshot(paymentsCollectionRef, (querySnapshot) => {
      const payments = [];
      querySnapshot.forEach((doc) => {
        payments.push({ id: doc.id, ...doc.data() });
      });
      renderPaymentsTable(payments);
    }, (error) => {
      console.error("Error fetching payments:", error);
      showMessage("Error fetching payments.", 'error');
    });
  };

  const handleAddOrUpdateMember = async (e) => {
    e.preventDefault();
    const memberData = {
      memberId: memberIdInput.value,
      name: memberNameInput.value,
      phoneNumber: memberPhoneInput.value,
      membershipType: memberPlanInput.value,
      startDate: memberStartInput.value,
      dueDate: memberDueInput.value,
      isPaid: true
    };

    try {
      if (currentEditingMemberId) {
        // Update member
        const memberDocRef = doc(db, 'artifacts', appId, 'users', userId, 'members', currentEditingMemberId);
        await setDoc(memberDocRef, memberData, { merge: true });
        showMessage('Member updated successfully.', 'success');
      } else {
        // Add new member
        const membersCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'members');
        await addDoc(membersCollectionRef, { ...memberData, createdAt: serverTimestamp() });
        showMessage('New member added successfully.', 'success');
      }
      memberForm.reset();
      currentEditingMemberId = null;
      cancelEditBtn.classList.add('hidden');
      submitMemberBtn.textContent = 'Save';
    } catch (error) {
      console.error("Error adding/updating document:", error);
      showMessage("Failed to save member.", 'error');
    }
  };

  const handleEdit = (id) => {
    const member = allMembers.find(m => m.id === id);
    if (!member) return;
    
    currentEditingMemberId = id;
    memberIdInput.value = member.memberId;
    memberNameInput.value = member.name;
    memberPhoneInput.value = member.phoneNumber;
    memberPlanInput.value = member.membershipType;
    memberStartInput.value = member.startDate;
    memberDueInput.value = member.dueDate;

    submitMemberBtn.textContent = 'Update';
    cancelEditBtn.classList.remove('hidden');
    document.getElementById('view-manage').classList.remove('hidden');
    drawerLinks.forEach(link => link.classList.remove('tab-active'));
    document.querySelector(`[data-target="manage"]`).classList.add('tab-active');
    
    // Scroll to the form
    document.getElementById('view-manage').scrollIntoView({ behavior: 'smooth' });
  };

  const handleRemove = async (id) => {
    // Custom modal-like confirmation
    if (window.confirm('Are you sure you want to remove this member?')) {
        try {
            const memberDocRef = doc(db, 'artifacts', appId, 'users', userId, 'members', id);
            // Mark as removed instead of deleting, for history
            await updateDoc(memberDocRef, { isRemoved: true });
            showMessage('Member marked as removed.', 'success');
        } catch (error) {
            console.error("Error removing member:", error);
            showMessage("Failed to remove member.", 'error');
        }
    }
  };

  const handleMarkPaid = async (id) => {
    const member = allMembers.find(m => m.id === id);
    if (!member) return;

    try {
        const memberDocRef = doc(db, 'artifacts', appId, 'users', userId, 'members', id);
        const paymentsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'payments');

        // Add a new payment record
        await addDoc(paymentsCollectionRef, {
            memberId: member.memberId,
            memberName: member.name,
            plan: member.membershipType,
            amount: getMembershipFee(member.membershipType),
            timestamp: serverTimestamp()
        });
        
        // Update member's due date
        const newDueDate = getDueDate(member.dueDate, member.membershipType);
        await updateDoc(memberDocRef, {
            dueDate: newDueDate,
            isPaid: true
        });

        showMessage(`Payment for ${member.name} applied successfully.`, 'success');
    } catch (error) {
        console.error("Error marking as paid:", error);
        showMessage("Failed to mark as paid.", 'error');
    }
  };
  
  const handleAddPayment = async (e) => {
    e.preventDefault();
    const memberId = addPaymentSelect.value;
    const newMembershipType = addPaymentMembershipType.value;

    if (!memberId || !newMembershipType) {
      showMessage('Please select a member and a plan.', 'error');
      return;
    }

    const member = allMembers.find(m => m.id === memberId);
    if (!member) {
      showMessage('Member not found.', 'error');
      return;
    }
    
    const newDueDate = getDueDate(member.dueDate, newMembershipType);
    
    try {
      const memberDocRef = doc(db, 'artifacts', appId, 'users', userId, 'members', memberId);
      const paymentsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'payments');

      // Add a new payment record
      await addDoc(paymentsCollectionRef, {
          memberId: member.memberId,
          memberName: member.name,
          plan: newMembershipType,
          amount: getMembershipFee(newMembershipType),
          timestamp: serverTimestamp()
      });

      await updateDoc(memberDocRef, {
        dueDate: newDueDate,
        membershipType: newMembershipType,
        isPaid: true
      });
      
      showMessage('Payment added and due date extended.', 'success');
      addPaymentForm.reset();
    } catch (error) {
      console.error("Error adding payment:", error);
      showMessage('Failed to add payment.', 'error');
    }
  };

  // Event Listeners
  window.onload = () => {
    // Current date and time display
    const updateTime = () => {
      const now = new Date();
      document.getElementById('current-time').textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
      document.getElementById('current-day').textContent = now.toLocaleDateString('en-US', { weekday: 'long' });
    };
    updateTime();
    setInterval(updateTime, 1000);

    // Initial view
    document.getElementById('view-dashboard').classList.remove('hidden');
    document.querySelector('[data-target="dashboard"]').classList.add('tab-active');
  };

  // Auth state listener: controls UI visibility
  onAuthStateChanged(auth, (user) => {
    splashScreen.style.display = 'none'; // Hide splash screen regardless
    if (user) {
      // User is signed in
      userId = user.uid;
      authSection.classList.add('hidden');
      mainAppSection.classList.remove('hidden');
      topBar.classList.remove('hidden');
      setupFirestore();
    } else {
      // User is not signed in
      authSection.classList.remove('hidden');
      mainAppSection.classList.add('hidden');
      topBar.classList.add('hidden');
    }
  });

  hamburgerBtn.onclick = () => {
    drawer.classList.add('open');
    document.body.classList.add('drawer-open');
  };

  drawerCloseBtn.onclick = () => {
    drawer.classList.remove('open');
    document.body.classList.remove('drawer-open');
  };

  drawerLinks.forEach(link => {
    link.onclick = (e) => {
      const target = e.currentTarget.dataset.target;
      document.querySelectorAll('main section').forEach(section => {
        section.classList.add('hidden');
      });
      document.getElementById(`view-${target}`).classList.remove('hidden');
      drawerLinks.forEach(l => l.classList.remove('tab-active'));
      e.currentTarget.classList.add('tab-active');
      drawer.classList.remove('open');
      document.body.classList.remove('drawer-open');
    };
  });
  
  signoutButton.onclick = async () => {
    try {
      await signOut(auth);
      // The onAuthStateChanged listener will handle the UI change
    } catch (error) {
      console.error('Sign out error:', error);
    }
  };

  memberStartInput.onchange = () => {
    memberDueInput.value = getDueDate(memberStartInput.value, memberPlanInput.value);
  };
  memberPlanInput.onchange = memberStartInput.onchange;

  memberForm.onsubmit = handleAddOrUpdateMember;
  addPaymentForm.onsubmit = handleAddPayment;
  
  cancelEditBtn.onclick = () => {
    memberForm.reset();
    currentEditingMemberId = null;
    cancelEditBtn.classList.add('hidden');
    submitMemberBtn.textContent = 'Save';
  };
  
  existingStartDate.onchange = () => {
      calculatedDueDate.value = getDueDate(existingStartDate.value, existingMembershipType.value);
  };
  existingMembershipType.onchange = existingStartDate.onchange;

  existingMemberForm.onsubmit = async (e) => {
      e.preventDefault();
      const memberData = {
          memberId: existingMemberIdInput.value,
          name: existingNameInput.value,
          phoneNumber: existingPhoneInput.value,
          membershipType: existingMembershipType.value,
          startDate: existingStartDate.value,
          dueDate: calculatedDueDate.value,
          isPaid: true
      };
      try {
          const membersCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'members');
          await addDoc(membersCollectionRef, { ...memberData, createdAt: serverTimestamp() });
          showMessage('Existing member added successfully.', 'success');
          existingMemberForm.reset();
      } catch (error) {
          console.error("Error adding existing member:", error);
          showMessage("Failed to add existing member.", 'error');
      }
  };

  addPaymentSearch.oninput = () => populatePaymentSelect(addPaymentSearch.value.toLowerCase());
  addPaymentSelect.onchange = () => {
    const member = allMembers.find(m => m.id === addPaymentSelect.value);
    if (member) {
      addPaymentCurrentDue.value = ddmmyyyy(member.dueDate);
    } else {
      addPaymentCurrentDue.value = '';
    }
  };
  addPaymentMembershipType.onchange = () => {
    const member = allMembers.find(m => m.id === addPaymentSelect.value);
    if (!member) return;
    const newDueDate = getDueDate(member.dueDate, addPaymentMembershipType.value);
    addPaymentNewDue.value = ddmmyyyy(newDueDate);
  };

  idCardSearch.oninput = () => populateIdCardSelect(idCardSearch.value.toLowerCase());
  idCardSelect.onchange = () => {
    const m = allMembers.find(x => x.id === idCardSelect.value);
    if (!m) { idCardDisplay.classList.add('hidden'); return; }
    idCardDisplay.classList.remove('hidden');
    idCardName.textContent = m.name || '';
    idCardMemberId.textContent = 'ID: ' + (m.memberId || '');
    idCardPhone.textContent = 'Phone: ' + (m.phoneNumber || '');
    idCardType.textContent = 'Plan: ' + (m.membershipType || '');
    idCardStart.textContent = 'Start: ' + ddmmyyyy(m.startDate);
    idCardDue.textContent = 'Due: ' + ddmmyyyy(m.dueDate);
    idCardFee.textContent = 'Fee: ' + formatCurrency(getMembershipFee(m.membershipType));
    idCardStatus.textContent = 'Status: ' + (getMemberStatus(m) === 'current' ? 'Active' : 'Overdue/Inactive');
  };

  document.getElementById('signin-button').onclick = async () => {
    const password = authPasswordInput.value;
    if (password === '2003') {
        try {
            await signInAnonymously(auth);
            showMessage("Signed in successfully.", 'success');
        } catch (error) {
            console.error("Anonymous sign in failed:", error);
            showMessage("Sign in failed. Please try again.", 'error');
        }
    } else {
        showMessage("Incorrect password.", 'error');
    }
  };
  
  // Search inputs
  document.getElementById('current-search').oninput = (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const filteredMembers = allMembers.filter(m => getMemberStatus(m) === 'current' &&
        ((m.name && m.name.toLowerCase().includes(searchTerm)) || 
         (m.memberId && m.memberId.toLowerCase().includes(searchTerm))));
    renderTable(filteredMembers, currentTbody, 'current');
  };

  document.getElementById('overdue-search').oninput = (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const filteredMembers = allMembers.filter(m => getMemberStatus(m) === 'overdue' &&
        ((m.name && m.name.toLowerCase().includes(searchTerm)) || 
         (m.memberId && m.memberId.toLowerCase().includes(searchTerm))));
    renderTable(filteredMembers, overdue2Tbody, 'overdue2');
  };

  document.getElementById('dash-overdue-search').oninput = (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const filteredMembers = allMembers.filter(m => getMemberStatus(m) === 'overdue' &&
        ((m.name && m.name.toLowerCase().includes(searchTerm)) || 
         (m.memberId && m.memberId.toLowerCase().includes(searchTerm))));
    renderTable(filteredMembers, overdueTbody, 'overdue');
  };

  document.getElementById('inactive-search').oninput = (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const filteredMembers = allMembers.filter(m => getMemberStatus(m) === 'inactive' &&
        ((m.name && m.name.toLowerCase().includes(searchTerm)) || 
         (m.memberId && m.memberId.toLowerCase().includes(searchTerm))));
    renderTable(filteredMembers, inactiveTbody, 'inactive');
  };

  document.getElementById('payments-search').oninput = (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const paymentsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'payments');
    
    // Listen for changes in the members collection
    onSnapshot(paymentsCollectionRef, (querySnapshot) => {
      const payments = [];
      querySnapshot.forEach((doc) => {
        payments.push({ id: doc.id, ...doc.data() });
      });
      
      const filteredPayments = payments.filter(p => (p.memberName && p.memberName.toLowerCase().includes(searchTerm)) || 
                                                     (p.memberId && p.memberId.toLowerCase().includes(searchTerm)));
      renderPaymentsTable(filteredPayments);
    }, (error) => {
      console.error("Error fetching filtered payments:", error);
      showMessage("Error fetching payments.", 'error');
    });
  };

</script>
</body>
</html>
      <div class="p-4 rounded-xl border border-gray-700 bg-gray-800 text-center">
        <div class="text-xs text-gray-400">Inactive 💤</div>
        <div id="count-inactive" class="text-2xl font-bold text-yellow-300">0</div>
      </div>
      <div class="p-4 rounded-xl border border-gray-700 bg-gray-800 text-center">
        <div class="text-xs text-gray-400">Paid</div>
        <div id="count-paid" class="text-2xl font-bold text-emerald-300">0</div>
      </div>
    </div>

    <!-- Expanded Overdue -->
    <div class="bg-gray-800 border border-red-800 rounded-xl">
      <div class="flex items-center justify-between p-4">
        <h3 class="text-lg font-bold text-red-400">Overdue Members</h3>
        <input id="dash-overdue-search" placeholder="Search overdue…" class="p-2 bg-gray-900 border border-gray-700 rounded w-60">
      </div>
      <div id="overdue-container" class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-red-900">
            <tr>
              <th class="px-4 py-2 text-left text-red-200">Photo</th>
              <th class="px-4 py-2 text-left text-red-200">Member ID</th>
              <th class="px-4 py-2 text-left text-red-200">Name</th>
              <th class="px-4 py-2 text-left text-red-200">Phone</th>
              <th class="px-4 py-2 text-left text-red-200">Type</th>
              <th class="px-4 py-2 text-left text-red-200">Start</th>
              <th class="px-4 py-2 text-left text-red-200">Due</th>
              <th class="px-4 py-2 text-left text-red-200">Days Overdue</th>
              <th class="px-4 py-2 text-left text-red-200">Actions</th>
            </tr>
          </thead>
          <tbody id="overdue-tbody" class="divide-y divide-gray-700"></tbody>
        </table>
        <p id="no-overdue" class="p-4 text-center text-gray-400 hidden">No overdue members. 🎉</p>
      </div>
    </div>
  </section>

  <!-- Current Members -->
  <section id="view-current" class="space-y-4 hidden">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-bold">Current Members</h3>
      <input id="current-search" placeholder="Search current…" class="p-2 bg-gray-900 border border-gray-700 rounded w-60">
    </div>
    <div class="overflow-x-auto rounded-xl border border-gray-700">
      <table class="min-w-full text-sm">
        <thead class="bg-indigo-900">
          <tr>
            <th class="px-4 py-2 text-left text-indigo-200">Photo</th>
            <th class="px-4 py-2 text-left text-indigo-200">Member ID</th>
            <th class="px-4 py-2 text-left text-indigo-200">Name</th>
            <th class="px-4 py-2 text-left text-indigo-200">Phone</th>
            <th class="px-4 py-2 text-left text-indigo-200">Type</th>
            <th class="px-4 py-2 text-left text-indigo-200">Start</th>
            <th class="px-4 py-2 text-left text-indigo-200">Due</th>
            <th class="px-4 py-2 text-left text-indigo-200">Days Left</th>
            <th class="px-4 py-2 text-left text-indigo-200">Actions</th>
          </tr>
        </thead>
        <tbody id="current-tbody" class="divide-y divide-gray-700"></tbody>
      </table>
      <p id="no-current" class="p-4 text-center text-gray-400 hidden">No current members.</p>
    </div>
  </section>

  <!-- Overdue (separate view) -->
  <section id="view-overdue" class="space-y-4 hidden">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-bold text-red-400">Overdue</h3>
      <input id="overdue-search" placeholder="Search overdue…" class="p-2 bg-gray-900 border border-gray-700 rounded w-60">
    </div>
    <div class="overflow-x-auto rounded-xl border border-red-800">
      <table class="min-w-full text-sm">
        <thead class="bg-red-900">
          <tr>
            <th class="px-4 py-2 text-left text-red-200">Photo</th>
            <th class="px-4 py-2 text-left text-red-200">Member ID</th>
            <th class="px-4 py-2 text-left text-red-200">Name</th>
            <th class="px-4 py-2 text-left text-red-200">Phone</th>
            <th class="px-4 py-2 text-left text-red-200">Type</th>
            <th class="px-4 py-2 text-left text-red-200">Start</th>
            <th class="px-4 py-2 text-left text-red-200">Due</th>
            <th class="px-4 py-2 text-left text-red-200">Days Overdue</th>
            <th class="px-4 py-2 text-left text-red-200">Actions</th>
          </tr>
        </thead>
        <tbody id="overdue2-tbody" class="divide-y divide-gray-700"></tbody>
      </table>
      <p id="no-overdue2" class="p-4 text-center text-gray-400 hidden">No overdue members.</p>
    </div>
  </section>

  <!-- Inactive -->
  <section id="view-inactive" class="space-y-4 hidden">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-bold text-yellow-300">Inactive Members 💤</h3>
      <input id="inactive-search" placeholder="Search inactive…" class="p-2 bg-gray-900 border border-gray-700 rounded w-60">
    </div>
    <div class="overflow-x-auto rounded-xl border border-yellow-700">
      <table class="min-w-full text-sm">
        <thead class="bg-yellow-900">
          <tr>
            <th class="px-4 py-2 text-left text-yellow-200">Photo</th>
            <th class="px-4 py-2 text-left text-yellow-200">Member ID</th>
            <th class="px-4 py-2 text-left text-yellow-200">Name</th>
            <th class="px-4 py-2 text-left text-yellow-200">Phone</th>
            <th class="px-4 py-2 text-left text-yellow-200">Last Type</th>
            <th class="px-4 py-2 text-left text-yellow-200">Start</th>
            <th class="px-4 py-2 text-left text-yellow-200">Due</th>
            <th class="px-4 py-2 text-left text-yellow-200">Status</th>
            <th class="px-4 py-2 text-left text-yellow-200">Actions</th>
          </tr>
        </thead>
        <tbody id="inactive-tbody" class="divide-y divide-gray-700"></tbody>
      </table>
      <p id="no-inactive" class="p-4 text-center text-gray-400 hidden">No inactive members.</p>
    </div>
  </section>

  <!-- Payment History -->
  <section id="view-payment-history" class="space-y-4 hidden">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-bold">Payment History</h3>
      <input id="payment-history-search" placeholder="Search payments…" class="p-2 bg-gray-900 border border-gray-700 rounded w-60">
    </div>
    <div class="overflow-x-auto rounded-xl border border-gray-700">
      <table class="min-w-full text-sm">
        <thead class="bg-indigo-900">
          <tr>
            <th class="px-4 py-2 text-left text-indigo-200">S.No.</th>
            <th class="px-4 py-2 text-left text-indigo-200">Member ID</th>
            <th class="px-4 py-2 text-left text-indigo-200">Name</th>
            <th class="px-4 py-2 text-left text-indigo-200">Membership Type</th>
            <th class="px-4 py-2 text-left text-indigo-200">Payment Date</th>
          </tr>
        </thead>
        <tbody id="payment-history-tbody" class="divide-y divide-gray-700"></tbody>
      </table>
      <p id="no-payment-history" class="p-4 text-center text-gray-400 hidden">No payment history found.</p>
    </div>
  </section>

  <!-- Manage Member (add/update) -->
  <section id="view-manage" class="hidden">
    <h3 class="text-lg font-bold mb-2">Manage Member Details</h3>
    <form id="member-form" class="grid sm:grid-cols-2 gap-4 bg-gray-800 border border-gray-700 p-4 rounded-xl">
      <input id="member-id" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="Member ID" required>
      <input id="member-name" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="Name" required>
      <input id="member-phone" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="Phone">
      <select id="member-plan" class="p-3 bg-gray-900 border border-gray-700 rounded">
        <option>Monthly</option><option>Quarterly</option><option>HalfYearly</option><option>Annual</option>
      </select>
      <input id="member-start" type="date" class="p-3 bg-gray-900 border border-gray-700 rounded" required>
      <input id="member-due" type="date" class="p-3 bg-gray-900 border border-gray-700 rounded" readonly>
      <div class="sm:col-span-2">
        <label for="member-photo" class="text-sm block mb-1">Upload Photo</label>
        <input id="member-photo" type="file" accept="image/*" class="w-full text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"/>
      </div>
      <div class="sm:col-span-2 flex gap-2">
        <button id="submit-member" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded">Save</button>
        <button id="cancel-edit" type="button" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded hidden">Cancel Edit</button>
      </div>
    </form>
  </section>

  <!-- Add Existing -->
  <section id="view-existing" class="hidden">
    <h3 class="text-lg font-bold mb-2">Add Existing Member</h3>
    <form id="existing-member-form" class="grid sm:grid-cols-2 gap-4 bg-gray-800 border border-gray-700 p-4 rounded-xl">
      <input id="existing-member-id" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="Member ID" required>
      <input id="existing-name" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="Name" required>
      <input id="existing-phone-number" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="Phone">
      <select id="existing-membershipType" class="p-3 bg-gray-900 border border-gray-700 rounded">
        <option>Monthly</option><option>Quarterly</option><option>HalfYearly</option><option>Annual</option>
      </select>
      <input id="existing-startDate" type="date" class="p-3 bg-gray-900 border border-gray-700 rounded" required>
      <input id="calculated-dueDate" type="date" class="p-3 bg-gray-900 border border-gray-700 rounded" readonly>
      <div class="sm:col-span-2">
        <label for="existing-photo" class="text-sm block mb-1">Upload Photo</label>
        <input id="existing-photo" type="file" accept="image/*" class="w-full text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"/>
      </div>
      <button class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded sm:col-span-2">Add</button>
    </form>
  </section>

  <!-- Add Payment -->
  <section id="view-payment" class="hidden">
    <h3 class="text-lg font-bold mb-2">Add Payment / Extend</h3>
    <form id="add-payment-form" class="grid sm:grid-cols-2 gap-4 bg-gray-800 border border-gray-700 p-4 rounded-xl">
      <input id="add-payment-member-search" class="p-3 bg-gray-900 border border-gray-700 rounded sm:col-span-2" placeholder="Search member…">
      <select id="add-payment-member-select" class="p-3 bg-gray-900 border border-gray-700 rounded sm:col-span-2"></select>
      <input id="add-payment-current-dueDate" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="Current Due" readonly>
      <select id="add-payment-membershipType" class="p-3 bg-gray-900 border border-gray-700 rounded">
        <option>Monthly</option><option>Quarterly</option><option>HalfYearly</option><option>Annual</option>
      </select>
      <input id="add-payment-new-dueDate" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="New Due" readonly>
      <button class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded sm:col-span-2">Apply Payment</button>
    </form>
  </section>

  <!-- ID Card -->
  <section id="view-idcard" class="hidden">
    <h3 class="text-lg font-bold mb-2">ID Card</h3>
    <div class="grid sm:grid-cols-2 gap-4 bg-gray-800 border border-gray-700 p-4 rounded-xl">
      <input id="id-card-member-search" class="p-3 bg-gray-900 border border-gray-700 rounded sm:col-span-2" placeholder="Search member…">
      <select id="id-card-member-select" class="p-3 bg-gray-900 border border-gray-700 rounded sm:col-span-2"></select>
      <div id="id-card-display" class="sm:col-span-2 hidden">
        <div class="p-4 rounded-lg bg-gray-900 border border-gray-700">
          <div class="font-mono text-sm" id="id-card-member-id"></div>
          <div class="text-xl font-bold" id="id-card-name"></div>
          <div id="id-card-phone"></div>
          <div id="id-card-membership-type"></div>
          <div id="id-card-start-date"></div>
          <div id="id-card-due-date"></div>
          <div id="id-card-fee"></div>
          <div id="id-card-status"></div>
        </div>
      </div>
      <p id="no-id-card-selected-message" class="sm:col-span-2 text-gray-400">Choose a member to view the ID card.</p>
    </div>
  </section>

</main>

<!-- Reactivate Modal -->
<div id="reactivate-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
  <div class="bg-gray-800 border border-gray-700 p-6 rounded-xl w-full max-w-sm">
    <h3 class="text-lg font-semibold mb-3">Reactivate Member</h3>
    <p id="reactivate-who" class="text-sm text-gray-300 mb-3"></p>
    <label class="text-sm mb-1 block">Choose plan</label>
    <select id="reactivate-plan" class="w-full p-3 bg-gray-900 border border-gray-700 rounded mb-4">
      <option>Monthly</option><option>Quarterly</option><option>HalfYearly</option><option>Annual</option>
    </select>
    <div class="flex gap-2">
      <button id="reactivate-confirm" class="flex-1 px-3 py-2 bg-emerald-600 hover:bg-emerald-700 rounded">Reactivate</button>
      <button id="reactivate-cancel" class="flex-1 px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded">Cancel</button>
    </div>
  </div>
</div>

<!-- Custom Confirmation Modal for Deletion -->
<div id="confirm-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
  <div class="bg-gray-800 border border-gray-700 p-6 rounded-xl w-full max-w-sm">
    <h3 class="text-lg font-semibold mb-3">Confirm Deletion</h3>
    <p id="confirm-who" class="text-sm text-gray-300 mb-3">Are you sure you want to delete this member? This action cannot be undone.</p>
    <div class="flex gap-2">
      <button id="confirm-yes" class="flex-1 px-3 py-2 bg-red-600 hover:bg-red-700 rounded">Delete</button>
      <button id="confirm-no" class="flex-1 px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded">Cancel</button>
    </div>
  </div>
</div>

<!-- Notifications -->
<div id="message-display" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 border border-gray-700 px-4 py-2 rounded-lg hidden"></div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, getDocs, query, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  
  // =======================================================================
  // IMPORTANT: THIS IS YOUR FIREBASE CONFIGURATION
  // It has been populated with the values you provided.
  // DO NOT EDIT THIS UNLESS YOU WANT TO CHANGE THE LINKED PROJECT.
  // =======================================================================
  const firebaseConfig = {
    apiKey: "AIzaSyA1cOHWVufQV6ruZv3LmgdqfRNPGjyzsEI",
    authDomain: "alpha-core-fitness-data.firebaseapp.com",
    projectId: "alpha-core-fitness-data",
    storageBucket: "alpha-core-fitness-data.firebasestorage.app",
    messagingSenderId: "311733734225",
    appId: "1:311733734225:web:697ef2dc197ebb2e662170",
    measurementId: "G-C5EKPN2K2J" // This will be ignored as getAnalytics is not imported.
  };
  
  const appId = firebaseConfig.projectId;

  const firebaseApp = initializeApp(firebaseConfig);
  const db = getFirestore(firebaseApp);
  const auth = getAuth(firebaseApp);

  let userId;
  let allMembers = [];
  let currentMembers = [];
  let overdueMembers = [];
  let inactiveMembers = [];
  let allPayments = [];

  // DOM elements
  const splashScreen = document.getElementById('splash-screen');
  const topBar = document.getElementById('top-bar');
  const mainAppSection = document.getElementById('main-app-section');
  const hamburgerBtn = document.getElementById('hamburger-btn');
  const hamburgerDrawer = document.getElementById('hamburger-drawer');
  const drawerCloseBtn = document.getElementById('drawer-close');
  const drawerLinks = document.querySelectorAll('.drawer-link');
  const signoutButton = document.getElementById('signout-button');
  const appPasswordInput = document.getElementById('app-password-input');
  const submitAppPasswordButton = document.getElementById('submit-app-password');
  const passwordEntryModal = document.getElementById('password-entry-modal');
  const messageDisplay = document.getElementById('message-display');
  const userIdDisplay = document.getElementById('user-id-display');
  const memberForm = document.getElementById('member-form');
  const memberIdInput = document.getElementById('member-id');
  const memberNameInput = document.getElementById('member-name');
  const memberPhoneInput = document.getElementById('member-phone');
  const memberPlanSelect = document.getElementById('member-plan');
  const memberStartInput = document.getElementById('member-start');
  const memberDueInput = document.getElementById('member-due');
  const memberPhotoInput = document.getElementById('member-photo');
  const submitMemberButton = document.getElementById('submit-member');
  const cancelEditButton = document.getElementById('cancel-edit');
  const existingMemberForm = document.getElementById('existing-member-form');
  const existingMemberIdInput = document.getElementById('existing-member-id');
  const existingNameInput = document.getElementById('existing-name');
  const existingPhoneNumberInput = document.getElementById('existing-phone-number');
  const existingMembershipTypeSelect = document.getElementById('existing-membershipType');
  const existingStartDateInput = document.getElementById('existing-startDate');
  const existingPhotoInput = document.getElementById('existing-photo');
  const calculatedDueDateInput = document.getElementById('calculated-dueDate');
  const addPaymentForm = document.getElementById('add-payment-form');
  const addPaymentMemberSearchInput = document.getElementById('add-payment-member-search');
  const addPaymentMemberSelect = document.getElementById('add-payment-member-select');
  const addPaymentCurrentDueDateInput = document.getElementById('add-payment-current-dueDate');
  const addPaymentMembershipTypeSelect = document.getElementById('add-payment-membershipType');
  const addPaymentNewDueDateInput = document.getElementById('add-payment-new-dueDate');
  const idCardMemberSearch = document.getElementById('id-card-member-search');
  const idCardMemberSelect = document.getElementById('id-card-member-select');
  const idCardDisplay = document.getElementById('id-card-display');
  const idCardName = document.getElementById('id-card-name');
  const idCardMemberId = document.getElementById('id-card-member-id');
  const idCardPhone = document.getElementById('id-card-phone');
  const idCardType = document.getElementById('id-card-membership-type');
  const idCardStart = document.getElementById('id-card-start-date');
  const idCardDue = document.getElementById('id-card-due-date');
  const idCardFee = document.getElementById('id-card-fee');
  const idCardStatus = document.getElementById('id-card-status');
  const noIdCardSelectedMessage = document.getElementById('no-id-card-selected-message');
  const reactivateModal = document.getElementById('reactivate-modal');
  const reactivateWho = document.getElementById('reactivate-who');
  const reactivatePlan = document.getElementById('reactivate-plan');
  const reactivateConfirm = document.getElementById('reactivate-confirm');
  const reactivateCancel = document.getElementById('reactivate-cancel');
  const countCurrent = document.getElementById('count-current');
  const countOverdue = document.getElementById('count-overdue');
  const countInactive = document.getElementById('count-inactive');
  const countPaid = document.getElementById('count-paid');
  const dashOverdueSearch = document.getElementById('dash-overdue-search');
  const overdueTbody = document.getElementById('overdue-tbody');
  const noOverdue = document.getElementById('no-overdue');
  const currentSearch = document.getElementById('current-search');
  const currentTbody = document.getElementById('current-tbody');
  const noCurrent = document.getElementById('no-current');
  const overdueSearch = document.getElementById('overdue-search');
  const overdue2Tbody = document.getElementById('overdue2-tbody');
  const noOverdue2 = document.getElementById('no-overdue2');
  const inactiveSearch = document.getElementById('inactive-search');
  const inactiveTbody = document.getElementById('inactive-tbody');
  const noInactive = document.getElementById('no-inactive');
  const confirmModal = document.getElementById('confirm-modal');
  const confirmWho = document.getElementById('confirm-who');
  const confirmYes = document.getElementById('confirm-yes');
  const confirmNo = document.getElementById('confirm-no');
  const paymentHistorySearch = document.getElementById('payment-history-search');
  const paymentHistoryTbody = document.getElementById('payment-history-tbody');
  const noPaymentHistory = document.getElementById('no-payment-history');
  
  let currentEditMemberId = null;
  let memberToDeleteId = null;

  // CLOUDINARY CONFIGURATION
  const CLOUDINARY_CLOUD_NAME = 'dlt0f5v7c'; // Cloudinary cloud name
  const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
  
  // App password for authentication
  const APP_PASSWORD = '2003';

  // Splash screen timeout
  window.onload = () => {
    setTimeout(() => {
      splashScreen.classList.add('hidden');
      passwordEntryModal.classList.remove('hidden');
    }, 2500);
  };

  // Utility functions
  function showMessage(msg, type = 'info') {
    messageDisplay.textContent = msg;
    messageDisplay.className = `fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg z-50 animate-bounce`;
    if (type === 'error') {
      messageDisplay.classList.add('bg-red-800', 'border', 'border-red-700');
    } else {
      messageDisplay.classList.add('bg-gray-800', 'border', 'border-gray-700');
    }
    messageDisplay.classList.remove('hidden');
    setTimeout(() => {
      messageDisplay.classList.add('hidden');
    }, 3000);
  }

  function daysBetween(d1, d2) {
    const diff = new Date(d2).getTime() - new Date(d1).getTime();
    return Math.ceil(diff / (1000 * 60 * 60 * 24));
  }

  function ddmmyyyy(isoDate) {
    if (!isoDate) return '';
    const date = new Date(isoDate);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  }

  function calculateDueDate(startDate, plan) {
    if (!startDate) return null;
    const date = new Date(startDate);
    switch (plan) {
      case 'Monthly': date.setMonth(date.getMonth() + 1); break;
      case 'Quarterly': date.setMonth(date.getMonth() + 3); break;
      case 'HalfYearly': date.setMonth(date.getMonth() + 6); break;
      case 'Annual': date.setFullYear(date.getFullYear() + 1); break;
    }
    return date.toISOString().split('T')[0];
  }

  function updateMainView(viewId) {
    const sections = document.querySelectorAll('main section');
    sections.forEach(sec => sec.classList.add('hidden'));
    document.getElementById(`view-${viewId}`).classList.remove('hidden');
  }

  // Cloudinary image upload helper
  async function uploadImage(file) {
      if (!file) return null;
      showMessage('Uploading photo...', 'info');

      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', 'ml_default'); // Use the default unsigned upload preset

      try {
          const response = await fetch(CLOUDINARY_UPLOAD_URL, {
              method: 'POST',
              body: formData,
          });

          if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Cloudinary upload failed: ${response.status} ${response.statusText} - ${errorText}`);
          }

          const data = await response.json();
          showMessage('Photo uploaded!', 'info');
          return data.secure_url;
      } catch (error) {
          console.error('Error uploading to Cloudinary:', error);
          showMessage(`Photo upload failed: ${error.message}`, 'error');
          return null;
      }
  }

  // Firebase Authentication
  
  // This listener is for handling initial app load and signouts.
  // The initial login logic is now handled directly in the password submission.
  onAuthStateChanged(auth, (user) => {
    if (user) {
        // If a user is found (e.g., from a persisted session), show the main app
        passwordEntryModal.classList.add('hidden');
        mainAppSection.classList.remove('hidden');
        topBar.classList.remove('hidden');
        userId = user.uid;
        userIdDisplay.textContent = userId; // Display the user ID
        console.log("Authentication successful. User ID:", userId);
        setupFirestoreListeners(userId);
    } else {
        // If no user is signed in, show the password modal
        mainAppSection.classList.add('hidden');
        topBar.classList.add('hidden');
        userIdDisplay.textContent = '...';
        console.log("User is not authenticated. Showing password screen.");
    }
  });

  submitAppPasswordButton.addEventListener('click', async () => {
    if (appPasswordInput.value === APP_PASSWORD) {
      showMessage('App password correct! Signing in...');
      try {
        await signInAnonymously(auth);
        // After successful sign-in, the onAuthStateChanged listener will fire and handle the UI change.
      } catch (error) {
        console.error("Anonymous sign in failed: ", error);
        showMessage("Failed to sign in. Check your Firebase config.", 'error');
      }
    } else {
      showMessage('Incorrect app password.', 'error');
    }
  });

  signoutButton.addEventListener('click', async () => {
    await signOut(auth);
    showMessage('Signed out.');
    // The onAuthStateChanged listener will handle hiding the main app and showing the password modal.
  });

  // Firebase and Firestore Logic
  async function setupFirestoreListeners(uid) {
    const membersCollectionRef = collection(db, 'artifacts', appId, 'users', uid, 'members');
    const paymentsCollectionRef = collection(db, 'artifacts', appId, 'users', uid, 'payments');

    // Listen for real-time updates to members collection
    onSnapshot(membersCollectionRef, (snapshot) => {
      allMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      const today = new Date();
      
      currentMembers = allMembers.filter(m => {
        if (!m.status || m.status === 'Active') {
          return m.dueDate && new Date(m.dueDate) >= today;
        }
        return false;
      });
      
      overdueMembers = allMembers.filter(m => {
        return m.dueDate && new Date(m.dueDate) < today && new Date(m.dueDate) >= new Date(today.getTime() - (90 * 24 * 60 * 60 * 1000));
      });
      
      inactiveMembers = allMembers.filter(m => {
        return m.status === 'Inactive' || (m.dueDate && new Date(m.dueDate) < new Date(today.getTime() - (90 * 24 * 60 * 60 * 1000)));
      });
      
      countCurrent.textContent = currentMembers.length;
      countOverdue.textContent = overdueMembers.length;
      countInactive.textContent = inactiveMembers.length;
      countPaid.textContent = allMembers.length - overdueMembers.length - inactiveMembers.length;
      
      renderTables();
      populateSelects();
    }, (error) => {
      console.error("Error fetching data: ", error);
      showMessage("Failed to load data. Please check your connection.", "error");
    });
    
    // Listen for real-time updates to payments collection
    onSnapshot(paymentsCollectionRef, (snapshot) => {
      allPayments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderPaymentHistory();
    }, (error) => {
      console.error("Error fetching payments: ", error);
      showMessage("Failed to load payment history.", "error");
    });
  }

  async function addMember(memberData) {
    try {
      const membersCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'members');
      const docRef = await addDoc(membersCollectionRef, {
        ...memberData,
        createdAt: serverTimestamp(),
      });
      
      // Add initial payment record
      const paymentsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'payments');
      await addDoc(paymentsCollectionRef, {
          memberId: memberData.memberId,
          memberName: memberData.name,
          membershipType: memberData.membershipType,
          paymentDate: new Date(memberData.startDate),
          createdAt: serverTimestamp(),
      });

      showMessage('Member added successfully!');
    } catch (error) {
      console.error("Error adding document: ", error);
      showMessage('Failed to add member.', 'error');
    }
  }

  async function updateMember(docId, memberData) {
    try {
      const memberDocRef = doc(db, 'artifacts', appId, 'users', userId, 'members', docId);
      await updateDoc(memberDocRef, {
        ...memberData,
        updatedAt: serverTimestamp(),
      });
      showMessage('Member updated successfully!');
    } catch (error) {
      console.error("Error updating document: ", error);
      showMessage('Failed to update member.', 'error');
    }
  }

  async function deleteMember(docId) {
    try {
      const memberDocRef = doc(db, 'artifacts', appId, 'users', userId, 'members', docId);
      await deleteDoc(memberDocRef);
      showMessage('Member deleted successfully!');
    } catch (error) {
      console.error("Error deleting document: ", error);
      showMessage('Failed to delete member.', 'error');
    }
  }
  
  // DOM Rendering functions
  function renderMemberTable(tableBody, members, query, memberClass, daysCalc) {
    tableBody.innerHTML = '';
    const filteredMembers = members.filter(m => JSON.stringify(m).toLowerCase().includes(query.toLowerCase()));
    
    if (filteredMembers.length === 0) {
      const noDataElement = tableBody.nextElementSibling;
      if (noDataElement) noDataElement.classList.remove('hidden');
    } else {
      const noDataElement = tableBody.nextElementSibling;
      if (noDataElement) noDataElement.classList.add('hidden');
      
      filteredMembers.forEach(member => {
        const row = document.createElement('tr');
        row.classList.add(memberClass, 'border-b', 'border-gray-700');
        
        const photoUrl = member.photoURL || `https://placehold.co/50x50/1f2937/d1d5db?text=No+Photo`;
        const days = daysCalc(member);

        row.innerHTML = `
          <td class="px-4 py-2"><img src="${photoUrl}" alt="${member.name}" class="h-10 w-10 rounded-full object-cover"/></td>
          <td class="px-4 py-2 font-mono text-sm">${member.memberId || ''}</td>
          <td class="px-4 py-2">${member.name || ''}</td>
          <td class="px-4 py-2">${member.phoneNumber || ''}</td>
          <td class="px-4 py-2">${member.membershipType || ''}</td>
          <td class="px-4 py-2">${ddmmyyyy(member.startDate)}</td>
          <td class="px-4 py-2">${ddmmyyyy(member.dueDate)}</td>
          <td class="px-4 py-2 font-bold">${days}</td>
          <td class="px-4 py-2 space-x-2">
            <button data-action="edit" data-id="${member.id}" class="bg-indigo-600 hover:bg-indigo-700 text-white px-2 py-1 rounded">Edit</button>
            <button data-action="reactivate" data-id="${member.id}" class="bg-emerald-600 hover:bg-emerald-700 text-white px-2 py-1 rounded">Reactivate</button>
            <button data-action="delete" data-id="${member.id}" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded">Delete</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }
  }

  function renderPaymentHistory() {
    paymentHistoryTbody.innerHTML = '';
    const query = paymentHistorySearch.value.toLowerCase();
    
    const filteredPayments = allPayments.filter(p => 
      (p.memberName && p.memberName.toLowerCase().includes(query)) ||
      (p.memberId && p.memberId.toLowerCase().includes(query))
    ).sort((a,b) => b.createdAt.toDate() - a.createdAt.toDate());

    if (filteredPayments.length === 0) {
      noPaymentHistory.classList.remove('hidden');
    } else {
      noPaymentHistory.classList.add('hidden');
      filteredPayments.forEach((payment, index) => {
        const row = document.createElement('tr');
        row.classList.add('bg-gray-800', 'border-b', 'border-gray-700');
        row.innerHTML = `
          <td class="px-4 py-2">${index + 1}</td>
          <td class="px-4 py-2">${payment.memberId || ''}</td>
          <td class="px-4 py-2">${payment.memberName || ''}</td>
          <td class="px-4 py-2">${payment.membershipType || ''}</td>
          <td class="px-4 py-2">${payment.createdAt ? ddmmyyyy(payment.createdAt.toDate()) : 'N/A'}</td>
        `;
        paymentHistoryTbody.appendChild(row);
      });
    }
  }
  
  function renderTables() {
    renderMemberTable(overdueTbody, overdueMembers, dashOverdueSearch.value, 'row-overdue', m => daysBetween(m.dueDate, new Date().toISOString().split('T')[0]));
    renderMemberTable(currentTbody, currentMembers, currentSearch.value, 'row-normal', m => daysBetween(new Date().toISOString().split('T')[0], m.dueDate));
    renderMemberTable(overdue2Tbody, overdueMembers, overdueSearch.value, 'row-overdue', m => daysBetween(m.dueDate, new Date().toISOString().split('T')[0]));
    renderMemberTable(inactiveTbody, inactiveMembers, inactiveSearch.value, 'row-inactive', m => m.status || 'Inactive');
    renderPaymentHistory();
  }

  function populateSelects() {
    // Add Payment Select
    const paymentList = allMembers.filter(m => new Date(m.dueDate) >= new Date()).sort((a,b)=>a.name.localeCompare(b.name));
    addPaymentMemberSelect.innerHTML = '<option value="">Select member…</option>' + paymentList.map(m=>`<option value="${m.id}">${m.name} (${m.memberId})</option>`).join('');
    
    // ID Card Select
    const idCardList = allMembers.sort((a,b)=>a.name.localeCompare(b.name));
    idCardMemberSelect.innerHTML = '<option value="">Select member…</option>' + idCardList.map(m=>`<option value="${m.id}">${m.name} (${m.memberId})</option>`).join('');
  }
  
  // Event listeners
  hamburgerBtn.addEventListener('click', () => {
    hamburgerDrawer.classList.toggle('open');
    document.body.classList.toggle('drawer-open');
  });

  drawerCloseBtn.addEventListener('click', () => {
    hamburgerDrawer.classList.remove('open');
    document.body.classList.remove('drawer-open');
  });

  drawerLinks.forEach(link => {
    link.addEventListener('click', (e) => {
      const target = e.currentTarget.dataset.target;
      updateMainView(target);
      hamburgerDrawer.classList.remove('open');
      document.body.classList.remove('drawer-open');
    });
  });

  // Handle table actions (edit, reactivate, delete)
  document.addEventListener('click', async (e) => {
    if (e.target.dataset.action === 'edit') {
      const memberId = e.target.dataset.id;
      const member = allMembers.find(m => m.id === memberId);
      if (member) {
        currentEditMemberId = member.id;
        memberIdInput.value = member.memberId || '';
        memberNameInput.value = member.name || '';
        memberPhoneInput.value = member.phoneNumber || '';
        memberPlanSelect.value = member.membershipType || 'Monthly';
        memberStartInput.value = member.startDate;
        memberDueInput.value = member.dueDate;
        
        memberIdInput.readOnly = true;
        submitMemberButton.textContent = 'Update';
        cancelEditButton.classList.remove('hidden');
        updateMainView('manage');
      }
    } else if (e.target.dataset.action === 'reactivate') {
      const memberId = e.target.dataset.id;
      const member = allMembers.find(m => m.id === memberId);
      if (member) {
        reactivateModal.dataset.memberId = memberId;
        reactivateWho.textContent = `Reactivate ${member.name} (${member.memberId})`;
        reactivatePlan.value = member.membershipType || 'Monthly';
        reactivateModal.classList.remove('hidden');
      }
    } else if (e.target.dataset.action === 'delete') {
      const memberId = e.target.dataset.id;
      const member = allMembers.find(m => m.id === memberId);
      if (member) {
        memberToDeleteId = memberId;
        confirmWho.textContent = `Are you sure you want to delete ${member.name}? This action cannot be undone.`;
        confirmModal.classList.remove('hidden');
      }
    }
  });

  // Handle confirmation modal buttons
  confirmYes.addEventListener('click', async () => {
    if (memberToDeleteId) {
      await deleteMember(memberToDeleteId);
      memberToDeleteId = null;
    }
    confirmModal.classList.add('hidden');
  });

  confirmNo.addEventListener('click', () => {
    memberToDeleteId = null;
    confirmModal.classList.add('hidden');
  });


  // Form submission
  memberForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const photoFile = memberPhotoInput.files[0];
    const photoURL = await uploadImage(photoFile);

    const memberData = {
      memberId: memberIdInput.value,
      name: memberNameInput.value,
      phoneNumber: memberPhoneInput.value,
      membershipType: memberPlanSelect.value,
      startDate: memberStartInput.value,
      dueDate: memberDueInput.value,
      photoURL: photoURL
    };

    if (currentEditMemberId) {
      await updateMember(currentEditMemberId, memberData);
      currentEditMemberId = null;
      memberIdInput.readOnly = false;
      memberForm.reset();
      submitMemberButton.textContent = 'Update';
      cancelEditButton.classList.add('hidden');
    } else {
      await addMember(memberData);
      memberForm.reset();
    }
  });
  
  existingMemberForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const photoFile = existingPhotoInput.files[0];
    const photoURL = await uploadImage(photoFile);
    
    const memberData = {
      memberId: existingMemberIdInput.value,
      name: existingNameInput.value,
      phoneNumber: existingPhoneNumberInput.value,
      membershipType: existingMembershipTypeSelect.value,
      startDate: existingStartDateInput.value,
      dueDate: calculatedDueDateInput.value,
      photoURL: photoURL
    };
    
    await addMember(memberData);
    existingMemberForm.reset();
  });
  
  addPaymentForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const memberId = addPaymentMemberSelect.value;
    const membershipType = addPaymentMembershipTypeSelect.value;
    
    if (memberId) {
      const member = allMembers.find(m => m.id === memberId);
      const newDueDate = calculateDueDate(member.dueDate, membershipType);
      
      await updateMember(memberId, { dueDate: newDueDate, membershipType: membershipType, status: 'Active' });
      
      const paymentsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'payments');
      await addDoc(paymentsCollectionRef, {
        memberId: member.memberId,
        memberName: member.name,
        membershipType: membershipType,
        paymentDate: new Date(),
        createdAt: serverTimestamp(),
      });
      
      addPaymentForm.reset();
    }
  });

  reactivateConfirm.addEventListener('click', async () => {
    const memberId = reactivateModal.dataset.memberId;
    const member = allMembers.find(m => m.id === memberId);
    if (member) {
      const plan = reactivatePlan.value;
      const today = new Date().toISOString().split('T')[0];
      const newDueDate = calculateDueDate(today, plan);
      
      await updateMember(memberId, {
        membershipType: plan,
        startDate: today,
        dueDate: newDueDate,
        status: 'Active'
      });
      
      const paymentsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'payments');
      await addDoc(paymentsCollectionRef, {
        memberId: member.memberId,
        memberName: member.name,
        membershipType: plan,
        paymentDate: new Date(),
        createdAt: serverTimestamp(),
      });
      
      reactivateModal.classList.add('hidden');
    }
  });
  
  reactivateCancel.addEventListener('click', () => {
    reactivateModal.classList.add('hidden');
  });

  cancelEditButton.addEventListener('click', () => {
    currentEditMemberId = null;
    memberIdInput.readOnly = false;
    memberForm.reset();
    submitMemberButton.textContent = 'Save';
    cancelEditButton.classList.add('hidden');
  });

  // Auto-calculate due date
  memberStartInput.addEventListener('change', () => {
    memberDueInput.value = calculateDueDate(memberStartInput.value, memberPlanSelect.value);
  });
  memberPlanSelect.addEventListener('change', () => {
    memberDueInput.value = calculateDueDate(memberStartInput.value, memberPlanSelect.value);
  });
  
  existingStartDateInput.addEventListener('change', () => {
    calculatedDueDateInput.value = calculateDueDate(existingStartDateInput.value, existingMembershipTypeSelect.value);
  });
  existingMembershipTypeSelect.addEventListener('change', () => {
    calculatedDueDateInput.value = calculateDueDate(existingStartDateInput.value, existingMembershipTypeSelect.value);
  });
  
  addPaymentMemberSelect.addEventListener('change', () => {
    const member = allMembers.find(m => m.id === addPaymentMemberSelect.value);
    if (member) {
      addPaymentCurrentDueDateInput.value = ddmmyyyy(member.dueDate);
      addPaymentMembershipTypeSelect.value = member.membershipType || 'Monthly';
      addPaymentNewDueDateInput.value = ddmmyyyy(calculateDueDate(member.dueDate, addPaymentMembershipTypeSelect.value));
    } else {
      addPaymentCurrentDueDateInput.value = '';
      addPaymentNewDueDateInput.value = '';
    }
  });
  
  addPaymentMembershipTypeSelect.addEventListener('change', () => {
    const member = allMembers.find(m => m.id === addPaymentMemberSelect.value);
    if (member) {
      addPaymentNewDueDateInput.value = ddmmyyyy(calculateDueDate(member.dueDate, addPaymentMembershipTypeSelect.value));
    }
  });
  
  // Search filtering
  dashOverdueSearch.addEventListener('input', () => renderTables());
  currentSearch.addEventListener('input', () => renderTables());
  overdueSearch.addEventListener('input', () => renderTables());
  inactiveSearch.addEventListener('input', () => renderTables());
  paymentHistorySearch.addEventListener('input', () => renderPaymentHistory());
  
  // ID Card population
  idCardMemberSelect.addEventListener('change', () => {
    const member = allMembers.find(m => m.id === idCardMemberSelect.value);
    if (member) {
      idCardDisplay.classList.remove('hidden');
      noIdCardSelectedMessage.classList.add('hidden');
      idCardName.textContent = member.name || '';
      idCardMemberId.textContent = 'ID: ' + (member.memberId || '');
      idCardPhone.textContent = 'Phone: ' + (member.phoneNumber || '');
      idCardType.textContent = 'Plan: ' + (member.membershipType || '');
      idCardStart.textContent = 'Start: ' + ddmmyyyy(member.startDate);
      idCardDue.textContent = 'Due: ' + ddmmyyyy(member.dueDate);
      idCardFee.textContent = 'Fee: ' + (member.fee || ''); // Assuming fee field might exist
      
      const today = new Date();
      const dueDate = new Date(member.dueDate);
      if (dueDate < today) {
        const days = daysBetween(member.dueDate, today.toISOString().split('T')[0]);
        idCardStatus.textContent = `Status: Overdue by ${days} days`;
        idCardStatus.className = 'text-red-400 font-bold';
      } else {
        const days = daysBetween(today.toISOString().split('T')[0], member.dueDate);
        idCardStatus.textContent = `Status: Active (${days} days left)`;
        idCardStatus.className = 'text-emerald-400 font-bold';
      }
    } else {
      idCardDisplay.classList.add('hidden');
      noIdCardSelectedMessage.classList.remove('hidden');
    }
  });

  // Clock
  function updateTime() {
    const now = new Date();
    const time = now.toLocaleTimeString();
    const date = now.toLocaleDateString();
    const day = now.toLocaleDateString('en-US', { weekday: 'long' });
    document.getElementById('current-time').textContent = time;
    document.getElementById('current-date').textContent = date;
    document.getElementById('current-day').textContent = day;
  }
  setInterval(updateTime, 1000);
  updateTime();
</script>
</body>
</html>
        <div class="text-xs text-gray-400">Inactive 💤</div>
        <div id="count-inactive" class="text-2xl font-bold text-yellow-300">0</div>
      </div>
      <div class="p-4 rounded-xl border border-gray-700 bg-gray-800 text-center">
        <div class="text-xs text-gray-400">Paid</div>
        <div id="count-paid" class="text-2xl font-bold text-emerald-300">0</div>
      </div>
    </div>

    <!-- Expanded Overdue -->
    <div class="bg-gray-800 border border-red-800 rounded-xl">
      <div class="flex items-center justify-between p-4">
        <h3 class="text-lg font-bold text-red-400">Overdue Members</h3>
        <input id="dash-overdue-search" placeholder="Search overdue…" class="p-2 bg-gray-900 border border-gray-700 rounded w-60">
      </div>
      <div id="overdue-container" class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-red-900">
            <tr>
              <th class="px-4 py-2 text-left text-red-200">Photo</th>
              <th class="px-4 py-2 text-left text-red-200">Member ID</th>
              <th class="px-4 py-2 text-left text-red-200">Name</th>
              <th class="px-4 py-2 text-left text-red-200">Phone</th>
              <th class="px-4 py-2 text-left text-red-200">Type</th>
              <th class="px-4 py-2 text-left text-red-200">Start</th>
              <th class="px-4 py-2 text-left text-red-200">Due</th>
              <th class="px-4 py-2 text-left text-red-200">Days Overdue</th>
              <th class="px-4 py-2 text-left text-red-200">Actions</th>
            </tr>
          </thead>
          <tbody id="overdue-tbody" class="divide-y divide-gray-700"></tbody>
        </table>
        <p id="no-overdue" class="p-4 text-center text-gray-400 hidden">No overdue members. 🎉</p>
      </div>
    </div>
  </section>

  <!-- Current Members -->
  <section id="view-current" class="space-y-4 hidden">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-bold">Current Members</h3>
      <input id="current-search" placeholder="Search current…" class="p-2 bg-gray-900 border border-gray-700 rounded w-60">
    </div>
    <div class="overflow-x-auto rounded-xl border border-gray-700">
      <table class="min-w-full text-sm">
        <thead class="bg-indigo-900">
          <tr>
            <th class="px-4 py-2 text-left text-indigo-200">Photo</th>
            <th class="px-4 py-2 text-left text-indigo-200">Member ID</th>
            <th class="px-4 py-2 text-left text-indigo-200">Name</th>
            <th class="px-4 py-2 text-left text-indigo-200">Phone</th>
            <th class="px-4 py-2 text-left text-indigo-200">Type</th>
            <th class="px-4 py-2 text-left text-indigo-200">Start</th>
            <th class="px-4 py-2 text-left text-indigo-200">Due</th>
            <th class="px-4 py-2 text-left text-indigo-200">Days Left</th>
            <th class="px-4 py-2 text-left text-indigo-200">Actions</th>
          </tr>
        </thead>
        <tbody id="current-tbody" class="divide-y divide-gray-700"></tbody>
      </table>
      <p id="no-current" class="p-4 text-center text-gray-400 hidden">No current members.</p>
    </div>
  </section>

  <!-- Overdue (separate view) -->
  <section id="view-overdue" class="space-y-4 hidden">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-bold text-red-400">Overdue</h3>
      <input id="overdue-search" placeholder="Search overdue…" class="p-2 bg-gray-900 border border-gray-700 rounded w-60">
    </div>
    <div class="overflow-x-auto rounded-xl border border-red-800">
      <table class="min-w-full text-sm">
        <thead class="bg-red-900">
          <tr>
            <th class="px-4 py-2 text-left text-red-200">Photo</th>
            <th class="px-4 py-2 text-left text-red-200">Member ID</th>
            <th class="px-4 py-2 text-left text-red-200">Name</th>
            <th class="px-4 py-2 text-left text-red-200">Phone</th>
            <th class="px-4 py-2 text-left text-red-200">Type</th>
            <th class="px-4 py-2 text-left text-red-200">Start</th>
            <th class="px-4 py-2 text-left text-red-200">Due</th>
            <th class="px-4 py-2 text-left text-red-200">Days Overdue</th>
            <th class="px-4 py-2 text-left text-red-200">Actions</th>
          </tr>
        </thead>
        <tbody id="overdue2-tbody" class="divide-y divide-gray-700"></tbody>
      </table>
      <p id="no-overdue2" class="p-4 text-center text-gray-400 hidden">No overdue members.</p>
    </div>
  </section>

  <!-- Inactive -->
  <section id="view-inactive" class="space-y-4 hidden">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-bold text-yellow-300">Inactive Members 💤</h3>
      <input id="inactive-search" placeholder="Search inactive…" class="p-2 bg-gray-900 border border-gray-700 rounded w-60">
    </div>
    <div class="overflow-x-auto rounded-xl border border-yellow-700">
      <table class="min-w-full text-sm">
        <thead class="bg-yellow-900">
          <tr>
            <th class="px-4 py-2 text-left text-yellow-200">Photo</th>
            <th class="px-4 py-2 text-left text-yellow-200">Member ID</th>
            <th class="px-4 py-2 text-left text-yellow-200">Name</th>
            <th class="px-4 py-2 text-left text-yellow-200">Phone</th>
            <th class="px-4 py-2 text-left text-yellow-200">Last Type</th>
            <th class="px-4 py-2 text-left text-yellow-200">Start</th>
            <th class="px-4 py-2 text-left text-yellow-200">Due</th>
            <th class="px-4 py-2 text-left text-yellow-200">Status</th>
            <th class="px-4 py-2 text-left text-yellow-200">Actions</th>
          </tr>
        </thead>
        <tbody id="inactive-tbody" class="divide-y divide-gray-700"></tbody>
      </table>
      <p id="no-inactive" class="p-4 text-center text-gray-400 hidden">No inactive members.</p>
    </div>
  </section>

  <!-- Payment History -->
  <section id="view-payment-history" class="space-y-4 hidden">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-bold">Payment History</h3>
      <input id="payment-history-search" placeholder="Search payments…" class="p-2 bg-gray-900 border border-gray-700 rounded w-60">
    </div>
    <div class="overflow-x-auto rounded-xl border border-gray-700">
      <table class="min-w-full text-sm">
        <thead class="bg-indigo-900">
          <tr>
            <th class="px-4 py-2 text-left text-indigo-200">S.No.</th>
            <th class="px-4 py-2 text-left text-indigo-200">Member ID</th>
            <th class="px-4 py-2 text-left text-indigo-200">Name</th>
            <th class="px-4 py-2 text-left text-indigo-200">Membership Type</th>
            <th class="px-4 py-2 text-left text-indigo-200">Payment Date</th>
          </tr>
        </thead>
        <tbody id="payment-history-tbody" class="divide-y divide-gray-700"></tbody>
      </table>
      <p id="no-payment-history" class="p-4 text-center text-gray-400 hidden">No payment history found.</p>
    </div>
  </section>

  <!-- Manage Member (add/update) -->
  <section id="view-manage" class="hidden">
    <h3 class="text-lg font-bold mb-2">Manage Member Details</h3>
    <form id="member-form" class="grid sm:grid-cols-2 gap-4 bg-gray-800 border border-gray-700 p-4 rounded-xl">
      <input id="member-id" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="Member ID" required>
      <input id="member-name" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="Name" required>
      <input id="member-phone" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="Phone">
      <select id="member-plan" class="p-3 bg-gray-900 border border-gray-700 rounded">
        <option>Monthly</option><option>Quarterly</option><option>HalfYearly</option><option>Annual</option>
      </select>
      <input id="member-start" type="date" class="p-3 bg-gray-900 border border-gray-700 rounded" required>
      <input id="member-due" type="date" class="p-3 bg-gray-900 border border-gray-700 rounded" readonly>
      <div class="sm:col-span-2">
        <label for="member-photo" class="text-sm block mb-1">Upload Photo</label>
        <input id="member-photo" type="file" accept="image/*" class="w-full text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"/>
      </div>
      <div class="sm:col-span-2 flex gap-2">
        <button id="submit-member" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded">Save</button>
        <button id="cancel-edit" type="button" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded hidden">Cancel Edit</button>
      </div>
    </form>
  </section>

  <!-- Add Existing -->
  <section id="view-existing" class="hidden">
    <h3 class="text-lg font-bold mb-2">Add Existing Member</h3>
    <form id="existing-member-form" class="grid sm:grid-cols-2 gap-4 bg-gray-800 border border-gray-700 p-4 rounded-xl">
      <input id="existing-member-id" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="Member ID" required>
      <input id="existing-name" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="Name" required>
      <input id="existing-phone-number" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="Phone">
      <select id="existing-membershipType" class="p-3 bg-gray-900 border border-gray-700 rounded">
        <option>Monthly</option><option>Quarterly</option><option>HalfYearly</option><option>Annual</option>
      </select>
      <input id="existing-startDate" type="date" class="p-3 bg-gray-900 border border-gray-700 rounded" required>
      <input id="calculated-dueDate" type="date" class="p-3 bg-gray-900 border border-gray-700 rounded" readonly>
      <div class="sm:col-span-2">
        <label for="existing-photo" class="text-sm block mb-1">Upload Photo</label>
        <input id="existing-photo" type="file" accept="image/*" class="w-full text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"/>
      </div>
      <button class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded sm:col-span-2">Add</button>
    </form>
  </section>

  <!-- Add Payment -->
  <section id="view-payment" class="hidden">
    <h3 class="text-lg font-bold mb-2">Add Payment / Extend</h3>
    <form id="add-payment-form" class="grid sm:grid-cols-2 gap-4 bg-gray-800 border border-gray-700 p-4 rounded-xl">
      <input id="add-payment-member-search" class="p-3 bg-gray-900 border border-gray-700 rounded sm:col-span-2" placeholder="Search member…">
      <select id="add-payment-member-select" class="p-3 bg-gray-900 border border-gray-700 rounded sm:col-span-2"></select>
      <input id="add-payment-current-dueDate" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="Current Due" readonly>
      <select id="add-payment-membershipType" class="p-3 bg-gray-900 border border-gray-700 rounded">
        <option>Monthly</option><option>Quarterly</option><option>HalfYearly</option><option>Annual</option>
      </select>
      <input id="add-payment-new-dueDate" class="p-3 bg-gray-900 border border-gray-700 rounded" placeholder="New Due" readonly>
      <button class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded sm:col-span-2">Apply Payment</button>
    </form>
  </section>

  <!-- ID Card -->
  <section id="view-idcard" class="hidden">
    <h3 class="text-lg font-bold mb-2">ID Card</h3>
    <div class="grid sm:grid-cols-2 gap-4 bg-gray-800 border border-gray-700 p-4 rounded-xl">
      <input id="id-card-member-search" class="p-3 bg-gray-900 border border-gray-700 rounded sm:col-span-2" placeholder="Search member…">
      <select id="id-card-member-select" class="p-3 bg-gray-900 border border-gray-700 rounded sm:col-span-2"></select>
      <div id="id-card-display" class="sm:col-span-2 hidden">
        <div class="p-4 rounded-lg bg-gray-900 border border-gray-700">
          <div class="font-mono text-sm" id="id-card-member-id"></div>
          <div class="text-xl font-bold" id="id-card-name"></div>
          <div id="id-card-phone"></div>
          <div id="id-card-membership-type"></div>
          <div id="id-card-start-date"></div>
          <div id="id-card-due-date"></div>
          <div id="id-card-fee"></div>
          <div id="id-card-status"></div>
        </div>
      </div>
      <p id="no-id-card-selected-message" class="sm:col-span-2 text-gray-400">Choose a member to view the ID card.</p>
    </div>
  </section>

</main>

<!-- Reactivate Modal -->
<div id="reactivate-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
  <div class="bg-gray-800 border border-gray-700 p-6 rounded-xl w-full max-w-sm">
    <h3 class="text-lg font-semibold mb-3">Reactivate Member</h3>
    <p id="reactivate-who" class="text-sm text-gray-300 mb-3"></p>
    <label class="text-sm mb-1 block">Choose plan</label>
    <select id="reactivate-plan" class="w-full p-3 bg-gray-900 border border-gray-700 rounded mb-4">
      <option>Monthly</option><option>Quarterly</option><option>HalfYearly</option><option>Annual</option>
    </select>
    <div class="flex gap-2">
      <button id="reactivate-confirm" class="flex-1 px-3 py-2 bg-emerald-600 hover:bg-emerald-700 rounded">Reactivate</button>
      <button id="reactivate-cancel" class="flex-1 px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded">Cancel</button>
    </div>
  </div>
</div>

<!-- Custom Confirmation Modal for Deletion -->
<div id="confirm-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
  <div class="bg-gray-800 border border-gray-700 p-6 rounded-xl w-full max-w-sm">
    <h3 class="text-lg font-semibold mb-3">Confirm Deletion</h3>
    <p id="confirm-who" class="text-sm text-gray-300 mb-3">Are you sure you want to delete this member? This action cannot be undone.</p>
    <div class="flex gap-2">
      <button id="confirm-yes" class="flex-1 px-3 py-2 bg-red-600 hover:bg-red-700 rounded">Delete</button>
      <button id="confirm-no" class="flex-1 px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded">Cancel</button>
    </div>
  </div>
</div>

<!-- Notifications -->
<div id="message-display" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 border border-gray-700 px-4 py-2 rounded-lg hidden"></div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, getDocs, query, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  
  // =======================================================================
  // IMPORTANT: THIS IS YOUR FIREBASE CONFIGURATION
  // It has been populated with the values you provided.
  // DO NOT EDIT THIS UNLESS YOU WANT TO CHANGE THE LINKED PROJECT.
  // =======================================================================
  const firebaseConfig = {
    apiKey: "AIzaSyA1cOHWVufQV6ruZv3LmgdqfRNPGjyzsEI",
    authDomain: "alpha-core-fitness-data.firebaseapp.com",
    projectId: "alpha-core-fitness-data",
    storageBucket: "alpha-core-fitness-data.firebasestorage.app",
    messagingSenderId: "311733734225",
    appId: "1:311733734225:web:697ef2dc197ebb2e662170",
    measurementId: "G-C5EKPN2K2J" // This will be ignored as getAnalytics is not imported.
  };
  
  const appId = firebaseConfig.projectId;

  const firebaseApp = initializeApp(firebaseConfig);
  const db = getFirestore(firebaseApp);
  const auth = getAuth(firebaseApp);

  let userId;
  let allMembers = [];
  let currentMembers = [];
  let overdueMembers = [];
  let inactiveMembers = [];
  let allPayments = [];

  // DOM elements
  const splashScreen = document.getElementById('splash-screen');
  const topBar = document.getElementById('top-bar');
  const mainAppSection = document.getElementById('main-app-section');
  const hamburgerBtn = document.getElementById('hamburger-btn');
  const hamburgerDrawer = document.getElementById('hamburger-drawer');
  const drawerCloseBtn = document.getElementById('drawer-close');
  const drawerLinks = document.querySelectorAll('.drawer-link');
  const signoutButton = document.getElementById('signout-button');
  const appPasswordInput = document.getElementById('app-password-input');
  const submitAppPasswordButton = document.getElementById('submit-app-password');
  const passwordEntryModal = document.getElementById('password-entry-modal');
  const messageDisplay = document.getElementById('message-display');
  const memberForm = document.getElementById('member-form');
  const memberIdInput = document.getElementById('member-id');
  const memberNameInput = document.getElementById('member-name');
  const memberPhoneInput = document.getElementById('member-phone');
  const memberPlanSelect = document.getElementById('member-plan');
  const memberStartInput = document.getElementById('member-start');
  const memberDueInput = document.getElementById('member-due');
  const memberPhotoInput = document.getElementById('member-photo');
  const submitMemberButton = document.getElementById('submit-member');
  const cancelEditButton = document.getElementById('cancel-edit');
  const existingMemberForm = document.getElementById('existing-member-form');
  const existingMemberIdInput = document.getElementById('existing-member-id');
  const existingNameInput = document.getElementById('existing-name');
  const existingPhoneNumberInput = document.getElementById('existing-phone-number');
  const existingMembershipTypeSelect = document.getElementById('existing-membershipType');
  const existingStartDateInput = document.getElementById('existing-startDate');
  const existingPhotoInput = document.getElementById('existing-photo');
  const calculatedDueDateInput = document.getElementById('calculated-dueDate');
  const addPaymentForm = document.getElementById('add-payment-form');
  const addPaymentMemberSearchInput = document.getElementById('add-payment-member-search');
  const addPaymentMemberSelect = document.getElementById('add-payment-member-select');
  const addPaymentCurrentDueDateInput = document.getElementById('add-payment-current-dueDate');
  const addPaymentMembershipTypeSelect = document.getElementById('add-payment-membershipType');
  const addPaymentNewDueDateInput = document.getElementById('add-payment-new-dueDate');
  const idCardMemberSearch = document.getElementById('id-card-member-search');
  const idCardMemberSelect = document.getElementById('id-card-member-select');
  const idCardDisplay = document.getElementById('id-card-display');
  const idCardName = document.getElementById('id-card-name');
  const idCardMemberId = document.getElementById('id-card-member-id');
  const idCardPhone = document.getElementById('id-card-phone');
  const idCardType = document.getElementById('id-card-membership-type');
  const idCardStart = document.getElementById('id-card-start-date');
  const idCardDue = document.getElementById('id-card-due-date');
  const idCardFee = document.getElementById('id-card-fee');
  const idCardStatus = document.getElementById('id-card-status');
  const noIdCardSelectedMessage = document.getElementById('no-id-card-selected-message');
  const reactivateModal = document.getElementById('reactivate-modal');
  const reactivateWho = document.getElementById('reactivate-who');
  const reactivatePlan = document.getElementById('reactivate-plan');
  const reactivateConfirm = document.getElementById('reactivate-confirm');
  const reactivateCancel = document.getElementById('reactivate-cancel');
  const countCurrent = document.getElementById('count-current');
  const countOverdue = document.getElementById('count-overdue');
  const countInactive = document.getElementById('count-inactive');
  const countPaid = document.getElementById('count-paid');
  const dashOverdueSearch = document.getElementById('dash-overdue-search');
  const overdueTbody = document.getElementById('overdue-tbody');
  const noOverdue = document.getElementById('no-overdue');
  const currentSearch = document.getElementById('current-search');
  const currentTbody = document.getElementById('current-tbody');
  const noCurrent = document.getElementById('no-current');
  const overdueSearch = document.getElementById('overdue-search');
  const overdue2Tbody = document.getElementById('overdue2-tbody');
  const noOverdue2 = document.getElementById('no-overdue2');
  const inactiveSearch = document.getElementById('inactive-search');
  const inactiveTbody = document.getElementById('inactive-tbody');
  const noInactive = document.getElementById('no-inactive');
  const confirmModal = document.getElementById('confirm-modal');
  const confirmWho = document.getElementById('confirm-who');
  const confirmYes = document.getElementById('confirm-yes');
  const confirmNo = document.getElementById('confirm-no');
  const paymentHistorySearch = document.getElementById('payment-history-search');
  const paymentHistoryTbody = document.getElementById('payment-history-tbody');
  const noPaymentHistory = document.getElementById('no-payment-history');
  
  let currentEditMemberId = null;
  let memberToDeleteId = null;

  // CLOUDINARY CONFIGURATION
  const CLOUDINARY_CLOUD_NAME = 'dlt0f5v7c'; // Cloudinary cloud name
  const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
  
  // App password for authentication
  const APP_PASSWORD = '2003';

  // Splash screen timeout
  window.onload = () => {
    setTimeout(() => {
      splashScreen.classList.add('hidden');
      passwordEntryModal.classList.remove('hidden');
    }, 2500);
  };

  // Utility functions
  function showMessage(msg, type = 'info') {
    messageDisplay.textContent = msg;
    messageDisplay.className = `fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg z-50 animate-bounce`;
    if (type === 'error') {
      messageDisplay.classList.add('bg-red-800', 'border', 'border-red-700');
    } else {
      messageDisplay.classList.add('bg-gray-800', 'border', 'border-gray-700');
    }
    messageDisplay.classList.remove('hidden');
    setTimeout(() => {
      messageDisplay.classList.add('hidden');
    }, 3000);
  }

  function daysBetween(d1, d2) {
    const diff = new Date(d2).getTime() - new Date(d1).getTime();
    return Math.ceil(diff / (1000 * 60 * 60 * 24));
  }

  function ddmmyyyy(isoDate) {
    if (!isoDate) return '';
    const date = new Date(isoDate);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  }

  function calculateDueDate(startDate, plan) {
    if (!startDate) return null;
    const date = new Date(startDate);
    switch (plan) {
      case 'Monthly': date.setMonth(date.getMonth() + 1); break;
      case 'Quarterly': date.setMonth(date.getMonth() + 3); break;
      case 'HalfYearly': date.setMonth(date.getMonth() + 6); break;
      case 'Annual': date.setFullYear(date.getFullYear() + 1); break;
    }
    return date.toISOString().split('T')[0];
  }

  function updateMainView(viewId) {
    const sections = document.querySelectorAll('main section');
    sections.forEach(sec => sec.classList.add('hidden'));
    document.getElementById(`view-${viewId}`).classList.remove('hidden');
  }

  // Cloudinary image upload helper
  async function uploadImage(file) {
      if (!file) return null;
      showMessage('Uploading photo...', 'info');

      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', 'ml_default'); // Use the default unsigned upload preset

      try {
          const response = await fetch(CLOUDINARY_UPLOAD_URL, {
              method: 'POST',
              body: formData,
          });

          if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Cloudinary upload failed: ${response.status} ${response.statusText} - ${errorText}`);
          }

          const data = await response.json();
          showMessage('Photo uploaded!', 'info');
          return data.secure_url;
      } catch (error) {
          console.error('Error uploading to Cloudinary:', error);
          showMessage(`Photo upload failed: ${error.message}`, 'error');
          return null;
      }
  }

  // Firebase Authentication
  
  // This listener is for handling initial app load and signouts.
  // The initial login logic is now handled directly in the password submission.
  onAuthStateChanged(auth, (user) => {
    if (user) {
        // If a user is found (e.g., from a persisted session), show the main app
        passwordEntryModal.classList.add('hidden');
        mainAppSection.classList.remove('hidden');
        topBar.classList.remove('hidden');
        userId = user.uid;
        console.log("Authentication successful. User ID:", userId);
        setupFirestoreListeners(userId);
    } else {
        // If no user is signed in, show the password modal
        mainAppSection.classList.add('hidden');
        topBar.classList.add('hidden');
        console.log("User is not authenticated. Showing password screen.");
    }
  });

  submitAppPasswordButton.addEventListener('click', async () => {
    if (appPasswordInput.value === APP_PASSWORD) {
      showMessage('App password correct! Signing in...');
      try {
        await signInAnonymously(auth);
        // After successful sign-in, the onAuthStateChanged listener will fire and handle the UI change.
        // We can also directly handle the UI change here for a smoother user experience.
        passwordEntryModal.classList.add('hidden');
        mainAppSection.classList.remove('hidden');
        topBar.classList.remove('hidden');
        userId = auth.currentUser.uid;
        setupFirestoreListeners(userId);
      } catch (error) {
        console.error("Anonymous sign in failed: ", error);
        showMessage("Failed to sign in. Check your Firebase config.", 'error');
      }
    } else {
      showMessage('Incorrect app password.', 'error');
    }
  });

  signoutButton.addEventListener('click', async () => {
    await signOut(auth);
    showMessage('Signed out.');
    // The onAuthStateChanged listener will handle hiding the main app and showing the password modal.
  });

  // Firebase and Firestore Logic
  async function setupFirestoreListeners(uid) {
    const membersCollectionRef = collection(db, 'artifacts', appId, 'users', uid, 'members');
    const paymentsCollectionRef = collection(db, 'artifacts', appId, 'users', uid, 'payments');

    // Listen for real-time updates to members collection
    onSnapshot(membersCollectionRef, (snapshot) => {
      allMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      const today = new Date();
      
      currentMembers = allMembers.filter(m => {
        if (!m.status || m.status === 'Active') {
          return m.dueDate && new Date(m.dueDate) >= today;
        }
        return false;
      });
      
      overdueMembers = allMembers.filter(m => {
        return m.dueDate && new Date(m.dueDate) < today && new Date(m.dueDate) >= new Date(today.getTime() - (90 * 24 * 60 * 60 * 1000));
      });
      
      inactiveMembers = allMembers.filter(m => {
        return m.status === 'Inactive' || (m.dueDate && new Date(m.dueDate) < new Date(today.getTime() - (90 * 24 * 60 * 60 * 1000)));
      });
      
      countCurrent.textContent = currentMembers.length;
      countOverdue.textContent = overdueMembers.length;
      countInactive.textContent = inactiveMembers.length;
      countPaid.textContent = allMembers.length - overdueMembers.length - inactiveMembers.length;
      
      renderTables();
      populateSelects();
    }, (error) => {
      console.error("Error fetching data: ", error);
      showMessage("Failed to load data. Please check your connection.", "error");
    });
    
    // Listen for real-time updates to payments collection
    onSnapshot(paymentsCollectionRef, (snapshot) => {
      allPayments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderPaymentHistory();
    }, (error) => {
      console.error("Error fetching payments: ", error);
      showMessage("Failed to load payment history.", "error");
    });
  }

  async function addMember(memberData) {
    try {
      const membersCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'members');
      const docRef = await addDoc(membersCollectionRef, {
        ...memberData,
        createdAt: serverTimestamp(),
      });
      
      // Add initial payment record
      const paymentsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'payments');
      await addDoc(paymentsCollectionRef, {
          memberId: memberData.memberId,
          memberName: memberData.name,
          membershipType: memberData.membershipType,
          paymentDate: new Date(memberData.startDate),
          createdAt: serverTimestamp(),
      });

      showMessage('Member added successfully!');
    } catch (error) {
      console.error("Error adding document: ", error);
      showMessage('Failed to add member.', 'error');
    }
  }

  async function updateMember(docId, memberData) {
    try {
      const memberDocRef = doc(db, 'artifacts', appId, 'users', userId, 'members', docId);
      await updateDoc(memberDocRef, {
        ...memberData,
        updatedAt: serverTimestamp(),
      });
      showMessage('Member updated successfully!');
    } catch (error) {
      console.error("Error updating document: ", error);
      showMessage('Failed to update member.', 'error');
    }
  }

  async function deleteMember(docId) {
    try {
      const memberDocRef = doc(db, 'artifacts', appId, 'users', userId, 'members', docId);
      await deleteDoc(memberDocRef);
      showMessage('Member deleted successfully!');
    } catch (error) {
      console.error("Error deleting document: ", error);
      showMessage('Failed to delete member.', 'error');
    }
  }
  
  // DOM Rendering functions
  function renderMemberTable(tableBody, members, query, memberClass, daysCalc) {
    tableBody.innerHTML = '';
    const filteredMembers = members.filter(m => JSON.stringify(m).toLowerCase().includes(query.toLowerCase()));
    
    if (filteredMembers.length === 0) {
      const noDataElement = tableBody.nextElementSibling;
      if (noDataElement) noDataElement.classList.remove('hidden');
    } else {
      const noDataElement = tableBody.nextElementSibling;
      if (noDataElement) noDataElement.classList.add('hidden');
      
      filteredMembers.forEach(member => {
        const row = document.createElement('tr');
        row.classList.add(memberClass, 'border-b', 'border-gray-700');
        
        const photoUrl = member.photoURL || `https://placehold.co/50x50/1f2937/d1d5db?text=No+Photo`;
        const days = daysCalc(member);

        row.innerHTML = `
          <td class="px-4 py-2"><img src="${photoUrl}" alt="${member.name}" class="h-10 w-10 rounded-full object-cover"/></td>
          <td class="px-4 py-2 font-mono text-sm">${member.memberId || ''}</td>
          <td class="px-4 py-2">${member.name || ''}</td>
          <td class="px-4 py-2">${member.phoneNumber || ''}</td>
          <td class="px-4 py-2">${member.membershipType || ''}</td>
          <td class="px-4 py-2">${ddmmyyyy(member.startDate)}</td>
          <td class="px-4 py-2">${ddmmyyyy(member.dueDate)}</td>
          <td class="px-4 py-2 font-bold">${days}</td>
          <td class="px-4 py-2 space-x-2">
            <button data-action="edit" data-id="${member.id}" class="bg-indigo-600 hover:bg-indigo-700 text-white px-2 py-1 rounded">Edit</button>
            <button data-action="reactivate" data-id="${member.id}" class="bg-emerald-600 hover:bg-emerald-700 text-white px-2 py-1 rounded">Reactivate</button>
            <button data-action="delete" data-id="${member.id}" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded">Delete</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }
  }

  function renderPaymentHistory() {
    paymentHistoryTbody.innerHTML = '';
    const query = paymentHistorySearch.value.toLowerCase();
    
    const filteredPayments = allPayments.filter(p => 
      (p.memberName && p.memberName.toLowerCase().includes(query)) ||
      (p.memberId && p.memberId.toLowerCase().includes(query))
    ).sort((a,b) => b.createdAt.toDate() - a.createdAt.toDate());

    if (filteredPayments.length === 0) {
      noPaymentHistory.classList.remove('hidden');
    } else {
      noPaymentHistory.classList.add('hidden');
      filteredPayments.forEach((payment, index) => {
        const row = document.createElement('tr');
        row.classList.add('bg-gray-800', 'border-b', 'border-gray-700');
        row.innerHTML = `
          <td class="px-4 py-2">${index + 1}</td>
          <td class="px-4 py-2">${payment.memberId || ''}</td>
          <td class="px-4 py-2">${payment.memberName || ''}</td>
          <td class="px-4 py-2">${payment.membershipType || ''}</td>
          <td class="px-4 py-2">${payment.createdAt ? ddmmyyyy(payment.createdAt.toDate()) : 'N/A'}</td>
        `;
        paymentHistoryTbody.appendChild(row);
      });
    }
  }
  
  function renderTables() {
    renderMemberTable(overdueTbody, overdueMembers, dashOverdueSearch.value, 'row-overdue', m => daysBetween(m.dueDate, new Date().toISOString().split('T')[0]));
    renderMemberTable(currentTbody, currentMembers, currentSearch.value, 'row-normal', m => daysBetween(new Date().toISOString().split('T')[0], m.dueDate));
    renderMemberTable(overdue2Tbody, overdueMembers, overdueSearch.value, 'row-overdue', m => daysBetween(m.dueDate, new Date().toISOString().split('T')[0]));
    renderMemberTable(inactiveTbody, inactiveMembers, inactiveSearch.value, 'row-inactive', m => m.status || 'Inactive');
    renderPaymentHistory();
  }

  function populateSelects() {
    // Add Payment Select
    const paymentList = allMembers.filter(m => new Date(m.dueDate) >= new Date()).sort((a,b)=>a.name.localeCompare(b.name));
    addPaymentMemberSelect.innerHTML = '<option value="">Select member…</option>' + paymentList.map(m=>`<option value="${m.id}">${m.name} (${m.memberId})</option>`).join('');
    
    // ID Card Select
    const idCardList = allMembers.sort((a,b)=>a.name.localeCompare(b.name));
    idCardMemberSelect.innerHTML = '<option value="">Select member…</option>' + idCardList.map(m=>`<option value="${m.id}">${m.name} (${m.memberId})</option>`).join('');
  }
  
  // Event listeners
  hamburgerBtn.addEventListener('click', () => {
    hamburgerDrawer.classList.toggle('open');
    document.body.classList.toggle('drawer-open');
  });

  drawerCloseBtn.addEventListener('click', () => {
    hamburgerDrawer.classList.remove('open');
    document.body.classList.remove('drawer-open');
  });

  drawerLinks.forEach(link => {
    link.addEventListener('click', (e) => {
      const target = e.currentTarget.dataset.target;
      updateMainView(target);
      hamburgerDrawer.classList.remove('open');
      document.body.classList.remove('drawer-open');
    });
  });

  // Handle table actions (edit, reactivate, delete)
  document.addEventListener('click', async (e) => {
    if (e.target.dataset.action === 'edit') {
      const memberId = e.target.dataset.id;
      const member = allMembers.find(m => m.id === memberId);
      if (member) {
        currentEditMemberId = member.id;
        memberIdInput.value = member.memberId || '';
        memberNameInput.value = member.name || '';
        memberPhoneInput.value = member.phoneNumber || '';
        memberPlanSelect.value = member.membershipType || 'Monthly';
        memberStartInput.value = member.startDate;
        memberDueInput.value = member.dueDate;
        
        memberIdInput.readOnly = true;
        submitMemberButton.textContent = 'Update';
        cancelEditButton.classList.remove('hidden');
        updateMainView('manage');
      }
    } else if (e.target.dataset.action === 'reactivate') {
      const memberId = e.target.dataset.id;
      const member = allMembers.find(m => m.id === memberId);
      if (member) {
        reactivateModal.dataset.memberId = memberId;
        reactivateWho.textContent = `Reactivate ${member.name} (${member.memberId})`;
        reactivatePlan.value = member.membershipType || 'Monthly';
        reactivateModal.classList.remove('hidden');
      }
    } else if (e.target.dataset.action === 'delete') {
      const memberId = e.target.dataset.id;
      const member = allMembers.find(m => m.id === memberId);
      if (member) {
        memberToDeleteId = memberId;
        confirmWho.textContent = `Are you sure you want to delete ${member.name}? This action cannot be undone.`;
        confirmModal.classList.remove('hidden');
      }
    }
  });

  // Handle confirmation modal buttons
  confirmYes.addEventListener('click', async () => {
    if (memberToDeleteId) {
      await deleteMember(memberToDeleteId);
      memberToDeleteId = null;
    }
    confirmModal.classList.add('hidden');
  });

  confirmNo.addEventListener('click', () => {
    memberToDeleteId = null;
    confirmModal.classList.add('hidden');
  });


  // Form submission
  memberForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const photoFile = memberPhotoInput.files[0];
    const photoURL = await uploadImage(photoFile);

    const memberData = {
      memberId: memberIdInput.value,
      name: memberNameInput.value,
      phoneNumber: memberPhoneInput.value,
      membershipType: memberPlanSelect.value,
      startDate: memberStartInput.value,
      dueDate: memberDueInput.value,
      photoURL: photoURL
    };

    if (currentEditMemberId) {
      await updateMember(currentEditMemberId, memberData);
      currentEditMemberId = null;
      memberIdInput.readOnly = false;
      memberForm.reset();
      submitMemberButton.textContent = 'Update';
      cancelEditButton.classList.add('hidden');
    } else {
      await addMember(memberData);
      memberForm.reset();
    }
  });
  
  existingMemberForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const photoFile = existingPhotoInput.files[0];
    const photoURL = await uploadImage(photoFile);
    
    const memberData = {
      memberId: existingMemberIdInput.value,
      name: existingNameInput.value,
      phoneNumber: existingPhoneNumberInput.value,
      membershipType: existingMembershipTypeSelect.value,
      startDate: existingStartDateInput.value,
      dueDate: calculatedDueDateInput.value,
      photoURL: photoURL
    };
    
    await addMember(memberData);
    existingMemberForm.reset();
  });
  
  addPaymentForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const memberId = addPaymentMemberSelect.value;
    const membershipType = addPaymentMembershipTypeSelect.value;
    
    if (memberId) {
      const member = allMembers.find(m => m.id === memberId);
      const newDueDate = calculateDueDate(member.dueDate, membershipType);
      
      await updateMember(memberId, { dueDate: newDueDate, membershipType: membershipType, status: 'Active' });
      
      const paymentsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'payments');
      await addDoc(paymentsCollectionRef, {
        memberId: member.memberId,
        memberName: member.name,
        membershipType: membershipType,
        paymentDate: new Date(),
        createdAt: serverTimestamp(),
      });
      
      addPaymentForm.reset();
    }
  });

  reactivateConfirm.addEventListener('click', async () => {
    const memberId = reactivateModal.dataset.memberId;
    const member = allMembers.find(m => m.id === memberId);
    if (member) {
      const plan = reactivatePlan.value;
      const today = new Date().toISOString().split('T')[0];
      const newDueDate = calculateDueDate(today, plan);
      
      await updateMember(memberId, {
        membershipType: plan,
        startDate: today,
        dueDate: newDueDate,
        status: 'Active'
      });
      
      const paymentsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'payments');
      await addDoc(paymentsCollectionRef, {
        memberId: member.memberId,
        memberName: member.name,
        membershipType: plan,
        paymentDate: new Date(),
        createdAt: serverTimestamp(),
      });
      
      reactivateModal.classList.add('hidden');
    }
  });
  
  reactivateCancel.addEventListener('click', () => {
    reactivateModal.classList.add('hidden');
  });

  cancelEditButton.addEventListener('click', () => {
    currentEditMemberId = null;
    memberIdInput.readOnly = false;
    memberForm.reset();
    submitMemberButton.textContent = 'Save';
    cancelEditButton.classList.add('hidden');
  });

  // Auto-calculate due date
  memberStartInput.addEventListener('change', () => {
    memberDueInput.value = calculateDueDate(memberStartInput.value, memberPlanSelect.value);
  });
  memberPlanSelect.addEventListener('change', () => {
    memberDueInput.value = calculateDueDate(memberStartInput.value, memberPlanSelect.value);
  });
  
  existingStartDateInput.addEventListener('change', () => {
    calculatedDueDateInput.value = calculateDueDate(existingStartDateInput.value, existingMembershipTypeSelect.value);
  });
  existingMembershipTypeSelect.addEventListener('change', () => {
    calculatedDueDateInput.value = calculateDueDate(existingStartDateInput.value, existingMembershipTypeSelect.value);
  });
  
  addPaymentMemberSelect.addEventListener('change', () => {
    const member = allMembers.find(m => m.id === addPaymentMemberSelect.value);
    if (member) {
      addPaymentCurrentDueDateInput.value = ddmmyyyy(member.dueDate);
      addPaymentMembershipTypeSelect.value = member.membershipType || 'Monthly';
      addPaymentNewDueDateInput.value = ddmmyyyy(calculateDueDate(member.dueDate, addPaymentMembershipTypeSelect.value));
    } else {
      addPaymentCurrentDueDateInput.value = '';
      addPaymentNewDueDateInput.value = '';
    }
  });
  
  addPaymentMembershipTypeSelect.addEventListener('change', () => {
    const member = allMembers.find(m => m.id === addPaymentMemberSelect.value);
    if (member) {
      addPaymentNewDueDateInput.value = ddmmyyyy(calculateDueDate(member.dueDate, addPaymentMembershipTypeSelect.value));
    }
  });
  
  // Search filtering
  dashOverdueSearch.addEventListener('input', () => renderTables());
  currentSearch.addEventListener('input', () => renderTables());
  overdueSearch.addEventListener('input', () => renderTables());
  inactiveSearch.addEventListener('input', () => renderTables());
  paymentHistorySearch.addEventListener('input', () => renderPaymentHistory());
  
  // ID Card population
  idCardMemberSelect.addEventListener('change', () => {
    const member = allMembers.find(m => m.id === idCardMemberSelect.value);
    if (member) {
      idCardDisplay.classList.remove('hidden');
      noIdCardSelectedMessage.classList.add('hidden');
      idCardName.textContent = member.name || '';
      idCardMemberId.textContent = 'ID: ' + (member.memberId || '');
      idCardPhone.textContent = 'Phone: ' + (member.phoneNumber || '');
      idCardType.textContent = 'Plan: ' + (member.membershipType || '');
      idCardStart.textContent = 'Start: ' + ddmmyyyy(member.startDate);
      idCardDue.textContent = 'Due: ' + ddmmyyyy(member.dueDate);
      idCardFee.textContent = 'Fee: ' + (member.fee || ''); // Assuming fee field might exist
      
      const today = new Date();
      const dueDate = new Date(member.dueDate);
      if (dueDate < today) {
        const days = daysBetween(member.dueDate, today.toISOString().split('T')[0]);
        idCardStatus.textContent = `Status: Overdue by ${days} days`;
        idCardStatus.className = 'text-red-400 font-bold';
      } else {
        const days = daysBetween(today.toISOString().split('T')[0], member.dueDate);
        idCardStatus.textContent = `Status: Active (${days} days left)`;
        idCardStatus.className = 'text-emerald-400 font-bold';
      }
    } else {
      idCardDisplay.classList.add('hidden');
      noIdCardSelectedMessage.classList.remove('hidden');
    }
  });

  // Clock
  function updateTime() {
    const now = new Date();
    const time = now.toLocaleTimeString();
    const date = now.toLocaleDateString();
    const day = now.toLocaleDateString('en-US', { weekday: 'long' });
    document.getElementById('current-time').textContent = time;
    document.getElementById('current-date').textContent = date;
    document.getElementById('current-day').textContent = day;
  }
  setInterval(updateTime, 1000);
  updateTime();
</script>
</body>
</html>
